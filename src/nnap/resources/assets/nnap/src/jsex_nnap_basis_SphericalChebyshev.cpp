#include "jsex_nnap_basis_SphericalChebyshev.h"
#include "nnap_util.hpp"


static constexpr jint SH_LARGEST_L = 20;

static constexpr jint L3NCOLS[5] = {0, 0, 2, 4, 9};
static constexpr jint L3NCOLS_NOCROSS[5] = {0, 0, 1, 1, 2};

static constexpr jint L3_SIZE_222 = 8;
static constexpr jint L3_INDEX_222[L3_SIZE_222][3] = {
    {0, 2, 2}, {-2, -2, 0}, {1, 1, 2}, {-1, -1, 2}, {-1, -2, 1}, {0, 1, 1}, {-1, -1, 0}, {0, 0, 0}
};
static constexpr jdouble L3_COEFF_222[L3_SIZE_222] = {
    0.7171371656006361, 0.7171371656006361, -0.6210590034081187, 0.6210590034081187, -1.2421180068162376, -0.35856858280031806, -0.35856858280031806, -0.23904572186687872
};

static constexpr jint L3_SIZE_112 = 8;
static constexpr jint L3_INDEX_112[L3_SIZE_112][3] = {
    {1, 1, 2}, {-1, 1, -2}, {-1, -1, 2}, {0, 1, 1}, {-1, 0, -1}, {1, 1, 0}, {-1, -1, 0}, {0, 0, 0}
};
static constexpr jdouble L3_COEFF_112[L3_SIZE_112] = {
    0.3162277660168378, 0.6324555320336755, -0.3162277660168378, 0.6324555320336757, 0.6324555320336757, -0.18257418583505533, -0.18257418583505533, 0.3651483716701107
};

static constexpr jint L3_SIZE_233 = 24;
static constexpr jint L3_INDEX_233[L3_SIZE_233][3] = {
    {2, 1, 3}, {2, -1, -3}, {-2, -3, 1}, {-2, -1, 3}, {2, 0, 2}, {-2, -2, 0}, {2, 1, 1}, {2, -1, -1},
    {-2, -1, 1}, {1, 2, 3}, {1, -2, -3}, {-1, -3, 2}, {-1, -2, 3}, {1, 1, 2}, {1, -1, -2}, {-1, -2, 1},
    {-1, -1, 2}, {1, 0, 1}, {-1, -1, 0}, {0, 3, 3}, {0, -3, -3}, {0, 1, 1}, {0, -1, -1}, {0, 0, 0}
};
static constexpr jdouble L3_COEFF_233[L3_SIZE_233] = {
    -0.21821789023599228, -0.21821789023599228, -0.21821789023599228, 0.21821789023599228, -0.4364357804719847, -0.4364357804719847, 0.16903085094570328, -0.16903085094570328,
    0.33806170189140655, 0.345032779671177, 0.345032779671177, 0.345032779671177, -0.345032779671177, 0.2672612419124243, 0.2672612419124243, 0.2672612419124243,
    -0.2672612419124243, 0.13801311186847082, 0.13801311186847082, -0.24397501823713325, -0.24397501823713325, 0.14638501094227993, 0.14638501094227993, 0.19518001458970663
};

static constexpr jint L3_SIZE_123 = 21;
static constexpr jint L3_INDEX_123[L3_SIZE_123][3] = {
    {1, 2, 3}, {1, -2, -3}, {-1, 2, -3}, {-1, -2, 3}, {1, 1, 2}, {1, -1, -2}, {-1, 1, -2}, {-1, -1, 2},
    {1, 0, 1}, {-1, 0, -1}, {1, 1, 0}, {-1, -1, 0}, {1, 2, 1}, {1, -2, -1}, {-1, 2, -1}, {-1, -2, 1},
    {0, 2, 2}, {0, -2, -2}, {0, 1, 1}, {0, -1, -1}, {0, 0, 0}
};
static constexpr jdouble L3_COEFF_123[L3_SIZE_123] = {
    -0.2672612419124243, -0.2672612419124243, -0.2672612419124243, 0.2672612419124243, -0.21821789023599233, -0.21821789023599233, -0.21821789023599233, 0.21821789023599233,
    -0.2390457218668787, -0.2390457218668787, 0.16903085094570328, 0.16903085094570328, 0.0690065559342354, 0.0690065559342354, -0.0690065559342354, 0.0690065559342354,
    -0.21821789023599236, -0.21821789023599236, -0.27602622373694163, -0.27602622373694163, -0.29277002188455997
};

static constexpr jint L3_SIZE_444 = 23;
static constexpr jint L3_INDEX_444[L3_SIZE_444][3] = {
    {0, 4, 4}, {-4, -4, 0}, {1, 3, 4}, {-1, -3, 4}, {-3, -4, 1}, {-1, -4, 3}, {2, 2, 4}, {-2, -2, 4},
    {-2, -4, 2}, {0, 3, 3}, {-3, -3, 0}, {1, 2, 3}, {-1, -2, 3}, {-2, -3, 1}, {-1, -3, 2}, {0, 2, 2},
    {-2, -2, 0}, {1, 1, 2}, {-1, -1, 2}, {-1, -2, 1}, {0, 1, 1}, {-1, -1, 0}, {0, 0, 0}
};
static constexpr jdouble L3_COEFF_444[L3_SIZE_444] = {
    0.3128931093873718, 0.3128931093873718, -0.699650262281441, 0.699650262281441, -0.699650262281441, -0.699650262281441, 0.3966644140109587, -0.3966644140109587,
    0.7933288280219174, -0.4693396640810578, -0.4693396640810578, 0.2644429426739724, -0.2644429426739724, 0.2644429426739724, 0.2644429426739724, -0.24584458594722075,
    -0.24584458594722075, 0.29985011240633186, -0.29985011240633186, 0.5997002248126637, 0.20114557032045333, 0.20114557032045333, 0.13409704688030227
};

static constexpr jint L3_SIZE_224 = 23;
static constexpr jint L3_INDEX_224[L3_SIZE_224][3] = {
    {2, 2, 4}, {-2, 2, -4}, {-2, -2, 4}, {1, 2, 3}, {-1, 2, -3}, {-2, 1, -3}, {-1, -2, 3}, {0, 2, 2},
    {-2, 0, -2}, {1, 2, 1}, {-1, 2, -1}, {-2, 1, -1}, {-1, -2, 1}, {2, 2, 0}, {-2, -2, 0}, {1, 1, 2},
    {-1, 1, -2}, {-1, -1, 2}, {0, 1, 1}, {-1, 0, -1}, {1, 1, 0}, {-1, -1, 0}, {0, 0, 0}
};
static constexpr jdouble L3_COEFF_224[L3_SIZE_224] = {
    0.23570226039551576, 0.4714045207910315, -0.23570226039551576, 0.33333333333333326, 0.33333333333333326, 0.33333333333333326, -0.33333333333333326, 0.3086066999241837,
    0.3086066999241837, -0.1259881576697424, 0.1259881576697424, -0.1259881576697424, -0.1259881576697424, 0.03984095364447978, 0.03984095364447978, 0.17817416127494956,
    0.3563483225498991, -0.17817416127494956, 0.43643578047198467, 0.43643578047198467, -0.15936381457791912, -0.15936381457791912, 0.23904572186687872
};

static constexpr jint L3_SIZE_334 = 39;
static constexpr jint L3_INDEX_334[L3_SIZE_334][3] = {
    {1, 3, 4}, {-1, 3, -4}, {-3, 1, -4}, {-1, -3, 4}, {0, 3, 3}, {-3, 0, -3}, {1, 3, 2}, {-1, 3, -2},
    {-3, 1, -2}, {-1, -3, 2}, {2, 3, 1}, {-2, 3, -1}, {-3, 2, -1}, {-2, -3, 1}, {3, 3, 0}, {-3, -3, 0},
    {2, 2, 4}, {-2, 2, -4}, {-2, -2, 4}, {1, 2, 3}, {-1, 2, -3}, {-2, 1, -3}, {-1, -2, 3}, {0, 2, 2},
    {-2, 0, -2}, {1, 2, 1}, {-1, 2, -1}, {-2, 1, -1}, {-1, -2, 1}, {2, 2, 0}, {-2, -2, 0}, {1, 1, 2},
    {-1, 1, -2}, {-1, -1, 2}, {0, 1, 1}, {-1, 0, -1}, {1, 1, 0}, {-1, -1, 0}, {0, 0, 0}
};
static constexpr jdouble L3_COEFF_334[L3_SIZE_334] = {
    0.2461829819586654, 0.2461829819586654, 0.2461829819586654, -0.2461829819586654, 0.42640143271122083, 0.42640143271122083, -0.2791452631195412, 0.2791452631195412,
    -0.2791452631195412, -0.2791452631195412, 0.2080625946441197, -0.2080625946441197, 0.2080625946441197, 0.2080625946441197, -0.08058229640253801, -0.08058229640253801,
    -0.15891043154093204, -0.3178208630818641, 0.15891043154093204, -0.14213381090374025, -0.14213381090374025, -0.14213381090374025, 0.14213381090374025, 0.09304842103984708,
    0.09304842103984708, -0.21488612374010135, 0.21488612374010135, -0.21488612374010135, -0.21488612374010135, 0.1880253582725887, 0.1880253582725887, -0.1201249950260745,
    -0.240249990052149, 0.1201249950260745, -0.2080625946441197, -0.2080625946441197, -0.026860765467512683, -0.026860765467512683, -0.16116459280507608
};

static constexpr jint L3_SIZE_244 = 36;
static constexpr jint L3_INDEX_244[L3_SIZE_244][3] = {
    {2, 2, 4}, {2, -2, -4}, {-2, -4, 2}, {-2, -2, 4}, {2, 1, 3}, {2, -1, -3}, {-2, -3, 1}, {-2, -1, 3},
    {2, 0, 2}, {-2, -2, 0}, {2, 1, 1}, {2, -1, -1}, {-2, -1, 1}, {1, 3, 4}, {1, -3, -4}, {-1, -4, 3},
    {-1, -3, 4}, {1, 2, 3}, {1, -2, -3}, {-1, -3, 2}, {-1, -2, 3}, {1, 1, 2}, {1, -1, -2}, {-1, -2, 1},
    {-1, -1, 2}, {1, 0, 1}, {-1, -1, 0}, {0, 4, 4}, {0, -4, -4}, {0, 3, 3}, {0, -3, -3}, {0, 2, 2},
    {0, -2, -2}, {0, 1, 1}, {0, -1, -1}, {0, 0, 0}
};
static constexpr jdouble L3_COEFF_244[L3_SIZE_244] = {
    0.15569978883230456, 0.15569978883230456, 0.15569978883230456, -0.15569978883230456, 0.23354968324845682, 0.23354968324845682, 0.23354968324845682, -0.23354968324845682,
    0.3947710169758613, 0.3947710169758613, -0.14712247158412486, 0.14712247158412486, -0.29424494316824973, -0.2912876325017676, -0.2912876325017676, -0.2912876325017676,
    0.2912876325017676, -0.2752409412815901, -0.2752409412815901, -0.2752409412815901, 0.2752409412815901, -0.18725633517970772, -0.18725633517970772, -0.18725633517970772,
    0.18725633517970772, -0.09304842103984708, -0.09304842103984708, 0.23783535600422526, 0.23783535600422526, 0.0594588390010563, 0.0594588390010563, -0.06795295885835007,
    -0.06795295885835007, -0.1444000375739939, -0.1444000375739939, -0.1698823971458752
};

static constexpr jint L3_SIZE_134 = 31;
static constexpr jint L3_INDEX_134[L3_SIZE_134][3] = {
    {1, 3, 4}, {1, -3, -4}, {-1, 3, -4}, {-1, -3, 4}, {1, 2, 3}, {1, -2, -3}, {-1, 2, -3}, {-1, -2, 3},
    {1, 1, 2}, {1, -1, -2}, {-1, 1, -2}, {-1, -1, 2}, {1, 0, 1}, {-1, 0, -1}, {1, 1, 0}, {-1, -1, 0},
    {1, 2, 1}, {1, -2, -1}, {-1, 2, -1}, {-1, -2, 1}, {1, 3, 2}, {1, -3, -2}, {-1, 3, -2}, {-1, -3, 2},
    {0, 3, 3}, {0, -3, -3}, {0, 2, 2}, {0, -2, -2}, {0, 1, 1}, {0, -1, -1}, {0, 0, 0}
};
static constexpr jdouble L3_COEFF_134[L3_SIZE_134] = {
    0.2357022603955158, 0.2357022603955158, 0.2357022603955158, -0.2357022603955158, 0.20412414523193148, 0.20412414523193148, 0.20412414523193148, -0.20412414523193148,
    0.1725163898355885, 0.1725163898355885, 0.1725163898355885, -0.1725163898355885, 0.19920476822239894, 0.19920476822239894, -0.15430334996209188, -0.15430334996209188,
    -0.07715167498104594, -0.07715167498104594, 0.07715167498104594, -0.07715167498104594, -0.04454354031873739, -0.04454354031873739, 0.04454354031873739, -0.04454354031873739,
    0.16666666666666666, 0.16666666666666666, 0.21821789023599236, 0.21821789023599236, 0.24397501823713325, 0.24397501823713325, 0.25197631533948484
};

static constexpr jdouble SH_Alm[(SH_LARGEST_L+2)*(SH_LARGEST_L+1)/2] = {
    0.0,
    0.0, 0.0,
    1.9364916731037085, 0.0, 0.0,
    1.9720265943665387, 2.091650066335189, 0.0, 0.0,
    1.984313483298443, 2.04939015319192, 2.29128784747792, 0.0, 0.0,
    1.98997487421324, 2.03100960115899, 2.1712405933672376, 2.48746859276655, 0.0, 0.0,
    1.9930434571835665, 2.0213149892370277, 2.1139418156609704, 2.301368353023109, 2.6739483914241875, 0.0, 0.0,
    1.9948914348241344, 2.0155644370746373, 2.0816659994661326, 2.207940216581962, 2.4308621740219887, 2.850438562747845, 0.0, 0.0,
    1.996089927833914, 2.011869540407391, 2.0615528128088303, 2.15322168769582, 2.3048861143232218, 2.557041559783794, 3.017804310611087, 0.0, 0.0,
    1.9969111950679366, 2.0093531297410117, 2.048122358357819, 2.1180441711898057, 2.229177150706235, 2.401636346922061, 2.679137506321349, 3.1770662567847086, 0.0, 0.0,
    1.997498435543818, 2.0075614636426526, 2.038688303787511, 2.0939473213563384, 2.179449471770337, 2.3065125189341593, 2.496873044429772, 2.7970572771691153, 3.3291640592396967, 0.0, 0.0,
    1.9979328159850827, 2.006240264773888, 2.031798495964875, 2.0766559657295187, 2.1447610589527217, 2.2430448056157952, 2.3837686425440854, 2.5900450446533423, 2.910959328215754, 3.4749100707788108, 0.0, 0.0,
    1.998263134713633, 2.0052378963551982, 2.026608708444444, 2.0637972912229676, 2.1194781197266463, 2.1981657747106436, 2.307395517477243, 2.460209661583209, 2.680951323690902, 3.021089890583219, 3.614994027406106, 0.0, 0.0,
    1.998520162579474, 2.004459314343183, 2.0225995873897262, 2.053959590644373, 2.100420126042015, 2.165063509461097, 2.252817784447915, 2.3717082451262845, 2.53546276418555, 2.7695585470349866, 3.1277162108561214, 3.75, 0.0, 0.0,
    1.9987240828047461, 2.0038424627162224, 2.019436802675439, 2.0462565272714635, 2.085665361461421, 2.1398475105532757, 2.212182180562894, 2.307927774486216, 2.435532422657966, 2.6093477445855915, 2.8559149146989657, 3.2310988842807022, 3.880424243261593, 0.0, 0.0,
    1.9988885800753267, 2.003345416333104, 2.0168969490698876, 2.040107114108727, 2.0739902137422357, 2.120141504711419, 2.1809662438042814, 2.260078437898682, 2.363017336304797, 2.4986107250941583, 2.6817904466978773, 2.9401072717216916, 3.331480966792211, 4.006690832666208, 0.0, 0.0,
    1.9990231989649345, 2.002939017015334, 2.014825999813336, 2.035116803738375, 2.064582282206258, 2.104417123236605, 2.1563858652847827, 2.2230674720995864, 2.3082731640774234, 2.4177911997760035, 2.5607991541103545, 2.7527763762750106, 3.0222389997200043, 3.4290845264669656, 4.129164564412516, 0.0, 0.0,
    1.999134760937227, 2.002602473449653, 2.013114894621608, 2.03100960115899, 2.0568833780186058, 2.091650066335189, 2.1366369348357592, 2.1937410968480306, 2.265686062395524, 2.356455943866682, 2.4720661623652207, 2.622022120425379, 2.822324793743504, 3.1024184114977142, 3.5241105031922135, 4.248161366991607, 0.0, 0.0,
    1.9992282461607314, 2.0023206350873464, 2.011684617428885, 2.0275875100994063, 2.050498830661811, 2.081130384894172, 2.120501774999912, 2.170043987823959, 2.231763704062155, 2.3085099321848035, 2.404423007708918, 2.5257296658248256, 2.6822461565718467, 2.8904737863674566, 3.1807526624998683, 3.616739979706598, 4.363956650455962, 0.0, 0.0,
    1.9993073592865873, 2.0020822493927, 2.0104767610501466, 2.024705365770985, 2.045142707894042, 2.0723520109148583, 2.1071307505705477, 2.1505813167606567, 2.2042200113840402, 2.27014788693852, 2.351326355949745, 2.452039967047846, 2.5787147157554005, 2.7414640249326636, 2.957271469692045, 3.2573446421352252, 3.7071359757712075, 4.476792006187765, 0.0, 0.0,
    1.9993749023132206, 2.0018788167600157, 2.0094473837049796, 2.0222546987202583, 2.0406034646643136, 2.064945519862449, 2.0959143930173156, 2.1343747458109497, 2.181496864867922, 2.2388700687965297, 2.3086792761230392, 2.393988887964797, 2.499218627891526, 2.630984211674012, 2.7996848562146504, 3.0227707252027662, 3.3322915038553673, 3.7954453500749294, 4.586880604965702, 0.0, 0.0
};
static constexpr jdouble SH_Blm[(SH_LARGEST_L+2)*(SH_LARGEST_L+1)/2] = {
    0.0,
    0.0, 0.0,
    -0.5773502691896257, 0.0, 0.0,
    -0.5163977794943222, -0.4472135954999579, 0.0, 0.0,
    -0.50709255283711, -0.47809144373375745, -0.3779644730092272, 0.0, 0.0,
    -0.5039526306789697, -0.4879500364742666, -0.4364357804719847, -0.3333333333333333, 0.0, 0.0,
    -0.502518907629606, -0.49236596391733095, -0.4605661864718383, -0.40201512610368484, -0.30151134457776363, 0.0, 0.0,
    -0.5017452060042545, -0.4947274449181537, -0.47304991679126607, -0.4345240946267408, -0.3739787960033829, -0.2773500981126146, 0.0, 0.0,
    -0.501280411827603, -0.4961389383568338, -0.4803844614152614, -0.4529108136578383, -0.41137667560372115, -0.35082320772281167, -0.2581988897471611, 0.0, 0.0,
    -0.5009794328681196, -0.4970501217477084, -0.48507125007266594, -0.464420364012824, -0.4338609156373123, -0.39107694443752145, -0.3313667478318056, -0.24253562503633297, 0.0, 0.0,
    -0.5007733956671915, -0.4976726017934395, -0.4882520792370033, -0.47213368521878024, -0.44859602103995444, -0.4163827722217815, -0.3732544513450796, -0.3147557901458535, -0.22941573387056177, 0.0, 0.0,
    -0.5006261743217588, -0.4981167541368988, -0.49051147158797265, -0.4775669329409193, -0.45883146774112354, -0.43355498476206, -0.4005009394574071, -0.3575185993374057, -0.3003757045930553, -0.21821789023599236, 0.0, 0.0,
    -0.5005173307126191, -0.49844478627922684, -0.4921747909480132, -0.4815434123430768, -0.4662524041201569, -0.44582257006028225, -0.4195037983773235, -0.38609367125267213, -0.34352936171490267, -0.2877772315344771, -0.20851441405707477, 0.0, 0.0,
    -0.5004345937369794, -0.4986939463979015, -0.49343516379516894, -0.48454371185234896, -0.4718142596956708, -0.4549247429401158, -0.4333890711087691, -0.4064694223485302, -0.3730019232961255, -0.33100637062042226, -0.27662562992324985, -0.2, 0.0, 0.0,
    -0.5003702332976756, -0.49888765156985887, -0.4944132324730442, -0.48686449556014766, -0.4760952285695233, -0.46188021535170065, -0.44388854123195953, -0.4216370213557839, -0.39440531887330776, -0.361068373539376, -0.3197221015541813, -0.26666666666666666, -0.19245008972987526, 0.0, 0.0,
    -0.5003191829243042, -0.49904122634695197, -0.4951875684721383, -0.4886972804594683, -0.47946330148538413, -0.46732301954611777, -0.4520423357472069, -0.433289122413121, -0.4105878413676265, -0.38323753592253257, -0.3501504876259268, -0.30949223029508643, -0.25770378116168946, -0.18569533817705186, 0.0, 0.0,
    -0.5002780094738025, -0.4991650425568579, -0.4958111521072805, -0.49017034109842594, -0.4821623522493073, -0.4716666306365782, -0.458512369387107, -0.4424625195441246, -0.42318775433267225, -0.40022240757904204, -0.3728852122772354, -0.34012364433710335, -0.3001668056842815, -0.24958252127842895, -0.1796053020267749, 0.0, 0.0,
    -0.5002443195845779, -0.4992663238894528, -0.49632077414756665, -0.4913722879016409, -0.4843594796964828, -0.47519096331149147, -0.4637388957601683, -0.44982890197909525, -0.43322428885910585, -0.41360064512297223, -0.39050309681448225, -0.36326960977236206, -0.33088051609837776, -0.2916230242449912, -0.2421797398482414, -0.17407765595569785, 0.0, 0.0,
    -0.5002164033860247, -0.4993502271458874, -0.496742636335202, -0.49236596391733095, -0.4861724348043977, -0.47809144373375745, -0.4680252333449758, -0.4558423058385518, -0.4413674147523748, -0.4243660920556449, -0.40451991747794525, -0.3813850356982369, -0.3543178312491844, -0.3223291856101521, -0.28375954701028216, -0.23539595453459988, -0.1690308509457033, 0.0, 0.0,
    -0.5001930129390556, -0.4994205136163806, -0.49709581280096005, -0.4931969619160719, -0.4876862083736199, -0.48050809658946525, -0.4715864951351156, -0.4608201518545086, -0.44807611046807744, -0.4331798560007005, -0.41590019592802907, -0.3959251908590268, -0.37282185960072, -0.3459640439281511, -0.3143909967567437, -0.2764920911127051, -0.2291498472826297, -0.1643989873053573, 0.0, 0.0,
    -0.5001732201680236, -0.49947997905846986, -0.49739445855502595, -0.493899022003733, -0.48896343328028025, -0.4825435035810065, -0.4745789978762495, -0.46499055497527714, -0.4536752206382952, -0.44049993648148694, -0.4252918772715756, -0.40782369514309286, -0.38779008546009835, -0.3647686020700426, -0.3381495443514812, -0.3069985248304855, -0.26975001902701096, -0.22337423731498202, -0.16012815380508713, 0.0, 0.0
};
static constexpr jdouble SQRT_LPM_LMM1[(SH_LARGEST_L+1)*(SH_LARGEST_L+1)] = {
    0.0,
    0.0, 1.4142135623730951, 1.4142135623730951,
    0.0, 2.0, 2.449489742783178, 2.449489742783178, 2.0,
    0.0, 2.449489742783178, 3.1622776601683795, 3.4641016151377544, 3.4641016151377544, 3.1622776601683795, 2.449489742783178,
    0.0, 2.8284271247461903, 3.7416573867739413, 4.242640687119285, 4.47213595499958, 4.47213595499958, 4.242640687119285, 3.7416573867739413, 2.8284271247461903,
    0.0, 3.1622776601683795, 4.242640687119285, 4.898979485566356, 5.291502622129181, 5.477225575051661, 5.477225575051661, 5.291502622129181, 4.898979485566356, 4.242640687119285, 3.1622776601683795,
    0.0, 3.4641016151377544, 4.69041575982343, 5.477225575051661, 6.0, 6.324555320336759, 6.48074069840786, 6.48074069840786, 6.324555320336759, 6.0, 5.477225575051661, 4.69041575982343, 3.4641016151377544,
    0.0, 3.7416573867739413, 5.0990195135927845, 6.0, 6.6332495807108, 7.0710678118654755, 7.3484692283495345, 7.483314773547883, 7.483314773547883, 7.3484692283495345, 7.0710678118654755, 6.6332495807108, 6.0, 5.0990195135927845, 3.7416573867739413,
    0.0, 4.0, 5.477225575051661, 6.48074069840786, 7.211102550927978, 7.745966692414834, 8.12403840463596, 8.366600265340756, 8.48528137423857, 8.48528137423857, 8.366600265340756, 8.12403840463596, 7.745966692414834, 7.211102550927978, 6.48074069840786, 5.477225575051661, 4.0,
    0.0, 4.242640687119285, 5.830951894845301, 6.928203230275509, 7.745966692414834, 8.366600265340756, 8.831760866327848, 9.16515138991168, 9.38083151964686, 9.486832980505138, 9.486832980505138, 9.38083151964686, 9.16515138991168, 8.831760866327848, 8.366600265340756, 7.745966692414834, 6.928203230275509, 5.830951894845301, 4.242640687119285,
    0.0, 4.47213595499958, 6.164414002968976, 7.3484692283495345, 8.246211251235321, 8.94427190999916, 9.486832980505138, 9.899494936611665, 10.198039027185569, 10.392304845413264, 10.488088481701515, 10.488088481701515, 10.392304845413264, 10.198039027185569, 9.899494936611665, 9.486832980505138, 8.94427190999916, 8.246211251235321, 7.3484692283495345, 6.164414002968976, 4.47213595499958,
    0.0, 4.69041575982343, 6.48074069840786, 7.745966692414834, 8.717797887081348, 9.486832980505138, 10.099504938362077, 10.583005244258363, 10.954451150103322, 11.224972160321824, 11.40175425099138, 11.489125293076057, 11.489125293076057, 11.40175425099138, 11.224972160321824, 10.954451150103322, 10.583005244258363, 10.099504938362077, 9.486832980505138, 8.717797887081348, 7.745966692414834, 6.48074069840786, 4.69041575982343,
    0.0, 4.898979485566356, 6.782329983125268, 8.12403840463596, 9.16515138991168, 10.0, 10.677078252031311, 11.224972160321824, 11.661903789690601, 12.0, 12.24744871391589, 12.409673645990857, 12.489995996796797, 12.489995996796797, 12.409673645990857, 12.24744871391589, 12.0, 11.661903789690601, 11.224972160321824, 10.677078252031311, 10.0, 9.16515138991168, 8.12403840463596, 6.782329983125268, 4.898979485566356,
    0.0, 5.0990195135927845, 7.0710678118654755, 8.48528137423857, 9.591663046625438, 10.488088481701515, 11.224972160321824, 11.832159566199232, 12.328828005937952, 12.727922061357855, 13.038404810405298, 13.2664991614216, 13.416407864998739, 13.490737563232042, 13.490737563232042, 13.416407864998739, 13.2664991614216, 13.038404810405298, 12.727922061357855, 12.328828005937952, 11.832159566199232, 11.224972160321824, 10.488088481701515, 9.591663046625438, 8.48528137423857, 7.0710678118654755, 5.0990195135927845,
    0.0, 5.291502622129181, 7.3484692283495345, 8.831760866327848, 10.0, 10.954451150103322, 11.74734012447073, 12.409673645990857, 12.96148139681572, 13.416407864998739, 13.784048752090222, 14.071247279470288, 14.2828568570857, 14.422205101855956, 14.491376746189438, 14.491376746189438, 14.422205101855956, 14.2828568570857, 14.071247279470288, 13.784048752090222, 13.416407864998739, 12.96148139681572, 12.409673645990857, 11.74734012447073, 10.954451150103322, 10.0, 8.831760866327848, 7.3484692283495345, 5.291502622129181,
    0.0, 5.477225575051661, 7.615773105863909, 9.16515138991168, 10.392304845413264, 11.40175425099138, 12.24744871391589, 12.96148139681572, 13.564659966250536, 14.071247279470288, 14.491376746189438, 14.832396974191326, 15.0996688705415, 15.297058540778355, 15.427248620541512, 15.491933384829668, 15.491933384829668, 15.427248620541512, 15.297058540778355, 15.0996688705415, 14.832396974191326, 14.491376746189438, 14.071247279470288, 13.564659966250536, 12.96148139681572, 12.24744871391589, 11.40175425099138, 10.392304845413264, 9.16515138991168, 7.615773105863909, 5.477225575051661,
    0.0, 5.656854249492381, 7.874007874011811, 9.486832980505138, 10.770329614269007, 11.832159566199232, 12.727922061357855, 13.490737563232042, 14.142135623730951, 14.696938456699069, 15.165750888103101, 15.556349186104045, 15.874507866387544, 16.1245154965971, 16.30950643030009, 16.431676725154983, 16.492422502470642, 16.492422502470642, 16.431676725154983, 16.30950643030009, 16.1245154965971, 15.874507866387544, 15.556349186104045, 15.165750888103101, 14.696938456699069, 14.142135623730951, 13.490737563232042, 12.727922061357855, 11.832159566199232, 10.770329614269007, 9.486832980505138, 7.874007874011811, 5.656854249492381,
    0.0, 5.830951894845301, 8.12403840463596, 9.797958971132712, 11.135528725660043, 12.24744871391589, 13.19090595827292, 14.0, 14.696938456699069, 15.297058540778355, 15.811388300841896, 16.24807680927192, 16.61324772583615, 16.911534525287763, 17.146428199482248, 17.320508075688775, 17.435595774162696, 17.4928556845359, 17.4928556845359, 17.435595774162696, 17.320508075688775, 17.146428199482248, 16.911534525287763, 16.61324772583615, 16.24807680927192, 15.811388300841896, 15.297058540778355, 14.696938456699069, 14.0, 13.19090595827292, 12.24744871391589, 11.135528725660043, 9.797958971132712, 8.12403840463596, 5.830951894845301,
    0.0, 6.0, 8.366600265340756, 10.099504938362077, 11.489125293076057, 12.649110640673518, 13.638181696985855, 14.491376746189438, 15.231546211727817, 15.874507866387544, 16.431676725154983, 16.911534525287763, 17.320508075688775, 17.663521732655695, 17.944358444926362, 18.16590212458495, 18.33030277982336, 18.439088914585774, 18.49324200890693, 18.49324200890693, 18.439088914585774, 18.33030277982336, 18.16590212458495, 17.944358444926362, 17.663521732655695, 17.320508075688775, 16.911534525287763, 16.431676725154983, 15.874507866387544, 15.231546211727817, 14.491376746189438, 13.638181696985855, 12.649110640673518, 11.489125293076057, 10.099504938362077, 8.366600265340756, 6.0,
    0.0, 6.164414002968976, 8.602325267042627, 10.392304845413264, 11.832159566199232, 13.038404810405298, 14.071247279470288, 14.966629547095765, 15.748015748023622, 16.431676725154983, 17.029386365926403, 17.549928774784245, 18.0, 18.384776310850235, 18.708286933869708, 18.973665961010276, 19.183326093250876, 19.339079605813716, 19.44222209522358, 19.493588689617926, 19.493588689617926, 19.44222209522358, 19.339079605813716, 19.183326093250876, 18.973665961010276, 18.708286933869708, 18.384776310850235, 18.0, 17.549928774784245, 17.029386365926403, 16.431676725154983, 15.748015748023622, 14.966629547095765, 14.071247279470288, 13.038404810405298, 11.832159566199232, 10.392304845413264, 8.602325267042627, 6.164414002968976,
    0.0, 6.324555320336759, 8.831760866327848, 10.677078252031311, 12.165525060596439, 13.416407864998739, 14.491376746189438, 15.427248620541512, 16.24807680927192, 16.97056274847714, 17.60681686165901, 18.16590212458495, 18.65475810617763, 19.078784028338912, 19.44222209522358, 19.748417658131498, 20.0, 20.199009876724155, 20.346989949375804, 20.445048300260872, 20.493901531919196, 20.493901531919196, 20.445048300260872, 20.346989949375804, 20.199009876724155, 20.0, 19.748417658131498, 19.44222209522358, 19.078784028338912, 18.65475810617763, 18.16590212458495, 17.60681686165901, 16.97056274847714, 16.24807680927192, 15.427248620541512, 14.491376746189438, 13.416407864998739, 12.165525060596439, 10.677078252031311, 8.831760866327848, 6.324555320336759
};
static constexpr jdouble SQRT_LPM1_LMM[(SH_LARGEST_L+1)*(SH_LARGEST_L+1)] = {
    0.0,
    1.4142135623730951, 1.4142135623730951, 0.0,
    2.0, 2.449489742783178, 2.449489742783178, 2.0, 0.0,
    2.449489742783178, 3.1622776601683795, 3.4641016151377544, 3.4641016151377544, 3.1622776601683795, 2.449489742783178, 0.0,
    2.8284271247461903, 3.7416573867739413, 4.242640687119285, 4.47213595499958, 4.47213595499958, 4.242640687119285, 3.7416573867739413, 2.8284271247461903, 0.0,
    3.1622776601683795, 4.242640687119285, 4.898979485566356, 5.291502622129181, 5.477225575051661, 5.477225575051661, 5.291502622129181, 4.898979485566356, 4.242640687119285, 3.1622776601683795, 0.0,
    3.4641016151377544, 4.69041575982343, 5.477225575051661, 6.0, 6.324555320336759, 6.48074069840786, 6.48074069840786, 6.324555320336759, 6.0, 5.477225575051661, 4.69041575982343, 3.4641016151377544, 0.0,
    3.7416573867739413, 5.0990195135927845, 6.0, 6.6332495807108, 7.0710678118654755, 7.3484692283495345, 7.483314773547883, 7.483314773547883, 7.3484692283495345, 7.0710678118654755, 6.6332495807108, 6.0, 5.0990195135927845, 3.7416573867739413, 0.0,
    4.0, 5.477225575051661, 6.48074069840786, 7.211102550927978, 7.745966692414834, 8.12403840463596, 8.366600265340756, 8.48528137423857, 8.48528137423857, 8.366600265340756, 8.12403840463596, 7.745966692414834, 7.211102550927978, 6.48074069840786, 5.477225575051661, 4.0, 0.0,
    4.242640687119285, 5.830951894845301, 6.928203230275509, 7.745966692414834, 8.366600265340756, 8.831760866327848, 9.16515138991168, 9.38083151964686, 9.486832980505138, 9.486832980505138, 9.38083151964686, 9.16515138991168, 8.831760866327848, 8.366600265340756, 7.745966692414834, 6.928203230275509, 5.830951894845301, 4.242640687119285, 0.0,
    4.47213595499958, 6.164414002968976, 7.3484692283495345, 8.246211251235321, 8.94427190999916, 9.486832980505138, 9.899494936611665, 10.198039027185569, 10.392304845413264, 10.488088481701515, 10.488088481701515, 10.392304845413264, 10.198039027185569, 9.899494936611665, 9.486832980505138, 8.94427190999916, 8.246211251235321, 7.3484692283495345, 6.164414002968976, 4.47213595499958, 0.0,
    4.69041575982343, 6.48074069840786, 7.745966692414834, 8.717797887081348, 9.486832980505138, 10.099504938362077, 10.583005244258363, 10.954451150103322, 11.224972160321824, 11.40175425099138, 11.489125293076057, 11.489125293076057, 11.40175425099138, 11.224972160321824, 10.954451150103322, 10.583005244258363, 10.099504938362077, 9.486832980505138, 8.717797887081348, 7.745966692414834, 6.48074069840786, 4.69041575982343, 0.0,
    4.898979485566356, 6.782329983125268, 8.12403840463596, 9.16515138991168, 10.0, 10.677078252031311, 11.224972160321824, 11.661903789690601, 12.0, 12.24744871391589, 12.409673645990857, 12.489995996796797, 12.489995996796797, 12.409673645990857, 12.24744871391589, 12.0, 11.661903789690601, 11.224972160321824, 10.677078252031311, 10.0, 9.16515138991168, 8.12403840463596, 6.782329983125268, 4.898979485566356, 0.0,
    5.0990195135927845, 7.0710678118654755, 8.48528137423857, 9.591663046625438, 10.488088481701515, 11.224972160321824, 11.832159566199232, 12.328828005937952, 12.727922061357855, 13.038404810405298, 13.2664991614216, 13.416407864998739, 13.490737563232042, 13.490737563232042, 13.416407864998739, 13.2664991614216, 13.038404810405298, 12.727922061357855, 12.328828005937952, 11.832159566199232, 11.224972160321824, 10.488088481701515, 9.591663046625438, 8.48528137423857, 7.0710678118654755, 5.0990195135927845, 0.0,
    5.291502622129181, 7.3484692283495345, 8.831760866327848, 10.0, 10.954451150103322, 11.74734012447073, 12.409673645990857, 12.96148139681572, 13.416407864998739, 13.784048752090222, 14.071247279470288, 14.2828568570857, 14.422205101855956, 14.491376746189438, 14.491376746189438, 14.422205101855956, 14.2828568570857, 14.071247279470288, 13.784048752090222, 13.416407864998739, 12.96148139681572, 12.409673645990857, 11.74734012447073, 10.954451150103322, 10.0, 8.831760866327848, 7.3484692283495345, 5.291502622129181, 0.0,
    5.477225575051661, 7.615773105863909, 9.16515138991168, 10.392304845413264, 11.40175425099138, 12.24744871391589, 12.96148139681572, 13.564659966250536, 14.071247279470288, 14.491376746189438, 14.832396974191326, 15.0996688705415, 15.297058540778355, 15.427248620541512, 15.491933384829668, 15.491933384829668, 15.427248620541512, 15.297058540778355, 15.0996688705415, 14.832396974191326, 14.491376746189438, 14.071247279470288, 13.564659966250536, 12.96148139681572, 12.24744871391589, 11.40175425099138, 10.392304845413264, 9.16515138991168, 7.615773105863909, 5.477225575051661, 0.0,
    5.656854249492381, 7.874007874011811, 9.486832980505138, 10.770329614269007, 11.832159566199232, 12.727922061357855, 13.490737563232042, 14.142135623730951, 14.696938456699069, 15.165750888103101, 15.556349186104045, 15.874507866387544, 16.1245154965971, 16.30950643030009, 16.431676725154983, 16.492422502470642, 16.492422502470642, 16.431676725154983, 16.30950643030009, 16.1245154965971, 15.874507866387544, 15.556349186104045, 15.165750888103101, 14.696938456699069, 14.142135623730951, 13.490737563232042, 12.727922061357855, 11.832159566199232, 10.770329614269007, 9.486832980505138, 7.874007874011811, 5.656854249492381, 0.0,
    5.830951894845301, 8.12403840463596, 9.797958971132712, 11.135528725660043, 12.24744871391589, 13.19090595827292, 14.0, 14.696938456699069, 15.297058540778355, 15.811388300841896, 16.24807680927192, 16.61324772583615, 16.911534525287763, 17.146428199482248, 17.320508075688775, 17.435595774162696, 17.4928556845359, 17.4928556845359, 17.435595774162696, 17.320508075688775, 17.146428199482248, 16.911534525287763, 16.61324772583615, 16.24807680927192, 15.811388300841896, 15.297058540778355, 14.696938456699069, 14.0, 13.19090595827292, 12.24744871391589, 11.135528725660043, 9.797958971132712, 8.12403840463596, 5.830951894845301, 0.0,
    6.0, 8.366600265340756, 10.099504938362077, 11.489125293076057, 12.649110640673518, 13.638181696985855, 14.491376746189438, 15.231546211727817, 15.874507866387544, 16.431676725154983, 16.911534525287763, 17.320508075688775, 17.663521732655695, 17.944358444926362, 18.16590212458495, 18.33030277982336, 18.439088914585774, 18.49324200890693, 18.49324200890693, 18.439088914585774, 18.33030277982336, 18.16590212458495, 17.944358444926362, 17.663521732655695, 17.320508075688775, 16.911534525287763, 16.431676725154983, 15.874507866387544, 15.231546211727817, 14.491376746189438, 13.638181696985855, 12.649110640673518, 11.489125293076057, 10.099504938362077, 8.366600265340756, 6.0, 0.0,
    6.164414002968976, 8.602325267042627, 10.392304845413264, 11.832159566199232, 13.038404810405298, 14.071247279470288, 14.966629547095765, 15.748015748023622, 16.431676725154983, 17.029386365926403, 17.549928774784245, 18.0, 18.384776310850235, 18.708286933869708, 18.973665961010276, 19.183326093250876, 19.339079605813716, 19.44222209522358, 19.493588689617926, 19.493588689617926, 19.44222209522358, 19.339079605813716, 19.183326093250876, 18.973665961010276, 18.708286933869708, 18.384776310850235, 18.0, 17.549928774784245, 17.029386365926403, 16.431676725154983, 15.748015748023622, 14.966629547095765, 14.071247279470288, 13.038404810405298, 11.832159566199232, 10.392304845413264, 8.602325267042627, 6.164414002968976, 0.0,
    6.324555320336759, 8.831760866327848, 10.677078252031311, 12.165525060596439, 13.416407864998739, 14.491376746189438, 15.427248620541512, 16.24807680927192, 16.97056274847714, 17.60681686165901, 18.16590212458495, 18.65475810617763, 19.078784028338912, 19.44222209522358, 19.748417658131498, 20.0, 20.199009876724155, 20.346989949375804, 20.445048300260872, 20.493901531919196, 20.493901531919196, 20.445048300260872, 20.346989949375804, 20.199009876724155, 20.0, 19.748417658131498, 19.44222209522358, 19.078784028338912, 18.65475810617763, 18.16590212458495, 17.60681686165901, 16.97056274847714, 16.24807680927192, 15.427248620541512, 14.491376746189438, 13.416407864998739, 12.165525060596439, 10.677078252031311, 8.831760866327848, 6.324555320336759, 0.0
};
static constexpr jdouble SQRT_2LM1P3[SH_LARGEST_L+1] = {
    1.0, 1.7320508075688772, 2.23606797749979, 2.6457513110645907, 3.0, 3.3166247903554, 3.605551275463989, 3.872983346207417, 4.123105625617661, 4.358898943540674, 4.58257569495584, 4.795831523312719,
    5.0, 5.196152422706632, 5.385164807134504, 5.5677643628300215, 5.744562646538029, 5.916079783099616, 6.082762530298219, 6.244997998398398, 6.4031242374328485
};
static constexpr jdouble SQRT_1P1D2L[SH_LARGEST_L+1] = {
    -1.0, 1.224744871391589, 1.118033988749895, 1.0801234497346435, 1.0606601717798212, 1.0488088481701516, 1.0408329997330663, 1.0350983390135313, 1.0307764064044151, 1.0274023338281628, 1.02469507659596,
    1.02247471629109, 1.0206207261596576, 1.0190493307301363, 1.0177004891982149, 1.0165300454651272, 1.015504800579495, 1.0145993123917847, 1.0137937550497031, 1.0130724502589556, 1.0124228365658292
};

template <jint L>
static inline void realNormalizedLegendreInterLoop_(jdouble aX, jdouble aY, jdouble *rDest, jdouble &rPll) noexcept {
    static_assert(L > 1, "INVALID L");
    constexpr jint tStartL = L*L + L;
    constexpr jint tStartLmm = (L-1)*(L-1) + (L-1);
    constexpr jint tStartLm2 = (L-2)*(L-2) + (L-2);
    constexpr jint tStartAB = L*(L+1)/2;
    rDest[tStartL] = SH_Alm[tStartAB] * (aX*rDest[tStartLmm] + SH_Blm[tStartAB]*rDest[tStartLm2]);
    for (jint m = 1; m < L-1; ++m) {
        jdouble tPlm = SH_Alm[tStartAB+m] * (aX*rDest[tStartLmm+m] + SH_Blm[tStartAB+m]*rDest[tStartLm2+m]);
        rDest[tStartL+m] = tPlm;
        rDest[tStartL-m] = tPlm;
    }
    jdouble tPlm = aX * SQRT_2LM1P3[L] * rPll;
    rDest[tStartL+(L-1)] = tPlm;
    rDest[tStartL-(L-1)] = tPlm;
    rPll *= (-SQRT_1P1D2L[L] * aY);
    rDest[tStartL+L] = rPll;
    rDest[tStartL-L] = rPll;
}
template <jint LMAX>
static inline void realNormalizedLegendreFull(jdouble aX, jdouble aY, jdouble *rDest) noexcept {
    jdouble tPll = 0.28209479177387814347403972578039; // = sqrt(1/(4*PI))
    rDest[0] = tPll;
    if (LMAX == 0) return;
    rDest[2] = SQRT3 * aX * tPll;
    tPll *= (-SQRT3DIV2 * aY);
    rDest[2+1] = tPll;
    rDest[2-1] = tPll;
    if (LMAX == 1) return;
    realNormalizedLegendreInterLoop_<2>(aX, aY, rDest, tPll);
    if (LMAX == 2) return;
    realNormalizedLegendreInterLoop_<3>(aX, aY, rDest, tPll);
    if (LMAX == 3) return;
    realNormalizedLegendreInterLoop_<4>(aX, aY, rDest, tPll);
    if (LMAX == 4) return;
    realNormalizedLegendreInterLoop_<5>(aX, aY, rDest, tPll);
    if (LMAX == 5) return;
    realNormalizedLegendreInterLoop_<6>(aX, aY, rDest, tPll);
    if (LMAX == 6) return;
    realNormalizedLegendreInterLoop_<7>(aX, aY, rDest, tPll);
    if (LMAX == 7) return;
    realNormalizedLegendreInterLoop_<8>(aX, aY, rDest, tPll);
    if (LMAX == 8) return;
    realNormalizedLegendreInterLoop_<9>(aX, aY, rDest, tPll);
    if (LMAX == 9) return;
    realNormalizedLegendreInterLoop_<10>(aX, aY, rDest, tPll);
    if (LMAX == 10) return;
    realNormalizedLegendreInterLoop_<11>(aX, aY, rDest, tPll);
    if (LMAX == 11) return;
    realNormalizedLegendreInterLoop_<12>(aX, aY, rDest, tPll);
}

template <jint M, jint LMAX>
static inline void realSphericalHarmonicsFull4InterLoop_(jdouble aCosPhi2, jdouble &rSinMPhi, jdouble &rSinMmmPhi, jdouble &rCosMPhi, jdouble &rCosMmmPhi, jdouble *rDest) noexcept {
    const jdouble fSqrt2CosMPhi = SQRT2*rCosMPhi;
    const jdouble fSqrt2SinMPhi = SQRT2*rSinMPhi;
    for (jint l = M; l <= LMAX; ++l) {
        rDest[l*l+l + M] *= fSqrt2CosMPhi;
        rDest[l*l+l - M] *= fSqrt2SinMPhi;
    }
    const jdouble tSinMppPhi = aCosPhi2 * rSinMPhi - rSinMmmPhi;
    const jdouble tCosMppPhi = aCosPhi2 * rCosMPhi - rCosMmmPhi;
    rSinMmmPhi = rSinMPhi; rCosMmmPhi = rCosMPhi;
    rSinMPhi = tSinMppPhi; rCosMPhi = tCosMppPhi;
}
template <jint LMAX>
static inline void realSphericalHarmonicsFull4(jdouble aX, jdouble aY, jdouble aZ, jdouble aDis, jdouble *rDest) noexcept {
    const jdouble tXY = hypot(aX, aY);
    const jdouble tCosTheta = aZ / aDis;
    const jdouble tSinTheta = tXY / aDis;
    jdouble tCosPhi;
    jdouble tSinPhi;
    // avoid nan
    if (JSE_NNAP::numericEqual(tXY, 0.0)) {
        tCosPhi = 1.0;
        tSinPhi = 0.0;
    } else {
        tCosPhi = aX / tXY;
        tSinPhi = aY / tXY;
    }
    // cal real Legendre
    realNormalizedLegendreFull<LMAX>(tCosTheta, tSinTheta, rDest);
    if (LMAX == 0) return;
    // cal sinMPhi & conMPhi
    jdouble rSinMmmPhi = 0.0;
    jdouble rCosMmmPhi = 1.0;
    jdouble rSinMPhi = tSinPhi;
    jdouble rCosMPhi = tCosPhi;
    const jdouble tCosPhi2 = rCosMPhi+rCosMPhi;
    realSphericalHarmonicsFull4InterLoop_<1, LMAX>(tCosPhi2, rSinMPhi, rSinMmmPhi, rCosMPhi, rCosMmmPhi, rDest);
    if (LMAX == 1) return;
    realSphericalHarmonicsFull4InterLoop_<2, LMAX>(tCosPhi2, rSinMPhi, rSinMmmPhi, rCosMPhi, rCosMmmPhi, rDest);
    if (LMAX == 2) return;
    realSphericalHarmonicsFull4InterLoop_<3, LMAX>(tCosPhi2, rSinMPhi, rSinMmmPhi, rCosMPhi, rCosMmmPhi, rDest);
    if (LMAX == 3) return;
    realSphericalHarmonicsFull4InterLoop_<4, LMAX>(tCosPhi2, rSinMPhi, rSinMmmPhi, rCosMPhi, rCosMmmPhi, rDest);
    if (LMAX == 4) return;
    realSphericalHarmonicsFull4InterLoop_<5, LMAX>(tCosPhi2, rSinMPhi, rSinMmmPhi, rCosMPhi, rCosMmmPhi, rDest);
    if (LMAX == 5) return;
    realSphericalHarmonicsFull4InterLoop_<6, LMAX>(tCosPhi2, rSinMPhi, rSinMmmPhi, rCosMPhi, rCosMmmPhi, rDest);
    if (LMAX == 6) return;
    realSphericalHarmonicsFull4InterLoop_<7, LMAX>(tCosPhi2, rSinMPhi, rSinMmmPhi, rCosMPhi, rCosMmmPhi, rDest);
    if (LMAX == 7) return;
    realSphericalHarmonicsFull4InterLoop_<8, LMAX>(tCosPhi2, rSinMPhi, rSinMmmPhi, rCosMPhi, rCosMmmPhi, rDest);
    if (LMAX == 8) return;
    realSphericalHarmonicsFull4InterLoop_<9, LMAX>(tCosPhi2, rSinMPhi, rSinMmmPhi, rCosMPhi, rCosMmmPhi, rDest);
    if (LMAX == 9) return;
    realSphericalHarmonicsFull4InterLoop_<10, LMAX>(tCosPhi2, rSinMPhi, rSinMmmPhi, rCosMPhi, rCosMmmPhi, rDest);
    if (LMAX == 10) return;
    realSphericalHarmonicsFull4InterLoop_<11, LMAX>(tCosPhi2, rSinMPhi, rSinMmmPhi, rCosMPhi, rCosMmmPhi, rDest);
    if (LMAX == 11) return;
    realSphericalHarmonicsFull4InterLoop_<12, LMAX>(tCosPhi2, rSinMPhi, rSinMmmPhi, rCosMPhi, rCosMmmPhi, rDest);
}

template <jint NMAX, jint LMALL, jboolean MPLUS, jboolean WT>
static inline void setormplusCnlm_(jdouble *rCnlm, jdouble *rCnlmWt, jdouble *aY, jdouble aFc, jdouble *aRn, jdouble aWt) noexcept {
    jdouble *tCnlm = rCnlm;
    jdouble *tCnlmWt = rCnlmWt;
    for (jint n = 0; n <= NMAX; ++n) {
        const jdouble tMul = aFc*aRn[n];
        for (jint k = 0; k < LMALL; ++k) {
            const jdouble tValue = tMul*aY[k];
            if (MPLUS) {
                tCnlm[k] += tValue;
                if (WT) tCnlmWt[k] += aWt*tValue;
            } else {
                tCnlm[k] = tValue;
                if (WT) tCnlmWt[k] = aWt*tValue;
            }
        }
        tCnlm += LMALL;
        if (WT) tCnlmWt += LMALL;
    }
}
template <jint LMALL, jboolean MPLUS, jboolean WT>
static inline void setormplusCnlm_(jdouble *rCnlm, jdouble *rCnlmWt, jdouble *aY, jdouble aFc, jdouble *aRn, jdouble aWt, jint aNMax) noexcept {
    switch (aNMax) {
    case 0: {setormplusCnlm_<0, LMALL, MPLUS, WT>(rCnlm, rCnlmWt, aY, aFc, aRn, aWt); return;}
    case 1: {setormplusCnlm_<1, LMALL, MPLUS, WT>(rCnlm, rCnlmWt, aY, aFc, aRn, aWt); return;}
    case 2: {setormplusCnlm_<2, LMALL, MPLUS, WT>(rCnlm, rCnlmWt, aY, aFc, aRn, aWt); return;}
    case 3: {setormplusCnlm_<3, LMALL, MPLUS, WT>(rCnlm, rCnlmWt, aY, aFc, aRn, aWt); return;}
    case 4: {setormplusCnlm_<4, LMALL, MPLUS, WT>(rCnlm, rCnlmWt, aY, aFc, aRn, aWt); return;}
    case 5: {setormplusCnlm_<5, LMALL, MPLUS, WT>(rCnlm, rCnlmWt, aY, aFc, aRn, aWt); return;}
    case 6: {setormplusCnlm_<6, LMALL, MPLUS, WT>(rCnlm, rCnlmWt, aY, aFc, aRn, aWt); return;}
    case 7: {setormplusCnlm_<7, LMALL, MPLUS, WT>(rCnlm, rCnlmWt, aY, aFc, aRn, aWt); return;}
    case 8: {setormplusCnlm_<8, LMALL, MPLUS, WT>(rCnlm, rCnlmWt, aY, aFc, aRn, aWt); return;}
    case 9: {setormplusCnlm_<9, LMALL, MPLUS, WT>(rCnlm, rCnlmWt, aY, aFc, aRn, aWt); return;}
    case 10: {setormplusCnlm_<10, LMALL, MPLUS, WT>(rCnlm, rCnlmWt, aY, aFc, aRn, aWt); return;}
    case 11: {setormplusCnlm_<11, LMALL, MPLUS, WT>(rCnlm, rCnlmWt, aY, aFc, aRn, aWt); return;}
    case 12: {setormplusCnlm_<12, LMALL, MPLUS, WT>(rCnlm, rCnlmWt, aY, aFc, aRn, aWt); return;}
    case 13: {setormplusCnlm_<13, LMALL, MPLUS, WT>(rCnlm, rCnlmWt, aY, aFc, aRn, aWt); return;}
    case 14: {setormplusCnlm_<14, LMALL, MPLUS, WT>(rCnlm, rCnlmWt, aY, aFc, aRn, aWt); return;}
    case 15: {setormplusCnlm_<15, LMALL, MPLUS, WT>(rCnlm, rCnlmWt, aY, aFc, aRn, aWt); return;}
    case 16: {setormplusCnlm_<16, LMALL, MPLUS, WT>(rCnlm, rCnlmWt, aY, aFc, aRn, aWt); return;}
    case 17: {setormplusCnlm_<17, LMALL, MPLUS, WT>(rCnlm, rCnlmWt, aY, aFc, aRn, aWt); return;}
    case 18: {setormplusCnlm_<18, LMALL, MPLUS, WT>(rCnlm, rCnlmWt, aY, aFc, aRn, aWt); return;}
    case 19: {setormplusCnlm_<19, LMALL, MPLUS, WT>(rCnlm, rCnlmWt, aY, aFc, aRn, aWt); return;}
    case 20: {setormplusCnlm_<20, LMALL, MPLUS, WT>(rCnlm, rCnlmWt, aY, aFc, aRn, aWt); return;}
    default: {return;}
    }
}
template <jint LMALL>
static inline void calBnlm(jdouble *rBnlm, jdouble *aY, jdouble aFc, jdouble *aRn, jint aNMax) noexcept {
    setormplusCnlm_<LMALL, JNI_FALSE, JNI_FALSE>(rBnlm, NULL, aY, aFc, aRn, 0, aNMax);
}
template <jint LMALL>
static inline void mplusCnlm(jdouble *rCnlm, jdouble *aY, jdouble aFc, jdouble *aRn, jint aNMax) noexcept {
    setormplusCnlm_<LMALL, JNI_TRUE, JNI_FALSE>(rCnlm, NULL, aY, aFc, aRn, 0, aNMax);
}
template <jint LMALL>
static inline void mplusCnlmWt(jdouble *rCnlm, jdouble *rCnlmWt, jdouble *aY, jdouble aFc, jdouble *aRn, jdouble aWt, jint aNMax) noexcept {
    setormplusCnlm_<LMALL, JNI_TRUE, JNI_TRUE>(rCnlm, rCnlmWt, aY, aFc, aRn, aWt, aNMax);
}

template <jint N>
static inline void mplusBnlm2Cnlm(jdouble *rCnlm, jdouble *aBnlm, jdouble aWt) noexcept {
    for (jint i = 0; i < N; ++i) {
        rCnlm[i] += aWt*aBnlm[i];
    }
}
template <jint LMALL>
static inline void mplusBnlm2Cnlm(jdouble *rCnlm, jdouble *aBnlm, jdouble aWt, jint aNMax) noexcept {
    switch (aNMax) {
    case 0: {mplusBnlm2Cnlm<(0+1)*LMALL>(rCnlm, aBnlm, aWt); return;}
    case 1: {mplusBnlm2Cnlm<(1+1)*LMALL>(rCnlm, aBnlm, aWt); return;}
    case 2: {mplusBnlm2Cnlm<(2+1)*LMALL>(rCnlm, aBnlm, aWt); return;}
    case 3: {mplusBnlm2Cnlm<(3+1)*LMALL>(rCnlm, aBnlm, aWt); return;}
    case 4: {mplusBnlm2Cnlm<(4+1)*LMALL>(rCnlm, aBnlm, aWt); return;}
    case 5: {mplusBnlm2Cnlm<(5+1)*LMALL>(rCnlm, aBnlm, aWt); return;}
    case 6: {mplusBnlm2Cnlm<(6+1)*LMALL>(rCnlm, aBnlm, aWt); return;}
    case 7: {mplusBnlm2Cnlm<(7+1)*LMALL>(rCnlm, aBnlm, aWt); return;}
    case 8: {mplusBnlm2Cnlm<(8+1)*LMALL>(rCnlm, aBnlm, aWt); return;}
    case 9: {mplusBnlm2Cnlm<(9+1)*LMALL>(rCnlm, aBnlm, aWt); return;}
    case 10: {mplusBnlm2Cnlm<(10+1)*LMALL>(rCnlm, aBnlm, aWt); return;}
    case 11: {mplusBnlm2Cnlm<(11+1)*LMALL>(rCnlm, aBnlm, aWt); return;}
    case 12: {mplusBnlm2Cnlm<(12+1)*LMALL>(rCnlm, aBnlm, aWt); return;}
    case 13: {mplusBnlm2Cnlm<(13+1)*LMALL>(rCnlm, aBnlm, aWt); return;}
    case 14: {mplusBnlm2Cnlm<(14+1)*LMALL>(rCnlm, aBnlm, aWt); return;}
    case 15: {mplusBnlm2Cnlm<(15+1)*LMALL>(rCnlm, aBnlm, aWt); return;}
    case 16: {mplusBnlm2Cnlm<(16+1)*LMALL>(rCnlm, aBnlm, aWt); return;}
    case 17: {mplusBnlm2Cnlm<(17+1)*LMALL>(rCnlm, aBnlm, aWt); return;}
    case 18: {mplusBnlm2Cnlm<(18+1)*LMALL>(rCnlm, aBnlm, aWt); return;}
    case 19: {mplusBnlm2Cnlm<(19+1)*LMALL>(rCnlm, aBnlm, aWt); return;}
    case 20: {mplusBnlm2Cnlm<(20+1)*LMALL>(rCnlm, aBnlm, aWt); return;}
    default: {return;}
    }
}

template <jint LMALL>
static inline jdouble dotBnlmGradCnlm(jdouble *aBnlm, jdouble *aGradCnlm, jint aNMax) noexcept {
    switch (aNMax) {
    case 0: {return JSE_NNAP::dot<(0+1)*LMALL>(aBnlm, aGradCnlm);}
    case 1: {return JSE_NNAP::dot<(1+1)*LMALL>(aBnlm, aGradCnlm);}
    case 2: {return JSE_NNAP::dot<(2+1)*LMALL>(aBnlm, aGradCnlm);}
    case 3: {return JSE_NNAP::dot<(3+1)*LMALL>(aBnlm, aGradCnlm);}
    case 4: {return JSE_NNAP::dot<(4+1)*LMALL>(aBnlm, aGradCnlm);}
    case 5: {return JSE_NNAP::dot<(5+1)*LMALL>(aBnlm, aGradCnlm);}
    case 6: {return JSE_NNAP::dot<(6+1)*LMALL>(aBnlm, aGradCnlm);}
    case 7: {return JSE_NNAP::dot<(7+1)*LMALL>(aBnlm, aGradCnlm);}
    case 8: {return JSE_NNAP::dot<(8+1)*LMALL>(aBnlm, aGradCnlm);}
    case 9: {return JSE_NNAP::dot<(9+1)*LMALL>(aBnlm, aGradCnlm);}
    case 10: {return JSE_NNAP::dot<(10+1)*LMALL>(aBnlm, aGradCnlm);}
    case 11: {return JSE_NNAP::dot<(11+1)*LMALL>(aBnlm, aGradCnlm);}
    case 12: {return JSE_NNAP::dot<(12+1)*LMALL>(aBnlm, aGradCnlm);}
    case 13: {return JSE_NNAP::dot<(13+1)*LMALL>(aBnlm, aGradCnlm);}
    case 14: {return JSE_NNAP::dot<(14+1)*LMALL>(aBnlm, aGradCnlm);}
    case 15: {return JSE_NNAP::dot<(15+1)*LMALL>(aBnlm, aGradCnlm);}
    case 16: {return JSE_NNAP::dot<(16+1)*LMALL>(aBnlm, aGradCnlm);}
    case 17: {return JSE_NNAP::dot<(17+1)*LMALL>(aBnlm, aGradCnlm);}
    case 18: {return JSE_NNAP::dot<(18+1)*LMALL>(aBnlm, aGradCnlm);}
    case 19: {return JSE_NNAP::dot<(19+1)*LMALL>(aBnlm, aGradCnlm);}
    case 20: {return JSE_NNAP::dot<(20+1)*LMALL>(aBnlm, aGradCnlm);}
    default: {return 0.0;}
    }
}

template <jint LMALL, jboolean WT>
static inline void gradCnlm2Fxyz_(jint j, jdouble *aGradCnlm, jdouble *aGradCnlmWt, jdouble *rGradY,
                                  jdouble *aY, jdouble aFc, jdouble *aRn, jdouble aWt, jint aNMax,
                                  jdouble aFcPx, jdouble aFcPy, jdouble aFcPz,
                                  jdouble *aRnPx, jdouble *aRnPy, jdouble *aRnPz,
                                  jdouble *aYPx, jdouble *aYPy, jdouble *aYPz,
                                  jdouble *rFx, jdouble *rFy, jdouble *rFz) noexcept {
    // clear gradY here
    for (jint k = 0; k < LMALL; ++k) {
        rGradY[k] = 0.0;
    }
    jdouble tGradFc = 0.0;
    jdouble rFxj = 0.0, rFyj = 0.0, rFzj = 0.0;
    jdouble *tGradCnlm = aGradCnlm;
    jdouble *tGradCnlmWt = aGradCnlmWt;
    for (jint n = 0; n <= aNMax; ++n) {
        const jdouble tRnn = aRn[n];
        const jdouble tMul = aFc * tRnn;
        jdouble tGradRn = 0.0;
        for (jint k = 0; k < LMALL; ++k) {
            jdouble subGradBnlm = tGradCnlm[k];
            if (WT) subGradBnlm += aWt*tGradCnlmWt[k];
            rGradY[k] += tMul * subGradBnlm;
            tGradRn += aY[k] * subGradBnlm;
        }
        tGradCnlm += LMALL;
        if (WT) tGradCnlmWt += LMALL;
        
        tGradFc += tRnn * tGradRn;
        tGradRn *= aFc;
        rFxj += tGradRn*aRnPx[n];
        rFyj += tGradRn*aRnPy[n];
        rFzj += tGradRn*aRnPz[n];
    }
    for (jint k = 0; k < LMALL; ++k) {
        const jdouble subGradY = rGradY[k];
        rFxj += subGradY*aYPx[k];
        rFyj += subGradY*aYPy[k];
        rFzj += subGradY*aYPz[k];
    }
    rFxj += aFcPx*tGradFc;
    rFyj += aFcPy*tGradFc;
    rFzj += aFcPz*tGradFc;
    rFx[j] += rFxj; rFy[j] += rFyj; rFz[j] += rFzj;
}
template <jint LMALL>
static inline void gradBnlm2Fxyz(jint j, jdouble *aGradBnlm, jdouble *rGradY, jdouble *aY, jdouble aFc, jdouble *aRn, jint aNMax, jdouble aFcPx, jdouble aFcPy, jdouble aFcPz,
                                 jdouble *aRnPx, jdouble *aRnPy, jdouble *aRnPz, jdouble *aYPx, jdouble *aYPy, jdouble *aYPz, jdouble *rFx, jdouble *rFy, jdouble *rFz) noexcept {
    gradCnlm2Fxyz_<LMALL, JNI_FALSE>(j, aGradBnlm, NULL, rGradY, aY, aFc, aRn, 0, aNMax, aFcPx, aFcPy, aFcPz, aRnPx, aRnPy, aRnPz, aYPx, aYPy, aYPz, rFx, rFy, rFz);
}
template <jint LMALL>
static inline void gradCnlmWt2Fxyz(jint j, jdouble *aGradCnlm, jdouble *aGradCnlmWt, jdouble *rGradY, jdouble *aY, jdouble aFc, jdouble *aRn, jdouble aWt, jint aNMax, jdouble aFcPx, jdouble aFcPy, jdouble aFcPz,
                                   jdouble *aRnPx, jdouble *aRnPy, jdouble *aRnPz, jdouble *aYPx, jdouble *aYPy, jdouble *aYPz, jdouble *rFx, jdouble *rFy, jdouble *rFz) noexcept {
    gradCnlm2Fxyz_<LMALL, JNI_TRUE>(j, aGradCnlm, aGradCnlmWt, rGradY, aY, aFc, aRn, aWt, aNMax, aFcPx, aFcPy, aFcPz, aRnPx, aRnPy, aRnPz, aYPx, aYPy, aYPz, rFx, rFy, rFz);
}

template <jint LMALL, jboolean MPLUS, jboolean WT>
static inline void setormplusGradNNGradCnlm_(jdouble *rGradNNGradCnlm, jdouble *rGradNNGradCnlmWt, jdouble *aY, jdouble aFc, jdouble *aRn, jdouble aWt, jint aNMax,
                                             jdouble *aYPx, jdouble *aYPy, jdouble *aYPz, jdouble *rGradNNGradY,
                                             jdouble aFcPx, jdouble aFcPy, jdouble aFcPz, jdouble *aRnPx, jdouble *aRnPy, jdouble *aRnPz,
                                             jdouble aGradFx, jdouble aGradFy, jdouble aGradFz) noexcept {
    for (jint k = 0; k < LMALL; ++k) {
        rGradNNGradY[k] = aYPx[k]*aGradFx + aYPy[k]*aGradFy + aYPz[k]*aGradFz;
    }
    const jdouble tGradNNGradFc = aFcPx*aGradFx + aFcPy*aGradFy + aFcPz*aGradFz;
    jdouble *tGradNNGradCnlm = rGradNNGradCnlm;
    jdouble *tGradNNGradCnlmWt = rGradNNGradCnlmWt;
    for (jint n = 0; n <= aNMax; ++n) {
        jdouble tGradNNGradRn = aRnPx[n]*aGradFx + aRnPy[n]*aGradFy + aRnPz[n]*aGradFz;
        jdouble tRnn = aRn[n];
        tGradNNGradRn = tRnn*tGradNNGradFc + aFc*tGradNNGradRn;
        tRnn *= aFc;
        for (jint k = 0; k < LMALL; ++k) {
            const jdouble tValue = aY[k]*tGradNNGradRn + tRnn*rGradNNGradY[k];
            if (MPLUS) {
                tGradNNGradCnlm[k] += tValue;
                if (WT) tGradNNGradCnlmWt[k] += aWt*tValue;
            } else {
                tGradNNGradCnlm[k] = tValue;
                if (WT) tGradNNGradCnlmWt[k] = aWt*tValue;
            }
        }
        tGradNNGradCnlm += LMALL;
        if (WT) tGradNNGradCnlmWt += LMALL;
    }
}
template <jint LMALL>
static inline void calGradNNGradBnlm(jdouble *rGradNNGradBnlm, jdouble *aY, jdouble aFc, jdouble *aRn, jint aNMax, jdouble *aYPx, jdouble *aYPy, jdouble *aYPz, jdouble *rGradNNGradY,
                                     jdouble aFcPx, jdouble aFcPy, jdouble aFcPz, jdouble *aRnPx, jdouble *aRnPy, jdouble *aRnPz, jdouble aGradFx, jdouble aGradFy, jdouble aGradFz) noexcept {
    setormplusGradNNGradCnlm_<LMALL, JNI_FALSE, JNI_FALSE>(rGradNNGradBnlm, NULL, aY, aFc, aRn, 0, aNMax, aYPx, aYPy, aYPz, rGradNNGradY, aFcPx, aFcPy, aFcPz, aRnPx, aRnPy, aRnPz, aGradFx, aGradFy, aGradFz);
}
template <jint LMALL>
static inline void mplusGradNNGradCnlm(jdouble *rGradNNGradCnlm, jdouble *aY, jdouble aFc, jdouble *aRn, jint aNMax, jdouble *aYPx, jdouble *aYPy, jdouble *aYPz, jdouble *rGradNNGradY,
                                       jdouble aFcPx, jdouble aFcPy, jdouble aFcPz, jdouble *aRnPx, jdouble *aRnPy, jdouble *aRnPz, jdouble aGradFx, jdouble aGradFy, jdouble aGradFz) noexcept {
    setormplusGradNNGradCnlm_<LMALL, JNI_TRUE, JNI_FALSE>(rGradNNGradCnlm, NULL, aY, aFc, aRn, 0, aNMax, aYPx, aYPy, aYPz, rGradNNGradY, aFcPx, aFcPy, aFcPz, aRnPx, aRnPy, aRnPz, aGradFx, aGradFy, aGradFz);
}
template <jint LMALL>
static inline void mplusGradNNGradCnlmWt(jdouble *rGradNNGradCnlm, jdouble *rGradNNGradCnlmWt, jdouble *aY, jdouble aFc, jdouble *aRn, jdouble aWt, jint aNMax, jdouble *aYPx, jdouble *aYPy, jdouble *aYPz, jdouble *rGradNNGradY,
                                         jdouble aFcPx, jdouble aFcPy, jdouble aFcPz, jdouble *aRnPx, jdouble *aRnPy, jdouble *aRnPz, jdouble aGradFx, jdouble aGradFy, jdouble aGradFz) noexcept {
    setormplusGradNNGradCnlm_<LMALL, JNI_TRUE, JNI_TRUE>(rGradNNGradCnlm, rGradNNGradCnlmWt, aY, aFc, aRn, aWt, aNMax, aYPx, aYPy, aYPz, rGradNNGradY, aFcPx, aFcPy, aFcPz, aRnPx, aRnPy, aRnPz, aGradFx, aGradFy, aGradFz);
}

template <jint L>
static inline void calL2Sub_(jdouble *aCnlm, jdouble *rFp) noexcept {
    constexpr jint tLen = L+L+1;
    const jdouble rDot = JSE_NNAP::dot<tLen>(aCnlm + (L*L));
    rFp[L-1] = (PI4/(jdouble)tLen) * rDot;
}
template <jint LMAX, jboolean NO_RADIAL>
static void calL2_(jdouble *aCnlm, jdouble *rFp) noexcept {
    // l == 0
    jdouble *tFp = rFp;
    if (!NO_RADIAL) {
        const jdouble tCnl0 = aCnlm[0];
        tFp[0] = PI4 * (tCnl0*tCnl0);
        ++tFp;
    }
    if (LMAX == 0) return;
    calL2Sub_<1>(aCnlm, tFp);
    if (LMAX == 1) return;
    calL2Sub_<2>(aCnlm, tFp);
    if (LMAX == 2) return;
    calL2Sub_<3>(aCnlm, tFp);
    if (LMAX == 3) return;
    calL2Sub_<4>(aCnlm, tFp);
    if (LMAX == 4) return;
    calL2Sub_<5>(aCnlm, tFp);
    if (LMAX == 5) return;
    calL2Sub_<6>(aCnlm, tFp);
    if (LMAX == 6) return;
    calL2Sub_<7>(aCnlm, tFp);
    if (LMAX == 7) return;
    calL2Sub_<8>(aCnlm, tFp);
    if (LMAX == 8) return;
    calL2Sub_<9>(aCnlm, tFp);
    if (LMAX == 9) return;
    calL2Sub_<10>(aCnlm, tFp);
    if (LMAX == 10) return;
    calL2Sub_<11>(aCnlm, tFp);
    if (LMAX == 11) return;
    calL2Sub_<12>(aCnlm, tFp);
}
static jdouble calL3_222_(jdouble *aCnlm) noexcept {
    jdouble rFp3 = 0.0;
    constexpr jint s2 = 2*2+2;
    for (jint i = 0; i < L3_SIZE_222; ++i) {
        const jint m1 = L3_INDEX_222[i][0];
        const jint m2 = L3_INDEX_222[i][1];
        const jint m3 = L3_INDEX_222[i][2];
        rFp3 += L3_COEFF_222[i] * aCnlm[s2+m1]*aCnlm[s2+m2]*aCnlm[s2+m3];
    }
    return rFp3;
}
static jdouble calL3_112_(jdouble *aCnlm) noexcept {
    jdouble rFp3 = 0.0;
    constexpr jint s1 = 1+1;
    constexpr jint s2 = 2*2+2;
    for (jint i = 0; i < L3_SIZE_112; ++i) {
        const jint m1 = L3_INDEX_112[i][0];
        const jint m2 = L3_INDEX_112[i][1];
        const jint m3 = L3_INDEX_112[i][2];
        rFp3 += L3_COEFF_112[i] * aCnlm[s1+m1]*aCnlm[s1+m2]*aCnlm[s2+m3];
    }
    return rFp3;
}
static jdouble calL3_233_(jdouble *aCnlm) noexcept {
    jdouble rFp3 = 0.0;
    constexpr jint s2 = 2*2+2;
    constexpr jint s3 = 3*3+3;
    for (jint i = 0; i < L3_SIZE_233; ++i) {
        const jint m1 = L3_INDEX_233[i][0];
        const jint m2 = L3_INDEX_233[i][1];
        const jint m3 = L3_INDEX_233[i][2];
        rFp3 += L3_COEFF_233[i] * aCnlm[s2+m1]*aCnlm[s3+m2]*aCnlm[s3+m3];
    }
    return rFp3;
}
static jdouble calL3_123_(jdouble *aCnlm) noexcept {
    jdouble rFp3 = 0.0;
    constexpr jint s1 = 1+1;
    constexpr jint s2 = 2*2+2;
    constexpr jint s3 = 3*3+3;
    for (jint i = 0; i < L3_SIZE_123; ++i) {
        const jint m1 = L3_INDEX_123[i][0];
        const jint m2 = L3_INDEX_123[i][1];
        const jint m3 = L3_INDEX_123[i][2];
        rFp3 += L3_COEFF_123[i] * aCnlm[s1+m1]*aCnlm[s2+m2]*aCnlm[s3+m3];
    }
    return rFp3;
}
static jdouble calL3_444_(jdouble *aCnlm) noexcept {
    jdouble rFp3 = 0.0;
    constexpr jint s4 = 4*4+4;
    for (jint i = 0; i < L3_SIZE_444; ++i) {
        const jint m1 = L3_INDEX_444[i][0];
        const jint m2 = L3_INDEX_444[i][1];
        const jint m3 = L3_INDEX_444[i][2];
        rFp3 += L3_COEFF_444[i] * aCnlm[s4+m1]*aCnlm[s4+m2]*aCnlm[s4+m3];
    }
    return rFp3;
}
static jdouble calL3_224_(jdouble *aCnlm) noexcept {
    jdouble rFp3 = 0.0;
    constexpr jint s2 = 2*2+2;
    constexpr jint s4 = 4*4+4;
    for (jint i = 0; i < L3_SIZE_224; ++i) {
        const jint m1 = L3_INDEX_224[i][0];
        const jint m2 = L3_INDEX_224[i][1];
        const jint m3 = L3_INDEX_224[i][2];
        rFp3 += L3_COEFF_224[i] * aCnlm[s2+m1]*aCnlm[s2+m2]*aCnlm[s4+m3];
    }
    return rFp3;
}
static jdouble calL3_334_(jdouble *aCnlm) noexcept {
    jdouble rFp3 = 0.0;
    constexpr jint s3 = 3*3+3;
    constexpr jint s4 = 4*4+4;
    for (jint i = 0; i < L3_SIZE_334; ++i) {
        const jint m1 = L3_INDEX_334[i][0];
        const jint m2 = L3_INDEX_334[i][1];
        const jint m3 = L3_INDEX_334[i][2];
        rFp3 += L3_COEFF_334[i] * aCnlm[s3+m1]*aCnlm[s3+m2]*aCnlm[s4+m3];
    }
    return rFp3;
}
static jdouble calL3_244_(jdouble *aCnlm) noexcept {
    jdouble rFp3 = 0.0;
    constexpr jint s2 = 2*2+2;
    constexpr jint s4 = 4*4+4;
    for (jint i = 0; i < L3_SIZE_244; ++i) {
        const jint m1 = L3_INDEX_244[i][0];
        const jint m2 = L3_INDEX_244[i][1];
        const jint m3 = L3_INDEX_244[i][2];
        rFp3 += L3_COEFF_244[i] * aCnlm[s2+m1]*aCnlm[s4+m2]*aCnlm[s4+m3];
    }
    return rFp3;
}
static jdouble calL3_134_(jdouble *aCnlm) noexcept {
    jdouble rFp3 = 0.0;
    constexpr jint s1 = 1+1;
    constexpr jint s3 = 3*3+3;
    constexpr jint s4 = 4*4+4;
    for (jint i = 0; i < L3_SIZE_134; ++i) {
        const jint m1 = L3_INDEX_134[i][0];
        const jint m2 = L3_INDEX_134[i][1];
        const jint m3 = L3_INDEX_134[i][2];
        rFp3 += L3_COEFF_134[i] * aCnlm[s1+m1]*aCnlm[s3+m2]*aCnlm[s4+m3];
    }
    return rFp3;
}
template <jint L3MAX, jboolean L3CROSS>
static void calL3_(jdouble *aCnlm, jdouble *rFp) noexcept {
    if (L3MAX <= 1) return;
    *rFp = calL3_222_(aCnlm); ++rFp;
    if (L3CROSS) {
        *rFp = calL3_112_(aCnlm); ++rFp;
    }
    if (L3MAX == 2) return;
    if (L3CROSS) {
        *rFp = calL3_233_(aCnlm); ++rFp;
        *rFp = calL3_123_(aCnlm); ++rFp;
    }
    if (L3MAX == 3) return;
    *rFp = calL3_444_(aCnlm); ++rFp;
    if (L3CROSS) {
        *rFp = calL3_224_(aCnlm); ++rFp;
        *rFp = calL3_334_(aCnlm); ++rFp;
        *rFp = calL3_244_(aCnlm); ++rFp;
        *rFp = calL3_134_(aCnlm); ++rFp;
    }
}

template <jint L>
static inline void calYPphi(jdouble *rYPphi, jdouble *aY) noexcept {
    constexpr jint tStart = L*L;
    constexpr jint tIdx = tStart+L;
    for (jint m = -L; m <= L; ++m) {
        rYPphi[tIdx+m] = -m * aY[tIdx-m];
    }
}
template <jint L>
static inline void calYPtheta(jdouble aCosPhi, jdouble aSinPhi, jdouble *rYPtheta, jdouble *aY) noexcept {
    switch(L) {
    case 0: {
        rYPtheta[0] = 0.0;
        return;
    }
    case 1: {
        constexpr jdouble tMul = SQRT_LPM_LMM1[2]*SQRT2_INV;
        rYPtheta[1] = -tMul * aSinPhi*aY[2];
        rYPtheta[2] =  tMul * (aCosPhi*aY[3] + aSinPhi*aY[1]);
        rYPtheta[3] = -tMul * aCosPhi*aY[2];
        return;
    }
    default: {
        constexpr jint tStart = L*L;
        constexpr jint tIdx = tStart+L;
        constexpr jdouble tMul = SQRT_LPM_LMM1[tIdx]*SQRT2_INV;
        rYPtheta[tIdx] = tMul * (aCosPhi*aY[tIdx+1] + aSinPhi*aY[tIdx-1]);
        rYPtheta[tIdx+1] = -tMul * aCosPhi*aY[tIdx];
        rYPtheta[tIdx-1] = -tMul * aSinPhi*aY[tIdx];
        for (jint m = 2; m <= L; ++m) {
            const jdouble tMul2 = -0.5*SQRT_LPM_LMM1[tIdx+m];
            rYPtheta[tIdx+m] = tMul2 * (aCosPhi*aY[tIdx+m-1] - aSinPhi*aY[tIdx-m+1]);
            rYPtheta[tIdx-m] = tMul2 * (aCosPhi*aY[tIdx-m+1] + aSinPhi*aY[tIdx+m-1]);
        }
        for (jint m = 1; m < L; ++m) {
            const jdouble tMul2 = 0.5*SQRT_LPM1_LMM[tIdx+m];
            rYPtheta[tIdx+m] += tMul2 * (aCosPhi*aY[tIdx+m+1] + aSinPhi*aY[tIdx-m-1]);
            rYPtheta[tIdx-m] += tMul2 * (aCosPhi*aY[tIdx-m-1] - aSinPhi*aY[tIdx+m+1]);
        }
        return;
    }}
}
template <jint LMAX>
static void calYPphiPtheta(jdouble *rYPphi, jdouble aCosPhi, jdouble aSinPhi, jdouble *rYPtheta, jdouble *aY) noexcept {
    calYPphi<0>(rYPphi, aY); calYPtheta<0>(aCosPhi, aSinPhi, rYPtheta, aY);
    if (LMAX == 0) return;
    calYPphi<1>(rYPphi, aY); calYPtheta<1>(aCosPhi, aSinPhi, rYPtheta, aY);
    if (LMAX == 1) return;
    calYPphi<2>(rYPphi, aY); calYPtheta<2>(aCosPhi, aSinPhi, rYPtheta, aY);
    if (LMAX == 2) return;
    calYPphi<3>(rYPphi, aY); calYPtheta<3>(aCosPhi, aSinPhi, rYPtheta, aY);
    if (LMAX == 3) return;
    calYPphi<4>(rYPphi, aY); calYPtheta<4>(aCosPhi, aSinPhi, rYPtheta, aY);
    if (LMAX == 4) return;
    calYPphi<5>(rYPphi, aY); calYPtheta<5>(aCosPhi, aSinPhi, rYPtheta, aY);
    if (LMAX == 5) return;
    calYPphi<6>(rYPphi, aY); calYPtheta<6>(aCosPhi, aSinPhi, rYPtheta, aY);
    if (LMAX == 6) return;
    calYPphi<7>(rYPphi, aY); calYPtheta<7>(aCosPhi, aSinPhi, rYPtheta, aY);
    if (LMAX == 7) return;
    calYPphi<8>(rYPphi, aY); calYPtheta<8>(aCosPhi, aSinPhi, rYPtheta, aY);
    if (LMAX == 8) return;
    calYPphi<9>(rYPphi, aY); calYPtheta<9>(aCosPhi, aSinPhi, rYPtheta, aY);
    if (LMAX == 9) return;
    calYPphi<10>(rYPphi, aY); calYPtheta<10>(aCosPhi, aSinPhi, rYPtheta, aY);
    if (LMAX == 10) return;
    calYPphi<11>(rYPphi, aY); calYPtheta<11>(aCosPhi, aSinPhi, rYPtheta, aY);
    if (LMAX == 11) return;
    calYPphi<12>(rYPphi, aY); calYPtheta<12>(aCosPhi, aSinPhi, rYPtheta, aY);
}
template <jint N>
static inline void convertYPPhiPtheta2YPxyz(jdouble aCosTheta, jdouble aSinTheta, jdouble aCosPhi, jdouble aSinPhi, jdouble aDis, jdouble aDxy, jboolean aDxyCloseZero,
                                            jdouble *rYPx, jdouble *rYPy, jdouble *rYPz, jdouble *aYPtheta, jdouble *aYPphi) noexcept {
    const jdouble thetaPx = -aCosTheta * aCosPhi / aDis;
    const jdouble thetaPy = -aCosTheta * aSinPhi / aDis;
    const jdouble thetaPz =  aSinTheta / aDis;
    const jdouble phiPx = aDxyCloseZero ? 0.0 :  aSinPhi / aDxy;
    const jdouble phiPy = aDxyCloseZero ? 0.0 : -aCosPhi / aDxy;
    for (jint i = 0; i < N; ++i) {
        const jdouble tYPtheta = aYPtheta[i];
        const jdouble tYPphi = aYPphi[i];
        rYPx[i] = tYPtheta*thetaPx + tYPphi*phiPx;
        rYPy[i] = tYPtheta*thetaPy + tYPphi*phiPy;
        rYPz[i] = tYPtheta*thetaPz;
    }
}
template <jint LMAX, jint LMALL>
static inline void calYPxyz(jdouble *aY, jdouble aDx, jdouble aDy, jdouble aDz, jdouble aDis,
                            jdouble *rYPx, jdouble *rYPy, jdouble *rYPz, jdouble *rYPtheta, jdouble *rYPphi) noexcept {
    const jdouble dxy = hypot(aDx, aDy);
    const jdouble cosTheta = aDz / aDis;
    const jdouble sinTheta = dxy / aDis;
    jdouble cosPhi;
    jdouble sinPhi;
    const jboolean dxyCloseZero = JSE_NNAP::numericEqual(dxy, 0.0);
    if (dxyCloseZero) {
        cosPhi = 1.0;
        sinPhi = 0.0;
    } else {
        cosPhi = aDx / dxy;
        sinPhi = aDy / dxy;
    }
    calYPphiPtheta<LMAX>(rYPphi, cosPhi, sinPhi, rYPtheta, aY);
    if (dxyCloseZero) {
        // fix singularity
        for (jint k = 0; k < LMALL; ++k) rYPphi[k] = 0.0;
    }
    // conert to Pxyz
    convertYPPhiPtheta2YPxyz<LMALL>(cosTheta, sinTheta, cosPhi, sinPhi, aDis, dxy, dxyCloseZero,
                                    rYPx, rYPy, rYPz, rYPtheta, rYPphi);
}

template <jint L>
static inline void calGradL2Sub_(jdouble *aCnlm, jdouble *rGradCnlm, jdouble *aNNGrad) noexcept {
    constexpr jint tStart = L*L;
    constexpr jint tLen = L+L+1;
    constexpr jint tEnd = tStart+tLen;
    constexpr jdouble tMul = 2.0 * PI4/(jdouble)tLen;
    jdouble subNNGrad = aNNGrad[L-1];
    for (jint i = tStart; i < tEnd; ++i) {
        rGradCnlm[i] += tMul * aCnlm[i] * subNNGrad;
    }
}
template <jint LMAX, jboolean NO_RADIAL>
static void calGradL2_(jdouble *aCnlm, jdouble *rGradCnlm, jdouble *aNNGrad) noexcept {
    // l = 0
    jdouble *tNNGrad = aNNGrad;
    if (!NO_RADIAL) {
        rGradCnlm[0] += (PI4+PI4) * aCnlm[0] * tNNGrad[0];
        ++tNNGrad;
    }
    if (LMAX == 0) return;
    calGradL2Sub_<1>(aCnlm, rGradCnlm, tNNGrad);
    if (LMAX == 1) return;
    calGradL2Sub_<2>(aCnlm, rGradCnlm, tNNGrad);
    if (LMAX == 2) return;
    calGradL2Sub_<3>(aCnlm, rGradCnlm, tNNGrad);
    if (LMAX == 3) return;
    calGradL2Sub_<4>(aCnlm, rGradCnlm, tNNGrad);
    if (LMAX == 4) return;
    calGradL2Sub_<5>(aCnlm, rGradCnlm, tNNGrad);
    if (LMAX == 5) return;
    calGradL2Sub_<6>(aCnlm, rGradCnlm, tNNGrad);
    if (LMAX == 6) return;
    calGradL2Sub_<7>(aCnlm, rGradCnlm, tNNGrad);
    if (LMAX == 7) return;
    calGradL2Sub_<8>(aCnlm, rGradCnlm, tNNGrad);
    if (LMAX == 8) return;
    calGradL2Sub_<9>(aCnlm, rGradCnlm, tNNGrad);
    if (LMAX == 9) return;
    calGradL2Sub_<10>(aCnlm, rGradCnlm, tNNGrad);
    if (LMAX == 10) return;
    calGradL2Sub_<11>(aCnlm, rGradCnlm, tNNGrad);
    if (LMAX == 11) return;
    calGradL2Sub_<12>(aCnlm, rGradCnlm, tNNGrad);
}
static void calGradL3_222_(jdouble *aCnlm, jdouble *rGradCnlm, jdouble aSubNNGrad) noexcept {
    constexpr jint s2 = 2*2+2;
    for (jint i = 0; i < L3_SIZE_222; ++i) {
        const jint m1 = L3_INDEX_222[i][0];
        const jint m2 = L3_INDEX_222[i][1];
        const jint m3 = L3_INDEX_222[i][2];
        const jdouble tMul = L3_COEFF_222[i] * aSubNNGrad;
        rGradCnlm[s2+m1] += tMul * aCnlm[s2+m2]*aCnlm[s2+m3];
        rGradCnlm[s2+m2] += tMul * aCnlm[s2+m1]*aCnlm[s2+m3];
        rGradCnlm[s2+m3] += tMul * aCnlm[s2+m1]*aCnlm[s2+m2];
    }
}
static void calGradL3_112_(jdouble *aCnlm, jdouble *rGradCnlm, jdouble aSubNNGrad) noexcept {
    constexpr jint s1 = 1+1;
    constexpr jint s2 = 2*2+2;
    for (jint i = 0; i < L3_SIZE_112; ++i) {
        const jint m1 = L3_INDEX_112[i][0];
        const jint m2 = L3_INDEX_112[i][1];
        const jint m3 = L3_INDEX_112[i][2];
        const jdouble tMul = L3_COEFF_112[i] * aSubNNGrad;
        rGradCnlm[s1+m1] += tMul * aCnlm[s1+m2]*aCnlm[s2+m3];
        rGradCnlm[s1+m2] += tMul * aCnlm[s1+m1]*aCnlm[s2+m3];
        rGradCnlm[s2+m3] += tMul * aCnlm[s1+m1]*aCnlm[s1+m2];
    }
}
static void calGradL3_233_(jdouble *aCnlm, jdouble *rGradCnlm, jdouble aSubNNGrad) noexcept {
    constexpr jint s2 = 2*2+2;
    constexpr jint s3 = 3*3+3;
    for (jint i = 0; i < L3_SIZE_233; ++i) {
        const jint m1 = L3_INDEX_233[i][0];
        const jint m2 = L3_INDEX_233[i][1];
        const jint m3 = L3_INDEX_233[i][2];
        const jdouble tMul = L3_COEFF_233[i] * aSubNNGrad;
        rGradCnlm[s2+m1] += tMul * aCnlm[s3+m2]*aCnlm[s3+m3];
        rGradCnlm[s3+m2] += tMul * aCnlm[s2+m1]*aCnlm[s3+m3];
        rGradCnlm[s3+m3] += tMul * aCnlm[s2+m1]*aCnlm[s3+m2];
    }
}
static void calGradL3_123_(jdouble *aCnlm, jdouble *rGradCnlm, jdouble aSubNNGrad) noexcept {
    constexpr jint s1 = 1+1;
    constexpr jint s2 = 2*2+2;
    constexpr jint s3 = 3*3+3;
    for (jint i = 0; i < L3_SIZE_123; ++i) {
        const jint m1 = L3_INDEX_123[i][0];
        const jint m2 = L3_INDEX_123[i][1];
        const jint m3 = L3_INDEX_123[i][2];
        const jdouble tMul = L3_COEFF_123[i] * aSubNNGrad;
        rGradCnlm[s1+m1] += tMul * aCnlm[s2+m2]*aCnlm[s3+m3];
        rGradCnlm[s2+m2] += tMul * aCnlm[s1+m1]*aCnlm[s3+m3];
        rGradCnlm[s3+m3] += tMul * aCnlm[s1+m1]*aCnlm[s2+m2];
    }
}
static void calGradL3_444_(jdouble *aCnlm, jdouble *rGradCnlm, jdouble aSubNNGrad) noexcept {
    constexpr jint s4 = 4*4+4;
    for (jint i = 0; i < L3_SIZE_444; ++i) {
        const jint m1 = L3_INDEX_444[i][0];
        const jint m2 = L3_INDEX_444[i][1];
        const jint m3 = L3_INDEX_444[i][2];
        const jdouble tMul = L3_COEFF_444[i] * aSubNNGrad;
        rGradCnlm[s4+m1] += tMul * aCnlm[s4+m2]*aCnlm[s4+m3];
        rGradCnlm[s4+m2] += tMul * aCnlm[s4+m1]*aCnlm[s4+m3];
        rGradCnlm[s4+m3] += tMul * aCnlm[s4+m1]*aCnlm[s4+m2];
    }
}
static void calGradL3_224_(jdouble *aCnlm, jdouble *rGradCnlm, jdouble aSubNNGrad) noexcept {
    constexpr jint s2 = 2*2+2;
    constexpr jint s4 = 4*4+4;
    for (jint i = 0; i < L3_SIZE_224; ++i) {
        const jint m1 = L3_INDEX_224[i][0];
        const jint m2 = L3_INDEX_224[i][1];
        const jint m3 = L3_INDEX_224[i][2];
        const jdouble tMul = L3_COEFF_224[i] * aSubNNGrad;
        rGradCnlm[s2+m1] += tMul * aCnlm[s2+m2]*aCnlm[s4+m3];
        rGradCnlm[s2+m2] += tMul * aCnlm[s2+m1]*aCnlm[s4+m3];
        rGradCnlm[s4+m3] += tMul * aCnlm[s2+m1]*aCnlm[s2+m2];
    }
}
static void calGradL3_334_(jdouble *aCnlm, jdouble *rGradCnlm, jdouble aSubNNGrad) noexcept {
    constexpr jint s3 = 3*3+3;
    constexpr jint s4 = 4*4+4;
    for (jint i = 0; i < L3_SIZE_334; ++i) {
        const jint m1 = L3_INDEX_334[i][0];
        const jint m2 = L3_INDEX_334[i][1];
        const jint m3 = L3_INDEX_334[i][2];
        const jdouble tMul = L3_COEFF_334[i] * aSubNNGrad;
        rGradCnlm[s3+m1] += tMul * aCnlm[s3+m2]*aCnlm[s4+m3];
        rGradCnlm[s3+m2] += tMul * aCnlm[s3+m1]*aCnlm[s4+m3];
        rGradCnlm[s4+m3] += tMul * aCnlm[s3+m1]*aCnlm[s3+m2];
    }
}
static void calGradL3_244_(jdouble *aCnlm, jdouble *rGradCnlm, jdouble aSubNNGrad) noexcept {
    constexpr jint s2 = 2*2+2;
    constexpr jint s4 = 4*4+4;
    for (jint i = 0; i < L3_SIZE_244; ++i) {
        const jint m1 = L3_INDEX_244[i][0];
        const jint m2 = L3_INDEX_244[i][1];
        const jint m3 = L3_INDEX_244[i][2];
        const jdouble tMul = L3_COEFF_244[i] * aSubNNGrad;
        rGradCnlm[s2+m1] += tMul * aCnlm[s4+m2]*aCnlm[s4+m3];
        rGradCnlm[s4+m2] += tMul * aCnlm[s2+m1]*aCnlm[s4+m3];
        rGradCnlm[s4+m3] += tMul * aCnlm[s2+m1]*aCnlm[s4+m2];
    }
}
static void calGradL3_134_(jdouble *aCnlm, jdouble *rGradCnlm, jdouble aSubNNGrad) noexcept {
    constexpr jint s1 = 1+1;
    constexpr jint s3 = 3*3+3;
    constexpr jint s4 = 4*4+4;
    for (jint i = 0; i < L3_SIZE_134; ++i) {
        const jint m1 = L3_INDEX_134[i][0];
        const jint m2 = L3_INDEX_134[i][1];
        const jint m3 = L3_INDEX_134[i][2];
        const jdouble tMul = L3_COEFF_134[i] * aSubNNGrad;
        rGradCnlm[s1+m1] += tMul * aCnlm[s3+m2]*aCnlm[s4+m3];
        rGradCnlm[s3+m2] += tMul * aCnlm[s1+m1]*aCnlm[s4+m3];
        rGradCnlm[s4+m3] += tMul * aCnlm[s1+m1]*aCnlm[s3+m2];
    }
}
template <jint L3MAX, jboolean L3CROSS>
static void calGradL3_(jdouble *aCnlm, jdouble *rGradCnlm, jdouble *aNNGrad) noexcept {
    if (L3MAX <= 1) return;
    calGradL3_222_(aCnlm, rGradCnlm, *aNNGrad); ++aNNGrad;
    if (L3CROSS) {
        calGradL3_112_(aCnlm, rGradCnlm, *aNNGrad); ++aNNGrad;
    }
    if (L3MAX == 2) return;
    if (L3CROSS) {
        calGradL3_233_(aCnlm, rGradCnlm, *aNNGrad); ++aNNGrad;
        calGradL3_123_(aCnlm, rGradCnlm, *aNNGrad); ++aNNGrad;
    }
    if (L3MAX == 3) return;
    calGradL3_444_(aCnlm, rGradCnlm, *aNNGrad); ++aNNGrad;
    if (L3CROSS) {
        calGradL3_224_(aCnlm, rGradCnlm, *aNNGrad); ++aNNGrad;
        calGradL3_334_(aCnlm, rGradCnlm, *aNNGrad); ++aNNGrad;
        calGradL3_244_(aCnlm, rGradCnlm, *aNNGrad); ++aNNGrad;
        calGradL3_134_(aCnlm, rGradCnlm, *aNNGrad); ++aNNGrad;
    }
}

template <jint L>
static inline void calGradNNGradL2Sub_(jdouble *aCnlm, jdouble *aGradNNGradCnlm, jdouble *rGradNNGrad) noexcept {
    constexpr jint tStart = L*L;
    constexpr jint tLen = L+L+1;
    const jdouble rDot = JSE_NNAP::dot<tLen>(aCnlm+tStart, aGradNNGradCnlm+tStart);
    rGradNNGrad[L-1] = (2.0 * PI4/(jdouble)tLen) * rDot;
}
template <jint LMAX, jboolean NO_RADIAL>
static void calGradNNGradL2_(jdouble *aCnlm, jdouble *aGradNNGradCnlm, jdouble *rGradNNGrad) noexcept {
    // l = 0
    jdouble *tGradNNGrad = rGradNNGrad;
    if (!NO_RADIAL) {
        tGradNNGrad[0] += (PI4+PI4) * aCnlm[0] * aGradNNGradCnlm[0];
        ++tGradNNGrad;
    }
    if (LMAX == 0) return;
    calGradNNGradL2Sub_<1>(aCnlm, aGradNNGradCnlm, tGradNNGrad);
    if (LMAX == 1) return;
    calGradNNGradL2Sub_<2>(aCnlm, aGradNNGradCnlm, tGradNNGrad);
    if (LMAX == 2) return;
    calGradNNGradL2Sub_<3>(aCnlm, aGradNNGradCnlm, tGradNNGrad);
    if (LMAX == 3) return;
    calGradNNGradL2Sub_<4>(aCnlm, aGradNNGradCnlm, tGradNNGrad);
    if (LMAX == 4) return;
    calGradNNGradL2Sub_<5>(aCnlm, aGradNNGradCnlm, tGradNNGrad);
    if (LMAX == 5) return;
    calGradNNGradL2Sub_<6>(aCnlm, aGradNNGradCnlm, tGradNNGrad);
    if (LMAX == 6) return;
    calGradNNGradL2Sub_<7>(aCnlm, aGradNNGradCnlm, tGradNNGrad);
    if (LMAX == 7) return;
    calGradNNGradL2Sub_<8>(aCnlm, aGradNNGradCnlm, tGradNNGrad);
    if (LMAX == 8) return;
    calGradNNGradL2Sub_<9>(aCnlm, aGradNNGradCnlm, tGradNNGrad);
    if (LMAX == 9) return;
    calGradNNGradL2Sub_<10>(aCnlm, aGradNNGradCnlm, tGradNNGrad);
    if (LMAX == 10) return;
    calGradNNGradL2Sub_<11>(aCnlm, aGradNNGradCnlm, tGradNNGrad);
    if (LMAX == 11) return;
    calGradNNGradL2Sub_<12>(aCnlm, aGradNNGradCnlm, tGradNNGrad);
}
static jdouble calGradNNGradL3_222_(jdouble *aCnlm, jdouble *aGradNNGradCnlm) noexcept {
    jdouble rGGFp3 = 0.0;
    constexpr jint s2 = 2*2+2;
    for (jint i = 0; i < L3_SIZE_222; ++i) {
        const jint m1 = L3_INDEX_222[i][0];
        const jint m2 = L3_INDEX_222[i][1];
        const jint m3 = L3_INDEX_222[i][2];
        rGGFp3 += L3_COEFF_222[i] * aGradNNGradCnlm[s2+m1]*aCnlm[s2+m2]*aCnlm[s2+m3];
        rGGFp3 += L3_COEFF_222[i] * aCnlm[s2+m1]*aGradNNGradCnlm[s2+m2]*aCnlm[s2+m3];
        rGGFp3 += L3_COEFF_222[i] * aCnlm[s2+m1]*aCnlm[s2+m2]*aGradNNGradCnlm[s2+m3];
    }
    return rGGFp3;
}
static jdouble calGradNNGradL3_112_(jdouble *aCnlm, jdouble *aGradNNGradCnlm) noexcept {
    jdouble rGGFp3 = 0.0;
    constexpr jint s1 = 1+1;
    constexpr jint s2 = 2*2+2;
    for (jint i = 0; i < L3_SIZE_112; ++i) {
        const jint m1 = L3_INDEX_112[i][0];
        const jint m2 = L3_INDEX_112[i][1];
        const jint m3 = L3_INDEX_112[i][2];
        rGGFp3 += L3_COEFF_112[i] * aGradNNGradCnlm[s1+m1]*aCnlm[s1+m2]*aCnlm[s2+m3];
        rGGFp3 += L3_COEFF_112[i] * aCnlm[s1+m1]*aGradNNGradCnlm[s1+m2]*aCnlm[s2+m3];
        rGGFp3 += L3_COEFF_112[i] * aCnlm[s1+m1]*aCnlm[s1+m2]*aGradNNGradCnlm[s2+m3];
    }
    return rGGFp3;
}
static jdouble calGradNNGradL3_233_(jdouble *aCnlm, jdouble *aGradNNGradCnlm) noexcept {
    jdouble rGGFp3 = 0.0;
    constexpr jint s2 = 2*2+2;
    constexpr jint s3 = 3*3+3;
    for (jint i = 0; i < L3_SIZE_233; ++i) {
        const jint m1 = L3_INDEX_233[i][0];
        const jint m2 = L3_INDEX_233[i][1];
        const jint m3 = L3_INDEX_233[i][2];
        rGGFp3 += L3_COEFF_233[i] * aGradNNGradCnlm[s2+m1]*aCnlm[s3+m2]*aCnlm[s3+m3];
        rGGFp3 += L3_COEFF_233[i] * aCnlm[s2+m1]*aGradNNGradCnlm[s3+m2]*aCnlm[s3+m3];
        rGGFp3 += L3_COEFF_233[i] * aCnlm[s2+m1]*aCnlm[s3+m2]*aGradNNGradCnlm[s3+m3];
    }
    return rGGFp3;
}
static jdouble calGradNNGradL3_123_(jdouble *aCnlm, jdouble *aGradNNGradCnlm) noexcept {
    jdouble rGGFp3 = 0.0;
    constexpr jint s1 = 1+1;
    constexpr jint s2 = 2*2+2;
    constexpr jint s3 = 3*3+3;
    for (jint i = 0; i < L3_SIZE_123; ++i) {
        const jint m1 = L3_INDEX_123[i][0];
        const jint m2 = L3_INDEX_123[i][1];
        const jint m3 = L3_INDEX_123[i][2];
        rGGFp3 += L3_COEFF_123[i] * aGradNNGradCnlm[s1+m1]*aCnlm[s2+m2]*aCnlm[s3+m3];
        rGGFp3 += L3_COEFF_123[i] * aCnlm[s1+m1]*aGradNNGradCnlm[s2+m2]*aCnlm[s3+m3];
        rGGFp3 += L3_COEFF_123[i] * aCnlm[s1+m1]*aCnlm[s2+m2]*aGradNNGradCnlm[s3+m3];
    }
    return rGGFp3;
}
static jdouble calGradNNGradL3_444_(jdouble *aCnlm, jdouble *aGradNNGradCnlm) noexcept {
    jdouble rGGFp3 = 0.0;
    constexpr jint s4 = 4*4+4;
    for (jint i = 0; i < L3_SIZE_444; ++i) {
        const jint m1 = L3_INDEX_444[i][0];
        const jint m2 = L3_INDEX_444[i][1];
        const jint m3 = L3_INDEX_444[i][2];
        rGGFp3 += L3_COEFF_444[i] * aGradNNGradCnlm[s4+m1]*aCnlm[s4+m2]*aCnlm[s4+m3];
        rGGFp3 += L3_COEFF_444[i] * aCnlm[s4+m1]*aGradNNGradCnlm[s4+m2]*aCnlm[s4+m3];
        rGGFp3 += L3_COEFF_444[i] * aCnlm[s4+m1]*aCnlm[s4+m2]*aGradNNGradCnlm[s4+m3];
    }
    return rGGFp3;
}
static jdouble calGradNNGradL3_224_(jdouble *aCnlm, jdouble *aGradNNGradCnlm) noexcept {
    jdouble rGGFp3 = 0.0;
    constexpr jint s2 = 2*2+2;
    constexpr jint s4 = 4*4+4;
    for (jint i = 0; i < L3_SIZE_224; ++i) {
        const jint m1 = L3_INDEX_224[i][0];
        const jint m2 = L3_INDEX_224[i][1];
        const jint m3 = L3_INDEX_224[i][2];
        rGGFp3 += L3_COEFF_224[i] * aGradNNGradCnlm[s2+m1]*aCnlm[s2+m2]*aCnlm[s4+m3];
        rGGFp3 += L3_COEFF_224[i] * aCnlm[s2+m1]*aGradNNGradCnlm[s2+m2]*aCnlm[s4+m3];
        rGGFp3 += L3_COEFF_224[i] * aCnlm[s2+m1]*aCnlm[s2+m2]*aGradNNGradCnlm[s4+m3];
    }
    return rGGFp3;
}
static jdouble calGradNNGradL3_334_(jdouble *aCnlm, jdouble *aGradNNGradCnlm) noexcept {
    jdouble rGGFp3 = 0.0;
    constexpr jint s3 = 3*3+3;
    constexpr jint s4 = 4*4+4;
    for (jint i = 0; i < L3_SIZE_334; ++i) {
        const jint m1 = L3_INDEX_334[i][0];
        const jint m2 = L3_INDEX_334[i][1];
        const jint m3 = L3_INDEX_334[i][2];
        rGGFp3 += L3_COEFF_334[i] * aGradNNGradCnlm[s3+m1]*aCnlm[s3+m2]*aCnlm[s4+m3];
        rGGFp3 += L3_COEFF_334[i] * aCnlm[s3+m1]*aGradNNGradCnlm[s3+m2]*aCnlm[s4+m3];
        rGGFp3 += L3_COEFF_334[i] * aCnlm[s3+m1]*aCnlm[s3+m2]*aGradNNGradCnlm[s4+m3];
    }
    return rGGFp3;
}
static jdouble calGradNNGradL3_244_(jdouble *aCnlm, jdouble *aGradNNGradCnlm) noexcept {
    jdouble rGGFp3 = 0.0;
    constexpr jint s2 = 2*2+2;
    constexpr jint s4 = 4*4+4;
    for (jint i = 0; i < L3_SIZE_244; ++i) {
        const jint m1 = L3_INDEX_244[i][0];
        const jint m2 = L3_INDEX_244[i][1];
        const jint m3 = L3_INDEX_244[i][2];
        rGGFp3 += L3_COEFF_244[i] * aGradNNGradCnlm[s2+m1]*aCnlm[s4+m2]*aCnlm[s4+m3];
        rGGFp3 += L3_COEFF_244[i] * aCnlm[s2+m1]*aGradNNGradCnlm[s4+m2]*aCnlm[s4+m3];
        rGGFp3 += L3_COEFF_244[i] * aCnlm[s2+m1]*aCnlm[s4+m2]*aGradNNGradCnlm[s4+m3];
    }
    return rGGFp3;
}
static jdouble calGradNNGradL3_134_(jdouble *aCnlm, jdouble *aGradNNGradCnlm) noexcept {
    jdouble rGGFp3 = 0.0;
    constexpr jint s1 = 1+1;
    constexpr jint s3 = 3*3+3;
    constexpr jint s4 = 4*4+4;
    for (jint i = 0; i < L3_SIZE_134; ++i) {
        const jint m1 = L3_INDEX_134[i][0];
        const jint m2 = L3_INDEX_134[i][1];
        const jint m3 = L3_INDEX_134[i][2];
        rGGFp3 += L3_COEFF_134[i] * aGradNNGradCnlm[s1+m1]*aCnlm[s3+m2]*aCnlm[s4+m3];
        rGGFp3 += L3_COEFF_134[i] * aCnlm[s1+m1]*aGradNNGradCnlm[s3+m2]*aCnlm[s4+m3];
        rGGFp3 += L3_COEFF_134[i] * aCnlm[s1+m1]*aCnlm[s3+m2]*aGradNNGradCnlm[s4+m3];
    }
    return rGGFp3;
}
template <jint L3MAX, jboolean L3CROSS>
static void calGradNNGradL3_(jdouble *aCnlm, jdouble *aGradNNGradCnlm, jdouble *rGradNNGrad) noexcept {
    if (L3MAX <= 1) return;
    *rGradNNGrad += calGradNNGradL3_222_(aCnlm, aGradNNGradCnlm); ++rGradNNGrad;
    if (L3CROSS) {
        *rGradNNGrad += calGradNNGradL3_112_(aCnlm, aGradNNGradCnlm); ++rGradNNGrad;
    }
    if (L3MAX == 2) return;
    if (L3CROSS) {
        *rGradNNGrad += calGradNNGradL3_233_(aCnlm, aGradNNGradCnlm); ++rGradNNGrad;
        *rGradNNGrad += calGradNNGradL3_123_(aCnlm, aGradNNGradCnlm); ++rGradNNGrad;
    }
    if (L3MAX == 3) return;
    *rGradNNGrad += calGradNNGradL3_444_(aCnlm, aGradNNGradCnlm); ++rGradNNGrad;
    if (L3CROSS) {
        *rGradNNGrad += calGradNNGradL3_224_(aCnlm, aGradNNGradCnlm); ++rGradNNGrad;
        *rGradNNGrad += calGradNNGradL3_334_(aCnlm, aGradNNGradCnlm); ++rGradNNGrad;
        *rGradNNGrad += calGradNNGradL3_244_(aCnlm, aGradNNGradCnlm); ++rGradNNGrad;
        *rGradNNGrad += calGradNNGradL3_134_(aCnlm, aGradNNGradCnlm); ++rGradNNGrad;
    }
}

template <jint LMAX, jboolean NO_RADIAL>
static void calGradCnlmL2_(jdouble *rGradCnlm, jdouble *aGradNNGradCnlm, jdouble *aNNGrad) noexcept {
    calGradL2_<LMAX, NO_RADIAL>(aGradNNGradCnlm, rGradCnlm, aNNGrad);
}
static void calGradCnlmL3_222_(jdouble *aCnlm, jdouble *rGradCnlm, jdouble *aGradNNGradCnlm, jdouble aSubNNGrad) noexcept {
    constexpr jint s2 = 2*2+2;
    for (jint i = 0; i < L3_SIZE_222; ++i) {
        const jint m1 = L3_INDEX_222[i][0];
        const jint m2 = L3_INDEX_222[i][1];
        const jint m3 = L3_INDEX_222[i][2];
        const jdouble tMul = L3_COEFF_222[i] * aSubNNGrad;
        rGradCnlm[s2+m1] += tMul * (aGradNNGradCnlm[s2+m2]*aCnlm[s2+m3] + aCnlm[s2+m2]*aGradNNGradCnlm[s2+m3]);
        rGradCnlm[s2+m2] += tMul * (aGradNNGradCnlm[s2+m1]*aCnlm[s2+m3] + aCnlm[s2+m1]*aGradNNGradCnlm[s2+m3]);
        rGradCnlm[s2+m3] += tMul * (aGradNNGradCnlm[s2+m1]*aCnlm[s2+m2] + aCnlm[s2+m1]*aGradNNGradCnlm[s2+m2]);
    }
}
static void calGradCnlmL3_112_(jdouble *aCnlm, jdouble *rGradCnlm, jdouble *aGradNNGradCnlm, jdouble aSubNNGrad) noexcept {
    constexpr jint s1 = 1+1;
    constexpr jint s2 = 2*2+2;
    for (jint i = 0; i < L3_SIZE_112; ++i) {
        const jint m1 = L3_INDEX_112[i][0];
        const jint m2 = L3_INDEX_112[i][1];
        const jint m3 = L3_INDEX_112[i][2];
        const jdouble tMul = L3_COEFF_112[i] * aSubNNGrad;
        rGradCnlm[s1+m1] += tMul * (aGradNNGradCnlm[s1+m2]*aCnlm[s2+m3] + aCnlm[s1+m2]*aGradNNGradCnlm[s2+m3]);
        rGradCnlm[s1+m2] += tMul * (aGradNNGradCnlm[s1+m1]*aCnlm[s2+m3] + aCnlm[s1+m1]*aGradNNGradCnlm[s2+m3]);
        rGradCnlm[s2+m3] += tMul * (aGradNNGradCnlm[s1+m1]*aCnlm[s1+m2] + aCnlm[s1+m1]*aGradNNGradCnlm[s1+m2]);
    }
}
static void calGradCnlmL3_233_(jdouble *aCnlm, jdouble *rGradCnlm, jdouble *aGradNNGradCnlm, jdouble aSubNNGrad) noexcept {
    constexpr jint s2 = 2*2+2;
    constexpr jint s3 = 3*3+3;
    for (jint i = 0; i < L3_SIZE_233; ++i) {
        const jint m1 = L3_INDEX_233[i][0];
        const jint m2 = L3_INDEX_233[i][1];
        const jint m3 = L3_INDEX_233[i][2];
        const jdouble tMul = L3_COEFF_233[i] * aSubNNGrad;
        rGradCnlm[s2+m1] += tMul * (aGradNNGradCnlm[s3+m2]*aCnlm[s3+m3] + aCnlm[s3+m2]*aGradNNGradCnlm[s3+m3]);
        rGradCnlm[s3+m2] += tMul * (aGradNNGradCnlm[s2+m1]*aCnlm[s3+m3] + aCnlm[s2+m1]*aGradNNGradCnlm[s3+m3]);
        rGradCnlm[s3+m3] += tMul * (aGradNNGradCnlm[s2+m1]*aCnlm[s3+m2] + aCnlm[s2+m1]*aGradNNGradCnlm[s3+m2]);
    }
}
static void calGradCnlmL3_123_(jdouble *aCnlm, jdouble *rGradCnlm, jdouble *aGradNNGradCnlm, jdouble aSubNNGrad) noexcept {
    constexpr jint s1 = 1+1;
    constexpr jint s2 = 2*2+2;
    constexpr jint s3 = 3*3+3;
    for (jint i = 0; i < L3_SIZE_123; ++i) {
        const jint m1 = L3_INDEX_123[i][0];
        const jint m2 = L3_INDEX_123[i][1];
        const jint m3 = L3_INDEX_123[i][2];
        const jdouble tMul = L3_COEFF_123[i] * aSubNNGrad;
        rGradCnlm[s1+m1] += tMul * (aGradNNGradCnlm[s2+m2]*aCnlm[s3+m3] + aCnlm[s2+m2]*aGradNNGradCnlm[s3+m3]);
        rGradCnlm[s2+m2] += tMul * (aGradNNGradCnlm[s1+m1]*aCnlm[s3+m3] + aCnlm[s1+m1]*aGradNNGradCnlm[s3+m3]);
        rGradCnlm[s3+m3] += tMul * (aGradNNGradCnlm[s1+m1]*aCnlm[s2+m2] + aCnlm[s1+m1]*aGradNNGradCnlm[s2+m2]);
    }
}
static void calGradCnlmL3_444_(jdouble *aCnlm, jdouble *rGradCnlm, jdouble *aGradNNGradCnlm, jdouble aSubNNGrad) noexcept {
    constexpr jint s4 = 4*4+4;
    for (jint i = 0; i < L3_SIZE_444; ++i) {
        const jint m1 = L3_INDEX_444[i][0];
        const jint m2 = L3_INDEX_444[i][1];
        const jint m3 = L3_INDEX_444[i][2];
        const jdouble tMul = L3_COEFF_444[i] * aSubNNGrad;
        rGradCnlm[s4+m1] += tMul * (aGradNNGradCnlm[s4+m2]*aCnlm[s4+m3] + aCnlm[s4+m2]*aGradNNGradCnlm[s4+m3]);
        rGradCnlm[s4+m2] += tMul * (aGradNNGradCnlm[s4+m1]*aCnlm[s4+m3] + aCnlm[s4+m1]*aGradNNGradCnlm[s4+m3]);
        rGradCnlm[s4+m3] += tMul * (aGradNNGradCnlm[s4+m1]*aCnlm[s4+m2] + aCnlm[s4+m1]*aGradNNGradCnlm[s4+m2]);
    }
}
static void calGradCnlmL3_224_(jdouble *aCnlm, jdouble *rGradCnlm, jdouble *aGradNNGradCnlm, jdouble aSubNNGrad) noexcept {
    constexpr jint s2 = 2*2+2;
    constexpr jint s4 = 4*4+4;
    for (jint i = 0; i < L3_SIZE_224; ++i) {
        const jint m1 = L3_INDEX_224[i][0];
        const jint m2 = L3_INDEX_224[i][1];
        const jint m3 = L3_INDEX_224[i][2];
        const jdouble tMul = L3_COEFF_224[i] * aSubNNGrad;
        rGradCnlm[s2+m1] += tMul * (aGradNNGradCnlm[s2+m2]*aCnlm[s4+m3] + aCnlm[s2+m2]*aGradNNGradCnlm[s4+m3]);
        rGradCnlm[s2+m2] += tMul * (aGradNNGradCnlm[s2+m1]*aCnlm[s4+m3] + aCnlm[s2+m1]*aGradNNGradCnlm[s4+m3]);
        rGradCnlm[s4+m3] += tMul * (aGradNNGradCnlm[s2+m1]*aCnlm[s2+m2] + aCnlm[s2+m1]*aGradNNGradCnlm[s2+m2]);
    }
}
static void calGradCnlmL3_334_(jdouble *aCnlm, jdouble *rGradCnlm, jdouble *aGradNNGradCnlm, jdouble aSubNNGrad) noexcept {
    constexpr jint s3 = 3*3+3;
    constexpr jint s4 = 4*4+4;
    for (jint i = 0; i < L3_SIZE_334; ++i) {
        const jint m1 = L3_INDEX_334[i][0];
        const jint m2 = L3_INDEX_334[i][1];
        const jint m3 = L3_INDEX_334[i][2];
        const jdouble tMul = L3_COEFF_334[i] * aSubNNGrad;
        rGradCnlm[s3+m1] += tMul * (aGradNNGradCnlm[s3+m2]*aCnlm[s4+m3] + aCnlm[s3+m2]*aGradNNGradCnlm[s4+m3]);
        rGradCnlm[s3+m2] += tMul * (aGradNNGradCnlm[s3+m1]*aCnlm[s4+m3] + aCnlm[s3+m1]*aGradNNGradCnlm[s4+m3]);
        rGradCnlm[s4+m3] += tMul * (aGradNNGradCnlm[s3+m1]*aCnlm[s3+m2] + aCnlm[s3+m1]*aGradNNGradCnlm[s3+m2]);
    }
}
static void calGradCnlmL3_244_(jdouble *aCnlm, jdouble *rGradCnlm, jdouble *aGradNNGradCnlm, jdouble aSubNNGrad) noexcept {
    constexpr jint s2 = 2*2+2;
    constexpr jint s4 = 4*4+4;
    for (jint i = 0; i < L3_SIZE_244; ++i) {
        const jint m1 = L3_INDEX_244[i][0];
        const jint m2 = L3_INDEX_244[i][1];
        const jint m3 = L3_INDEX_244[i][2];
        const jdouble tMul = L3_COEFF_244[i] * aSubNNGrad;
        rGradCnlm[s2+m1] += tMul * (aGradNNGradCnlm[s4+m2]*aCnlm[s4+m3] + aCnlm[s4+m2]*aGradNNGradCnlm[s4+m3]);
        rGradCnlm[s4+m2] += tMul * (aGradNNGradCnlm[s2+m1]*aCnlm[s4+m3] + aCnlm[s2+m1]*aGradNNGradCnlm[s4+m3]);
        rGradCnlm[s4+m3] += tMul * (aGradNNGradCnlm[s2+m1]*aCnlm[s4+m2] + aCnlm[s2+m1]*aGradNNGradCnlm[s4+m2]);
    }
}
static void calGradCnlmL3_134_(jdouble *aCnlm, jdouble *rGradCnlm, jdouble *aGradNNGradCnlm, jdouble aSubNNGrad) noexcept {
    constexpr jint s1 = 1+1;
    constexpr jint s3 = 3*3+3;
    constexpr jint s4 = 4*4+4;
    for (jint i = 0; i < L3_SIZE_134; ++i) {
        const jint m1 = L3_INDEX_134[i][0];
        const jint m2 = L3_INDEX_134[i][1];
        const jint m3 = L3_INDEX_134[i][2];
        const jdouble tMul = L3_COEFF_134[i] * aSubNNGrad;
        rGradCnlm[s1+m1] += tMul * (aGradNNGradCnlm[s3+m2]*aCnlm[s4+m3] + aCnlm[s3+m2]*aGradNNGradCnlm[s4+m3]);
        rGradCnlm[s3+m2] += tMul * (aGradNNGradCnlm[s1+m1]*aCnlm[s4+m3] + aCnlm[s1+m1]*aGradNNGradCnlm[s4+m3]);
        rGradCnlm[s4+m3] += tMul * (aGradNNGradCnlm[s1+m1]*aCnlm[s3+m2] + aCnlm[s1+m1]*aGradNNGradCnlm[s3+m2]);
    }
}
template <jint L3MAX, jboolean L3CROSS>
static void calGradCnlmL3_(jdouble *aCnlm, jdouble *rGradCnlm, jdouble *aGradNNGradCnlm, jdouble *aNNGrad) noexcept {
    if (L3MAX <= 1) return;
    calGradCnlmL3_222_(aCnlm, rGradCnlm, aGradNNGradCnlm, *aNNGrad); ++aNNGrad;
    if (L3CROSS) {
        calGradCnlmL3_112_(aCnlm, rGradCnlm, aGradNNGradCnlm, *aNNGrad); ++aNNGrad;
    }
    if (L3MAX == 2) return;
    if (L3CROSS) {
        calGradCnlmL3_233_(aCnlm, rGradCnlm, aGradNNGradCnlm, *aNNGrad); ++aNNGrad;
        calGradCnlmL3_123_(aCnlm, rGradCnlm, aGradNNGradCnlm, *aNNGrad); ++aNNGrad;
    }
    if (L3MAX == 3) return;
    calGradCnlmL3_444_(aCnlm, rGradCnlm, aGradNNGradCnlm, *aNNGrad); ++aNNGrad;
    if (L3CROSS) {
        calGradCnlmL3_224_(aCnlm, rGradCnlm, aGradNNGradCnlm, *aNNGrad); ++aNNGrad;
        calGradCnlmL3_334_(aCnlm, rGradCnlm, aGradNNGradCnlm, *aNNGrad); ++aNNGrad;
        calGradCnlmL3_244_(aCnlm, rGradCnlm, aGradNNGradCnlm, *aNNGrad); ++aNNGrad;
        calGradCnlmL3_134_(aCnlm, rGradCnlm, aGradNNGradCnlm, *aNNGrad); ++aNNGrad;
    }
}


template <jint LMAXMAX, jint LMALL, jint WTYPE, jboolean FULL_CACHE>
static void calCnlm(jdouble *aNlDx, jdouble *aNlDy, jdouble *aNlDz, jint *aNlType, jint aNN,
                    jdouble *rCnlm, jdouble *rForwardCache,
                    jint aTypeNum, jdouble aRCut, jint aNMax, jdouble *aFuseWeight, jint aFuseSize) noexcept {
    const jint tSizeBnlm = (aNMax+1)*LMALL;
    // init cache
    jdouble *rRn = NULL, *rY = NULL;
    jdouble *rBnlm = NULL;
    jdouble *rNlRn = NULL, *rNlFc = NULL, *rNlY = NULL;
    jdouble *rNlBnlm = NULL;
    if (FULL_CACHE) {
        rNlRn = rForwardCache;
        rNlFc = rNlRn + aNN*(aNMax+1);
        rNlY = rNlFc + aNN;
    } else {
        rRn = rForwardCache;
        rY = rRn + (aNMax+1);
    }
    if (WTYPE==jsex_nnap_basis_SphericalChebyshev_WTYPE_FUSE) {
        if (FULL_CACHE) {
            rNlBnlm = rNlY + aNN*LMALL;
        } else {
            rBnlm = rY + LMALL;
        }
    }
    // loop for neighbor
    for (jint j = 0; j < aNN; ++j) {
        jint type = aNlType[j];
        jdouble dx = aNlDx[j], dy = aNlDy[j], dz = aNlDz[j];
        jdouble dis = sqrt((double)(dx*dx + dy*dy + dz*dz));
        // check rcut for merge
        if (dis >= aRCut) continue;
        // cal fc
        jdouble fc = JSE_NNAP::calFc(dis, aRCut);
        if (FULL_CACHE) rNlFc[j] = fc;
        // cal Rn
        if (FULL_CACHE) rRn = rNlRn + j*(aNMax+1);
        JSE_NNAP::calRn(rRn, aNMax, dis, aRCut);
        // cal Y
        if (FULL_CACHE) rY = rNlY + j*LMALL;
        realSphericalHarmonicsFull4<LMAXMAX>(dx, dy, dz, dis, rY);
        // cal cnlm
        if (WTYPE==jsex_nnap_basis_SphericalChebyshev_WTYPE_FUSE) {
            // cal bnlm
            if (FULL_CACHE) rBnlm = rNlBnlm + j*tSizeBnlm;
            calBnlm<LMALL>(rBnlm, rY, fc, rRn, aNMax);
            // mplus2cnlm
            jdouble *tFuseWeight = aFuseWeight;
            jdouble *tCnlm = rCnlm;
            for (jint k = 0; k < aFuseSize; ++k) {
                jdouble wt = tFuseWeight[type-1];
                mplusBnlm2Cnlm<LMALL>(tCnlm, rBnlm, wt, aNMax);
                tFuseWeight += aTypeNum;
                tCnlm += tSizeBnlm;
            }
        } else
        if (WTYPE==jsex_nnap_basis_SphericalChebyshev_WTYPE_NONE) {
            mplusCnlm<LMALL>(rCnlm, rY, fc, rRn, aNMax);
        } else
        if (WTYPE==jsex_nnap_basis_SphericalChebyshev_WTYPE_FULL) {
            jdouble *tCnlm = rCnlm + tSizeBnlm*(type-1);
            mplusCnlm<LMALL>(tCnlm, rY, fc, rRn, aNMax);
        } else
        if (WTYPE==jsex_nnap_basis_SphericalChebyshev_WTYPE_EXFULL) {
            jdouble *tCnlmWt = rCnlm + tSizeBnlm*type;
            mplusCnlmWt<LMALL>(rCnlm, tCnlmWt, rY, fc, rRn, 1.0, aNMax);
        } else
        if (WTYPE==jsex_nnap_basis_SphericalChebyshev_WTYPE_DEFAULT) {
            jdouble wt = ((type&1)==1) ? type : -type;
            jdouble *tCnlmWt = rCnlm + tSizeBnlm;
            mplusCnlmWt<LMALL>(rCnlm, tCnlmWt, rY, fc, rRn, wt, aNMax);
        }
    }
}

template <jint LMAX, jboolean NO_RADIAL, jint L3MAX, jboolean L3CROSS, jint WTYPE>
static inline void calFp(jdouble *aNlDx, jdouble *aNlDy, jdouble *aNlDz, jint *aNlType, jint aNN, jdouble *rFp,
                         jdouble *rForwardCache, jboolean aFullCache,
                         jint aTypeNum, jdouble aRCut, jint aNMax, jdouble *aFuseWeight, jint aFuseSize) noexcept {
    // const init
    jint tSizeN;
    switch(WTYPE) {
    case jsex_nnap_basis_SphericalChebyshev_WTYPE_EXFULL: {
        tSizeN = (aTypeNum+1)*(aNMax+1);
        break;
    }
    case jsex_nnap_basis_SphericalChebyshev_WTYPE_FULL: {
        tSizeN = aTypeNum*(aNMax+1);
        break;
    }
    case jsex_nnap_basis_SphericalChebyshev_WTYPE_NONE: {
        tSizeN = aNMax+1;
        break;
    }
    case jsex_nnap_basis_SphericalChebyshev_WTYPE_DEFAULT: {
        tSizeN = (aNMax+aNMax+2);
        break;
    }
    case jsex_nnap_basis_SphericalChebyshev_WTYPE_FUSE: {
        tSizeN = aFuseSize*(aNMax+1);
        break;
    }
    default: {
        tSizeN = 0;
        break;
    }}
    constexpr jint tSizeL = (NO_RADIAL?LMAX:(LMAX+1)) + (L3CROSS?L3NCOLS:L3NCOLS_NOCROSS)[L3MAX];
    constexpr jint tLMaxMax = LMAX>L3MAX ? LMAX : L3MAX;
    constexpr jint tLMAll = (tLMaxMax+1)*(tLMaxMax+1);
    const jint tSizeCnlm = tSizeN*tLMAll;
    // init cache
    jdouble *rCnlm = rForwardCache;
    jdouble *rForwardCacheElse = rCnlm + tSizeCnlm;
    // clear cnlm first
    for (jint i = 0; i < tSizeCnlm; ++i) {
        rCnlm[i] = 0.0;
    }
    // do cal
    if (aFullCache) {
        calCnlm<tLMaxMax, tLMAll, WTYPE, JNI_TRUE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, rCnlm, rForwardCacheElse, aTypeNum, aRCut, aNMax, aFuseWeight, aFuseSize);
    } else {
        calCnlm<tLMaxMax, tLMAll, WTYPE, JNI_FALSE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, rCnlm, rForwardCacheElse, aTypeNum, aRCut, aNMax, aFuseWeight, aFuseSize);
    }
    for (jint n=0, tShift=0, tShiftFp=0; n<tSizeN; ++n, tShift+=tLMAll, tShiftFp+=tSizeL) {
        calL2_<LMAX, NO_RADIAL>(rCnlm+tShift, rFp+tShiftFp);
        calL3_<L3MAX, L3CROSS>(rCnlm+tShift, rFp+tShiftFp+(NO_RADIAL?LMAX:(LMAX+1)));
    }
}

template <jint LMALL, jint WTYPE>
static void calBackwardMainLoop(jdouble *aNlDx, jdouble *aNlDy, jdouble *aNlDz, jint *aNlType, jint aNN,
                                jdouble *rGradPara, jdouble *aNlBnlm,  jdouble *aGradCnlm,
                                jint aTypeNum, jdouble aRCut, jint aNMax, jint aFuseSize) {
    const jint tSizeBnlm = (aNMax+1)*LMALL;
    for (jint j = 0; j < aNN; ++j) {
        jint type = aNlType[j];
        jdouble dx = aNlDx[j], dy = aNlDy[j], dz = aNlDz[j];
        jdouble dis = sqrt((double)(dx*dx + dy*dy + dz*dz));
        // check rcut for merge
        if (dis >= aRCut) continue;
        jdouble *tBnlm = aNlBnlm + j*tSizeBnlm;
        if (WTYPE==jsex_nnap_basis_SphericalChebyshev_WTYPE_FUSE) {
            jdouble *tGradPara = rGradPara;
            jdouble *tGradCnlm = aGradCnlm;
            for (jint fi = 0; fi < aFuseSize; ++fi) {
                tGradPara[type-1] += dotBnlmGradCnlm<LMALL>(tBnlm, tGradCnlm, aNMax);
                tGradPara += aTypeNum;
                tGradCnlm += tSizeBnlm;
            }
            continue;
        }
    }
}
template <jint LMAX, jboolean NO_RADIAL, jint L3MAX, jboolean L3CROSS, jint WTYPE>
static void calBackward(jdouble *aNlDx, jdouble *aNlDy, jdouble *aNlDz, jint *aNlType, jint aNN,
                        jdouble *aGradFp, jdouble *rGradPara, jdouble *aForwardCache, jdouble *rBackwardCache,
                        jint aTypeNum, jdouble aRCut, jint aNMax, jint aFuseSize) noexcept {
    static_assert(WTYPE!=jsex_nnap_basis_SphericalChebyshev_WTYPE_DEFAULT &&
                  WTYPE!=jsex_nnap_basis_SphericalChebyshev_WTYPE_NONE &&
                  WTYPE!=jsex_nnap_basis_SphericalChebyshev_WTYPE_FULL &&
                  WTYPE!=jsex_nnap_basis_SphericalChebyshev_WTYPE_EXFULL, "WTYPE INVALID");
    // const init
    jint tSizeN;
    if (WTYPE==jsex_nnap_basis_SphericalChebyshev_WTYPE_FUSE) {
        tSizeN = aFuseSize*(aNMax+1);
    } else {
        tSizeN = 0;
    }
    constexpr jint tSizeL = (NO_RADIAL?LMAX:(LMAX+1)) + (L3CROSS?L3NCOLS:L3NCOLS_NOCROSS)[L3MAX];
    constexpr jint tLMaxMax = LMAX>L3MAX ? LMAX : L3MAX;
    constexpr jint tLMAll = (tLMaxMax+1)*(tLMaxMax+1);
    const jint tSizeCnlm = tSizeN*tLMAll;
    // init cache
    jdouble *tCnlm = aForwardCache;
    jdouble *tNlBnlm = tCnlm + tSizeCnlm + aNN*(aNMax+1 + 1 + tLMAll);
    jdouble *rGradCnlm = rBackwardCache;
    // cal grad cnlm
    for (jint n=0, tShift=0, tShiftFp=0; n<tSizeN; ++n, tShift+=tLMAll, tShiftFp+=tSizeL) {
        calGradL2_<LMAX, NO_RADIAL>(tCnlm+tShift, rGradCnlm+tShift, aGradFp+tShiftFp);
        calGradL3_<L3MAX, L3CROSS>(tCnlm+tShift, rGradCnlm+tShift, aGradFp+tShiftFp+(NO_RADIAL?LMAX:(LMAX+1)));
    }
    // plus to para
    calBackwardMainLoop<tLMAll, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, rGradPara, tNlBnlm, rGradCnlm, aTypeNum, aRCut, aNMax, aFuseSize);
}

template <jint LMAXMAX, jint LMALL, jint WTYPE, jboolean FULL_CACHE>
static void calForceMainLoop(jdouble *aNlDx, jdouble *aNlDy, jdouble *aNlDz, jint *aNlType, jint aNN,
                             jdouble *aGradCnlm, jdouble *rFx, jdouble *rFy, jdouble *rFz,
                             jdouble *aForwardCache, jdouble *rForwardForceCache,
                             jint aTypeNum, jdouble aRCut, jint aNMax, jdouble *aFuseWeight, jint aFuseSize) {
    const jint tSizeBnlm = (aNMax+1)*LMALL;
    // init cache
    jdouble *tNlRn = aForwardCache;
    jdouble *tNlFc = tNlRn + aNN*(aNMax+1);
    jdouble *tNlY = tNlFc + aNN;
    jdouble *rRnPx = NULL, *rRnPy = NULL, *rRnPz = NULL, *rCheby2 = NULL;
    jdouble *rYPx = NULL, *rYPy = NULL, *rYPz = NULL, *rYPtheta = NULL, *rYPphi = NULL;
    jdouble *rGradBnlm = NULL;
    jdouble *rNlRnPx = NULL, *rNlRnPy = NULL, *rNlRnPz = NULL;
    jdouble *rNlFcPx = NULL, *rNlFcPy = NULL, *rNlFcPz = NULL;
    jdouble *rNlYPx = NULL, *rNlYPy = NULL, *rNlYPz = NULL;
    jdouble *rNlGradBnlm = NULL;
    if (FULL_CACHE) {
        rNlRnPx = rForwardForceCache;
        rNlRnPy = rNlRnPx + aNN*(aNMax+1);
        rNlRnPz = rNlRnPy + aNN*(aNMax+1);
        rNlFcPx = rNlRnPz + aNN*(aNMax+1);
        rNlFcPy = rNlFcPx + aNN;
        rNlFcPz = rNlFcPy + aNN;
        rNlYPx = rNlFcPz + aNN;
        rNlYPy = rNlYPx + aNN*LMALL;
        rNlYPz = rNlYPy + aNN*LMALL;
        rYPtheta = rNlYPz + aNN*LMALL;
        rYPphi = rYPtheta + LMALL;
        rCheby2 = rYPphi + LMALL;
    } else {
        rRnPx = rForwardForceCache;
        rRnPy = rRnPx + (aNMax+1);
        rRnPz = rRnPy + (aNMax+1);
        rYPx = rRnPz + (aNMax+1);
        rYPy = rYPx + LMALL;
        rYPz = rYPy + LMALL;
        rYPtheta = rYPz + LMALL;
        rYPphi = rYPtheta + LMALL;
        rCheby2 = rYPphi + LMALL;
    }
    if (WTYPE==jsex_nnap_basis_SphericalChebyshev_WTYPE_FUSE) {
        if (FULL_CACHE) {
            rNlGradBnlm = rCheby2 + (aNMax+1);
        } else {
            rGradBnlm = rCheby2 + (aNMax+1);
        }
    }
    // loop for neighbor
    for (jint j = 0; j < aNN; ++j) {
        // init nl
        jint type = aNlType[j];
        jdouble dx = aNlDx[j], dy = aNlDy[j], dz = aNlDz[j];
        jdouble dis = sqrt((double)(dx*dx + dy*dy + dz*dz));
        // check rcut for merge
        if (dis >= aRCut) continue;
        // get fc Rn Y
        jdouble fc = tNlFc[j];
        jdouble *tRn = tNlRn + j*(aNMax+1);
        jdouble *tY = tNlY + j*LMALL;
        // cal fcPxyz
        jdouble fcPx, fcPy, fcPz;
        JSE_NNAP::calFcPxyz(&fcPx, &fcPy, &fcPz, dis, aRCut, dx, dy, dz);
        if (FULL_CACHE) {
            rNlFcPx[j] = fcPx;
            rNlFcPy[j] = fcPy;
            rNlFcPz[j] = fcPz;
        }
        // cal RnPxyz
        if (FULL_CACHE) {
            rRnPx = rNlRnPx + j*(aNMax+1);
            rRnPy = rNlRnPy + j*(aNMax+1);
            rRnPz = rNlRnPz + j*(aNMax+1);
        }
        JSE_NNAP::calRnPxyz(rRnPx, rRnPy, rRnPz, rCheby2, aNMax, dis, aRCut, dx, dy, dz);
        // cal Ylm
        if (FULL_CACHE) {
            rYPx = rNlYPx + j*LMALL;
            rYPy = rNlYPy + j*LMALL;
            rYPz = rNlYPz + j*LMALL;
        }
        calYPxyz<LMAXMAX, LMALL>(tY, dx, dy, dz, dis, rYPx, rYPy, rYPz, rYPtheta, rYPphi);
        // cal fxyz
        if (WTYPE==jsex_nnap_basis_SphericalChebyshev_WTYPE_FUSE) {
            if (FULL_CACHE) {
                rGradBnlm = rNlGradBnlm + j*tSizeBnlm;
            }
            for (jint k = 0; k < tSizeBnlm; ++k) {
                rGradBnlm[k] = 0.0;
            }
            jdouble *tFuseWeight = aFuseWeight;
            jdouble *tGradCnlm = aGradCnlm;
            for (jint k = 0; k < aFuseSize; ++k) {
                jdouble wt = tFuseWeight[type-1];
                mplusBnlm2Cnlm<LMALL>(rGradBnlm, tGradCnlm, wt, aNMax);
                tFuseWeight += aTypeNum;
                tGradCnlm += tSizeBnlm;
            }
            gradBnlm2Fxyz<LMALL>(j, rGradBnlm, rYPtheta, tY, fc, tRn, aNMax, fcPx, fcPy, fcPz, rRnPx, rRnPy, rRnPz, rYPx, rYPy, rYPz, rFx, rFy, rFz);
        } else
        if (WTYPE==jsex_nnap_basis_SphericalChebyshev_WTYPE_NONE) {
            gradBnlm2Fxyz<LMALL>(j, aGradCnlm, rYPtheta, tY, fc, tRn, aNMax, fcPx, fcPy, fcPz, rRnPx, rRnPy, rRnPz, rYPx, rYPy, rYPz, rFx, rFy, rFz);
        } else
        if (WTYPE==jsex_nnap_basis_SphericalChebyshev_WTYPE_FULL) {
            jdouble *tGradBnlm = aGradCnlm + tSizeBnlm*(type-1);
            gradBnlm2Fxyz<LMALL>(j, tGradBnlm, rYPtheta, tY, fc, tRn, aNMax, fcPx, fcPy, fcPz, rRnPx, rRnPy, rRnPz, rYPx, rYPy, rYPz, rFx, rFy, rFz);
        } else
        if (WTYPE==jsex_nnap_basis_SphericalChebyshev_WTYPE_EXFULL) {
            jdouble *tGradCnlmWt = aGradCnlm + tSizeBnlm*type;
            gradCnlmWt2Fxyz<LMALL>(j, aGradCnlm, tGradCnlmWt, rYPtheta, tY, fc, tRn, 1.0, aNMax, fcPx, fcPy, fcPz, rRnPx, rRnPy, rRnPz, rYPx, rYPy, rYPz, rFx, rFy, rFz);
        } else
        if (WTYPE==jsex_nnap_basis_SphericalChebyshev_WTYPE_DEFAULT) {
            jdouble wt = ((type&1)==1) ? type : -type;
            jdouble *tGradCnlmWt = aGradCnlm + tSizeBnlm;
            gradCnlmWt2Fxyz<LMALL>(j, aGradCnlm, tGradCnlmWt, rYPtheta, tY, fc, tRn, wt, aNMax, fcPx, fcPy, fcPz, rRnPx, rRnPy, rRnPz, rYPx, rYPy, rYPz, rFx, rFy, rFz);
        }
    }
}
template <jint LMAX, jboolean NO_RADIAL, jint L3MAX, jboolean L3CROSS, jint WTYPE>
static void calForce(jdouble *aNlDx, jdouble *aNlDy, jdouble *aNlDz, jint *aNlType, jint aNN,
                     jdouble *aNNGrad, jdouble *rFx, jdouble *rFy, jdouble *rFz,
                     jdouble *aForwardCache, jdouble *rForwardForceCache, jboolean aFullCache,
                     jint aTypeNum, jdouble aRCut, jint aNMax, jdouble *aFuseWeight, jint aFuseSize) noexcept {
    // const init
    jint tSizeN;
    switch(WTYPE) {
    case jsex_nnap_basis_SphericalChebyshev_WTYPE_EXFULL: {
        tSizeN = (aTypeNum+1)*(aNMax+1);
        break;
    }
    case jsex_nnap_basis_SphericalChebyshev_WTYPE_FULL: {
        tSizeN = aTypeNum*(aNMax+1);
        break;
    }
    case jsex_nnap_basis_SphericalChebyshev_WTYPE_NONE: {
        tSizeN = aNMax+1;
        break;
    }
    case jsex_nnap_basis_SphericalChebyshev_WTYPE_DEFAULT: {
        tSizeN = (aNMax+aNMax+2);
        break;
    }
    case jsex_nnap_basis_SphericalChebyshev_WTYPE_FUSE: {
        tSizeN = aFuseSize*(aNMax+1);
        break;
    }
    default: {
        tSizeN = 0;
        break;
    }}
    constexpr jint tSizeL = (NO_RADIAL?LMAX:(LMAX+1)) + (L3CROSS?L3NCOLS:L3NCOLS_NOCROSS)[L3MAX];
    constexpr jint tLMaxMax = LMAX>L3MAX ? LMAX : L3MAX;
    constexpr jint tLMAll = (tLMaxMax+1)*(tLMaxMax+1);
    const jint tSizeCnlm = tSizeN*tLMAll;
    // init cache
    jdouble *tCnlm = aForwardCache;
    jdouble *tForwardCacheElse = tCnlm + tSizeCnlm;
    jdouble *rGradCnlm = rForwardForceCache;
    jdouble *rForwardForceCacheElse = rGradCnlm + tSizeCnlm;
    // forward need init gradCnlm here
    for (jint i = 0; i < tSizeCnlm; ++i) {
        rGradCnlm[i] = 0.0;
    }
    for (jint n=0, tShift=0, tShiftFp=0; n<tSizeN; ++n, tShift+=tLMAll, tShiftFp+=tSizeL) {
        calGradL2_<LMAX, NO_RADIAL>(tCnlm+tShift, rGradCnlm+tShift, aNNGrad+tShiftFp);
        calGradL3_<L3MAX, L3CROSS>(tCnlm+tShift, rGradCnlm+tShift, aNNGrad+tShiftFp+(NO_RADIAL?LMAX:(LMAX+1)));
    }
    if (aFullCache) {
        calForceMainLoop<tLMaxMax, tLMAll, WTYPE, JNI_TRUE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, rGradCnlm, rFx, rFy, rFz, tForwardCacheElse, rForwardForceCacheElse, aTypeNum, aRCut, aNMax, aFuseWeight, aFuseSize);
    } else {
        calForceMainLoop<tLMaxMax, tLMAll, WTYPE, JNI_FALSE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, rGradCnlm, rFx, rFy, rFz, tForwardCacheElse, rForwardForceCacheElse, aTypeNum, aRCut, aNMax, aFuseWeight, aFuseSize);
    }
}

template <jint LMALL, jint WTYPE>
static void calBackwardForceMainLoop(jdouble *aNlDx, jdouble *aNlDy, jdouble *aNlDz, jint *aNlType, jint aNN,
                                     jdouble *rGradNNGradCnlm, jdouble *aGradFx, jdouble *aGradFy, jdouble *aGradFz,
                                     jdouble *aNNGradCnlm, jdouble *rGradPara,
                                     jdouble *aForwardCache, jdouble *aForwardForceCache,
                                     jdouble *rBackwardForceCache, jboolean aFixBasis,
                                     jint aTypeNum, jdouble aRCut, jint aNMax, jdouble *aFuseWeight, jint aFuseSize) noexcept {
    const jint tSizeBnlm = (aNMax+1)*LMALL;
    // init cache
    jdouble *tNlRn = aForwardCache;
    jdouble *tNlFc = tNlRn + aNN*(aNMax+1);
    jdouble *tNlY = tNlFc + aNN;
    jdouble *tNlRnPx = aForwardForceCache;
    jdouble *tNlRnPy = tNlRnPx + aNN*(aNMax+1);
    jdouble *tNlRnPz = tNlRnPy + aNN*(aNMax+1);
    jdouble *tNlFcPx = tNlRnPz + aNN*(aNMax+1);
    jdouble *tNlFcPy = tNlFcPx + aNN;
    jdouble *tNlFcPz = tNlFcPy + aNN;
    jdouble *tNlYPx = tNlFcPz + aNN;
    jdouble *tNlYPy = tNlYPx + aNN*LMALL;
    jdouble *tNlYPz = tNlYPy + aNN*LMALL;
    jdouble *rGradNNGradY = rBackwardForceCache;
    jdouble *rGradNNGradBnlm = NULL;
    if (WTYPE==jsex_nnap_basis_SphericalChebyshev_WTYPE_FUSE) {
        rGradNNGradBnlm = rGradNNGradY + LMALL;
    }
    // loop for neighbor
    for (jint j = 0; j < aNN; ++j) {
        // init nl
        jint type = aNlType[j];
        jdouble dx = aNlDx[j], dy = aNlDy[j], dz = aNlDz[j];
        jdouble dis = sqrt((double)(dx*dx + dy*dy + dz*dz));
        // check rcut for merge
        if (dis >= aRCut) continue;
        // get gradFxyz
        jdouble tGradFx = aGradFx[j], tGradFy = aGradFy[j], tGradFz = aGradFz[j];
        // get fc Rn Y
        jdouble fc = tNlFc[j];
        jdouble *tRn = tNlRn + j*(aNMax+1);
        jdouble *tY = tNlY + j*LMALL;
        // get fcPxyz RnPxyz YPxyz
        jdouble fcPx = tNlFcPx[j], fcPy = tNlFcPy[j], fcPz = tNlFcPz[j];
        jdouble *tRnPx = tNlRnPx + j*(aNMax+1);
        jdouble *tRnPy = tNlRnPy + j*(aNMax+1);
        jdouble *tRnPz = tNlRnPz + j*(aNMax+1);
        jdouble *tYPx = tNlYPx + j*LMALL;
        jdouble *tYPy = tNlYPy + j*LMALL;
        jdouble *tYPz = tNlYPz + j*LMALL;
        // mplus to gradNNgrad
        if (WTYPE==jsex_nnap_basis_SphericalChebyshev_WTYPE_FUSE) {
            calGradNNGradBnlm<LMALL>(rGradNNGradBnlm, tY, fc, tRn, aNMax, tYPx, tYPy, tYPz, rGradNNGradY, fcPx, fcPy, fcPz, tRnPx, tRnPy, tRnPz, tGradFx, tGradFy, tGradFz);
            jdouble *tFuseWeight = aFuseWeight;
            jdouble *tGradNNGradCnlm = rGradNNGradCnlm;
            for (jint k = 0; k < aFuseSize; ++k) {
                jdouble wt = tFuseWeight[type-1];
                mplusBnlm2Cnlm<LMALL>(tGradNNGradCnlm, rGradNNGradBnlm, wt, aNMax);
                tGradNNGradCnlm += tSizeBnlm;
                tFuseWeight += aTypeNum;
            }
            if (!aFixBasis) {
                jdouble *tGradPara = rGradPara;
                jdouble *tNNGradCnlm = aNNGradCnlm;
                for (jint k = 0; k < aFuseSize; ++k) {
                    tGradPara[type-1] += dotBnlmGradCnlm<LMALL>(tNNGradCnlm, rGradNNGradBnlm, aNMax);
                    tNNGradCnlm += tSizeBnlm;
                    tGradPara += aTypeNum;
                }
            }
        } else
        if (WTYPE==jsex_nnap_basis_SphericalChebyshev_WTYPE_NONE) {
            mplusGradNNGradCnlm<LMALL>(rGradNNGradCnlm, tY, fc, tRn, aNMax, tYPx, tYPy, tYPz, rGradNNGradY, fcPx, fcPy, fcPz, tRnPx, tRnPy, tRnPz, tGradFx, tGradFy, tGradFz);
        } else
        if (WTYPE==jsex_nnap_basis_SphericalChebyshev_WTYPE_FULL) {
            jdouble *tGradNNGradCnlm = rGradNNGradCnlm + tSizeBnlm*(type-1);
            mplusGradNNGradCnlm<LMALL>(tGradNNGradCnlm, tY, fc, tRn, aNMax, tYPx, tYPy, tYPz, rGradNNGradY, fcPx, fcPy, fcPz, tRnPx, tRnPy, tRnPz, tGradFx, tGradFy, tGradFz);
        } else
        if (WTYPE==jsex_nnap_basis_SphericalChebyshev_WTYPE_EXFULL) {
            jdouble *rGradNNGradCnlmWt = rGradNNGradCnlm + tSizeBnlm*type;
            mplusGradNNGradCnlmWt<LMALL>(rGradNNGradCnlm, rGradNNGradCnlmWt, tY, fc, tRn, 1.0, aNMax, tYPx, tYPy, tYPz, rGradNNGradY, fcPx, fcPy, fcPz, tRnPx, tRnPy, tRnPz, tGradFx, tGradFy, tGradFz);
        } else
        if (WTYPE==jsex_nnap_basis_SphericalChebyshev_WTYPE_DEFAULT) {
            jdouble wt = ((type&1)==1) ? type : -type;
            jdouble *rGradNNGradCnlmWt = rGradNNGradCnlm + tSizeBnlm;
            mplusGradNNGradCnlmWt<LMALL>(rGradNNGradCnlm, rGradNNGradCnlmWt, tY, fc, tRn, wt, aNMax, tYPx, tYPy, tYPz, rGradNNGradY, fcPx, fcPy, fcPz, tRnPx, tRnPy, tRnPz, tGradFx, tGradFy, tGradFz);
        }
    }
}
template <jint LMAX, jboolean NO_RADIAL, jint L3MAX, jboolean L3CROSS, jint WTYPE>
static void calBackwardForce(jdouble *aNlDx, jdouble *aNlDy, jdouble *aNlDz, jint *aNlType, jint aNN,
                             jdouble *aNNGrad, jdouble *aGradFx, jdouble *aGradFy, jdouble *aGradFz,
                             jdouble *rGradNNGrad, jdouble *rGradPara,
                             jdouble *aForwardCache, jdouble *aForwardForceCache,
                             jdouble *rBackwardCache, jdouble *rBackwardForceCache, jboolean aFixBasis,
                             jint aTypeNum, jdouble aRCut, jint aNMax, jdouble *aFuseWeight, jint aFuseSize) noexcept {
    // const init
    jint tSizeN;
    switch(WTYPE) {
    case jsex_nnap_basis_SphericalChebyshev_WTYPE_EXFULL: {
        tSizeN = (aTypeNum+1)*(aNMax+1);
        break;
    }
    case jsex_nnap_basis_SphericalChebyshev_WTYPE_FULL: {
        tSizeN = aTypeNum*(aNMax+1);
        break;
    }
    case jsex_nnap_basis_SphericalChebyshev_WTYPE_NONE: {
        tSizeN = aNMax+1;
        break;
    }
    case jsex_nnap_basis_SphericalChebyshev_WTYPE_DEFAULT: {
        tSizeN = (aNMax+aNMax+2);
        break;
    }
    case jsex_nnap_basis_SphericalChebyshev_WTYPE_FUSE: {
        tSizeN = aFuseSize*(aNMax+1);
        break;
    }
    default: {
        tSizeN = 0;
        break;
    }}
    constexpr jint tSizeL = (NO_RADIAL?LMAX:(LMAX+1)) + (L3CROSS?L3NCOLS:L3NCOLS_NOCROSS)[L3MAX];
    constexpr jint tLMaxMax = LMAX>L3MAX ? LMAX : L3MAX;
    constexpr jint tLMAll = (tLMaxMax+1)*(tLMaxMax+1);
    const jint tSizeCnlm = tSizeN*tLMAll;
    // init cache
    jdouble *tCnlm = aForwardCache;
    jdouble *tForwardCacheElse = tCnlm + tSizeCnlm;
    jdouble *tNNGradCnlm = aForwardForceCache;
    jdouble *tForwardForceCacheElse = tNNGradCnlm + tSizeCnlm;
    jdouble *rGradCnlm = rBackwardCache;
    jdouble *rGradNNGradCnlm = rBackwardForceCache;
    jdouble *rBackwardForceCacheElse = rGradNNGradCnlm + tSizeCnlm;
    
    // cal rGradNNGradCnlm
    calBackwardForceMainLoop<tLMAll, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, rGradNNGradCnlm, aGradFx, aGradFy, aGradFz, tNNGradCnlm, rGradPara, tForwardCacheElse, tForwardForceCacheElse, rBackwardForceCacheElse, aFixBasis, aTypeNum, aRCut, aNMax, aFuseWeight, aFuseSize);
    
    // grad grad cnlm to grad grad fp
    for (jint n=0, tShift=0, tShiftFp=0; n<tSizeN; ++n, tShift+=tLMAll, tShiftFp+=tSizeL) {
        calGradNNGradL2_<LMAX, NO_RADIAL>(tCnlm+tShift, rGradNNGradCnlm+tShift, rGradNNGrad+tShiftFp);
        calGradNNGradL3_<L3MAX, L3CROSS>(tCnlm+tShift, rGradNNGradCnlm+tShift, rGradNNGrad+tShiftFp+(NO_RADIAL?LMAX:(LMAX+1)));
    }
    if (WTYPE==jsex_nnap_basis_SphericalChebyshev_WTYPE_FUSE) if (!aFixBasis) {
        for (jint n=0, tShift=0, tShiftFp=0; n<tSizeN; ++n, tShift+=tLMAll, tShiftFp+=tSizeL) {
            calGradCnlmL2_<LMAX, NO_RADIAL>(rGradCnlm+tShift, rGradNNGradCnlm+tShift, aNNGrad+tShiftFp);
            calGradCnlmL3_<L3MAX, L3CROSS>(tCnlm+tShift, rGradCnlm+tShift, rGradNNGradCnlm+tShift, aNNGrad+tShiftFp+(NO_RADIAL?LMAX:(LMAX+1)));
        }
    }
}


template <jboolean NO_RADIAL, jint L3MAX, jboolean L3CROSS, jint WTYPE>
static inline void calFp(jdouble *aNlDx, jdouble *aNlDy, jdouble *aNlDz, jint *aNlType, jint aNN,
                         jdouble *rFp, jdouble *rForwardCache, jboolean aFullCache,
                         jint aTypeNum, jdouble aRCut, jint aNMax, jint aLMax, jdouble *aFuseWeight, jint aFuseSize) noexcept {
    switch (aLMax) {
    case 0: {calFp<0, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, rFp, rForwardCache, aFullCache, aTypeNum, aRCut, aNMax, aFuseWeight, aFuseSize); return;}
    case 1: {calFp<1, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, rFp, rForwardCache, aFullCache, aTypeNum, aRCut, aNMax, aFuseWeight, aFuseSize); return;}
    case 2: {calFp<2, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, rFp, rForwardCache, aFullCache, aTypeNum, aRCut, aNMax, aFuseWeight, aFuseSize); return;}
    case 3: {calFp<3, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, rFp, rForwardCache, aFullCache, aTypeNum, aRCut, aNMax, aFuseWeight, aFuseSize); return;}
    case 4: {calFp<4, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, rFp, rForwardCache, aFullCache, aTypeNum, aRCut, aNMax, aFuseWeight, aFuseSize); return;}
    case 5: {calFp<5, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, rFp, rForwardCache, aFullCache, aTypeNum, aRCut, aNMax, aFuseWeight, aFuseSize); return;}
    case 6: {calFp<6, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, rFp, rForwardCache, aFullCache, aTypeNum, aRCut, aNMax, aFuseWeight, aFuseSize); return;}
    case 7: {calFp<7, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, rFp, rForwardCache, aFullCache, aTypeNum, aRCut, aNMax, aFuseWeight, aFuseSize); return;}
    case 8: {calFp<8, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, rFp, rForwardCache, aFullCache, aTypeNum, aRCut, aNMax, aFuseWeight, aFuseSize); return;}
    case 9: {calFp<9, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, rFp, rForwardCache, aFullCache, aTypeNum, aRCut, aNMax, aFuseWeight, aFuseSize); return;}
    case 10: {calFp<10, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, rFp, rForwardCache, aFullCache, aTypeNum, aRCut, aNMax, aFuseWeight, aFuseSize); return;}
    case 11: {calFp<11, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, rFp, rForwardCache, aFullCache, aTypeNum, aRCut, aNMax, aFuseWeight, aFuseSize); return;}
    case 12: {calFp<12, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, rFp, rForwardCache, aFullCache, aTypeNum, aRCut, aNMax, aFuseWeight, aFuseSize); return;}
    default: {return;}
    }
}
template <jint L3MAX, jboolean L3CROSS, jint WTYPE>
static inline void calFp(jdouble *aNlDx, jdouble *aNlDy, jdouble *aNlDz, jint *aNlType, jint aNN,
                         jdouble *rFp, jdouble *rForwardCache, jboolean aFullCache,
                         jint aTypeNum, jdouble aRCut, jint aNMax, jint aLMax, jboolean aNoRadial, jdouble *aFuseWeight, jint aFuseSize) noexcept {
    if (aNoRadial) {
        calFp<JNI_TRUE, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, rFp, rForwardCache, aFullCache, aTypeNum, aRCut, aNMax, aLMax, aFuseWeight, aFuseSize);
    } else {
        calFp<JNI_FALSE, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, rFp, rForwardCache, aFullCache, aTypeNum, aRCut, aNMax, aLMax, aFuseWeight, aFuseSize);
    }
}
template <jint WTYPE>
static inline void calFp(jdouble *aNlDx, jdouble *aNlDy, jdouble *aNlDz, jint *aNlType, jint aNN,
                         jdouble *rFp, jdouble *rForwardCache, jboolean aFullCache,
                         jint aTypeNum, jdouble aRCut, jint aNMax, jint aLMax, jboolean aNoRadial,
                         jint aL3Max, jboolean aL3Cross, jdouble *aFuseWeight, jint aFuseSize) noexcept {
    if (aL3Cross) {
        switch (aL3Max) {
        case 0: case 1: {
            calFp<0, JNI_FALSE, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, rFp, rForwardCache, aFullCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aFuseWeight, aFuseSize);
            return;
        }
        case 2: {
            calFp<2, JNI_TRUE, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, rFp, rForwardCache, aFullCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aFuseWeight, aFuseSize);
            return;
        }
        case 3: {
            calFp<3, JNI_TRUE, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, rFp, rForwardCache, aFullCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aFuseWeight, aFuseSize);
            return;
        }
        case 4: {
            calFp<4, JNI_TRUE, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, rFp, rForwardCache, aFullCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aFuseWeight, aFuseSize);
            return;
        }
        default: {
            return;
        }}
    } else {
        switch (aL3Max) {
        case 0: case 1: {
            calFp<0, JNI_FALSE, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, rFp, rForwardCache, aFullCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aFuseWeight, aFuseSize);
            return;
        }
        case 2: case 3: {
            calFp<2, JNI_FALSE, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, rFp, rForwardCache, aFullCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aFuseWeight, aFuseSize);
            return;
        }
        case 4: {
            calFp<4, JNI_FALSE, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, rFp, rForwardCache, aFullCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aFuseWeight, aFuseSize);
            return;
        }
        default: {
            return;
        }}
    }
}
static inline void calFp(jdouble *aNlDx, jdouble *aNlDy, jdouble *aNlDz, jint *aNlType, jint aNN,
                         jdouble *rFp, jdouble *rForwardCache, jboolean aFullCache,
                         jint aTypeNum, jdouble aRCut, jint aNMax, jint aLMax, jboolean aNoRadial,
                         jint aL3Max, jboolean aL3Cross, jint aWType, jdouble *aFuseWeight, jint aFuseSize) noexcept {
    if (aTypeNum == 1) {
        switch(aWType) {
        case jsex_nnap_basis_SphericalChebyshev_WTYPE_FUSE: {
            calFp<jsex_nnap_basis_SphericalChebyshev_WTYPE_FUSE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, rFp, rForwardCache, aFullCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aL3Max, aL3Cross, aFuseWeight, aFuseSize);
            return;
        }
        case jsex_nnap_basis_SphericalChebyshev_WTYPE_NONE:
        case jsex_nnap_basis_SphericalChebyshev_WTYPE_FULL:
        case jsex_nnap_basis_SphericalChebyshev_WTYPE_EXFULL:
        case jsex_nnap_basis_SphericalChebyshev_WTYPE_DEFAULT: {
            calFp<jsex_nnap_basis_SphericalChebyshev_WTYPE_NONE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, rFp, rForwardCache, aFullCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aL3Max, aL3Cross, aFuseWeight, aFuseSize);
            return;
        }
        default: {
            return;
        }}
    } else {
        switch(aWType) {
        case jsex_nnap_basis_SphericalChebyshev_WTYPE_EXFULL: {
            calFp<jsex_nnap_basis_SphericalChebyshev_WTYPE_EXFULL>(aNlDx, aNlDy, aNlDz, aNlType, aNN, rFp, rForwardCache, aFullCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aL3Max, aL3Cross, aFuseWeight, aFuseSize);
            return;
        }
        case jsex_nnap_basis_SphericalChebyshev_WTYPE_FULL: {
            calFp<jsex_nnap_basis_SphericalChebyshev_WTYPE_FULL>(aNlDx, aNlDy, aNlDz, aNlType, aNN, rFp, rForwardCache, aFullCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aL3Max, aL3Cross, aFuseWeight, aFuseSize);
            return;
        }
        case jsex_nnap_basis_SphericalChebyshev_WTYPE_NONE: {
            calFp<jsex_nnap_basis_SphericalChebyshev_WTYPE_NONE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, rFp, rForwardCache, aFullCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aL3Max, aL3Cross, aFuseWeight, aFuseSize);
            return;
        }
        case jsex_nnap_basis_SphericalChebyshev_WTYPE_DEFAULT: {
            calFp<jsex_nnap_basis_SphericalChebyshev_WTYPE_DEFAULT>(aNlDx, aNlDy, aNlDz, aNlType, aNN, rFp, rForwardCache, aFullCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aL3Max, aL3Cross, aFuseWeight, aFuseSize);
            return;
        }
        case jsex_nnap_basis_SphericalChebyshev_WTYPE_FUSE: {
            calFp<jsex_nnap_basis_SphericalChebyshev_WTYPE_FUSE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, rFp, rForwardCache, aFullCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aL3Max, aL3Cross, aFuseWeight, aFuseSize);
            return;
        }
        default: {
            return;
        }}
    }
}


template <jboolean NO_RADIAL, jint L3MAX, jboolean L3CROSS, jint WTYPE>
static void calBackward(jdouble *aNlDx, jdouble *aNlDy, jdouble *aNlDz, jint *aNlType, jint aNN,
                        jdouble *aGradFp, jdouble *rGradPara, jdouble *aForwardCache, jdouble *rBackwardCache,
                        jint aTypeNum, jdouble aRCut, jint aNMax, jint aLMax, jint aFuseSize) noexcept {
    switch (aLMax) {
    case 0: {calBackward<0, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aGradFp, rGradPara, aForwardCache, rBackwardCache, aTypeNum, aRCut, aNMax, aFuseSize); return;}
    case 1: {calBackward<1, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aGradFp, rGradPara, aForwardCache, rBackwardCache, aTypeNum, aRCut, aNMax, aFuseSize); return;}
    case 2: {calBackward<2, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aGradFp, rGradPara, aForwardCache, rBackwardCache, aTypeNum, aRCut, aNMax, aFuseSize); return;}
    case 3: {calBackward<3, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aGradFp, rGradPara, aForwardCache, rBackwardCache, aTypeNum, aRCut, aNMax, aFuseSize); return;}
    case 4: {calBackward<4, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aGradFp, rGradPara, aForwardCache, rBackwardCache, aTypeNum, aRCut, aNMax, aFuseSize); return;}
    case 5: {calBackward<5, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aGradFp, rGradPara, aForwardCache, rBackwardCache, aTypeNum, aRCut, aNMax, aFuseSize); return;}
    case 6: {calBackward<6, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aGradFp, rGradPara, aForwardCache, rBackwardCache, aTypeNum, aRCut, aNMax, aFuseSize); return;}
    case 7: {calBackward<7, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aGradFp, rGradPara, aForwardCache, rBackwardCache, aTypeNum, aRCut, aNMax, aFuseSize); return;}
    case 8: {calBackward<8, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aGradFp, rGradPara, aForwardCache, rBackwardCache, aTypeNum, aRCut, aNMax, aFuseSize); return;}
    case 9: {calBackward<9, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aGradFp, rGradPara, aForwardCache, rBackwardCache, aTypeNum, aRCut, aNMax, aFuseSize); return;}
    case 10: {calBackward<10, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aGradFp, rGradPara, aForwardCache, rBackwardCache, aTypeNum, aRCut, aNMax, aFuseSize); return;}
    case 11: {calBackward<11, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aGradFp, rGradPara, aForwardCache, rBackwardCache, aTypeNum, aRCut, aNMax, aFuseSize); return;}
    case 12: {calBackward<12, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aGradFp, rGradPara, aForwardCache, rBackwardCache, aTypeNum, aRCut, aNMax, aFuseSize); return;}
    default: {return;}
    }
}
template <jint L3MAX, jboolean L3CROSS, jint WTYPE>
static void calBackward(jdouble *aNlDx, jdouble *aNlDy, jdouble *aNlDz, jint *aNlType, jint aNN,
                        jdouble *aGradFp, jdouble *rGradPara, jdouble *aForwardCache, jdouble *rBackwardCache,
                        jint aTypeNum, jdouble aRCut, jint aNMax, jint aLMax, jboolean aNoRadial, jint aFuseSize) noexcept {
    if (aNoRadial) {
        calBackward<JNI_TRUE, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aGradFp, rGradPara, aForwardCache, rBackwardCache, aTypeNum, aRCut, aNMax, aLMax, aFuseSize);
    } else {
        calBackward<JNI_FALSE, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aGradFp, rGradPara, aForwardCache, rBackwardCache, aTypeNum, aRCut, aNMax, aLMax, aFuseSize);
    }
}
template <jint WTYPE>
static void calBackward(jdouble *aNlDx, jdouble *aNlDy, jdouble *aNlDz, jint *aNlType, jint aNN,
                        jdouble *aGradFp, jdouble *rGradPara, jdouble *aForwardCache, jdouble *rBackwardCache,
                        jint aTypeNum, jdouble aRCut, jint aNMax, jint aLMax, jboolean aNoRadial,
                        jint aL3Max, jboolean aL3Cross, jint aFuseSize) noexcept {
    if (aL3Cross) {
        switch (aL3Max) {
        case 0: case 1: {
            calBackward<0, JNI_FALSE, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aGradFp, rGradPara, aForwardCache, rBackwardCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aFuseSize);
            return;
        }
        case 2: {
            calBackward<2, JNI_TRUE, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aGradFp, rGradPara, aForwardCache, rBackwardCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aFuseSize);
            return;
        }
        case 3: {
            calBackward<3, JNI_TRUE, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aGradFp, rGradPara, aForwardCache, rBackwardCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aFuseSize);
            return;
        }
        case 4: {
            calBackward<4, JNI_TRUE, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aGradFp, rGradPara, aForwardCache, rBackwardCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aFuseSize);
            return;
        }
        default: {
            return;
        }}
    } else {
        switch (aL3Max) {
        case 0: case 1: {
            calBackward<0, JNI_FALSE, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aGradFp, rGradPara, aForwardCache, rBackwardCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aFuseSize);
            return;
        }
        case 2: case 3: {
            calBackward<2, JNI_FALSE, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aGradFp, rGradPara, aForwardCache, rBackwardCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aFuseSize);
            return;
        }
        case 4: {
            calBackward<4, JNI_FALSE, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aGradFp, rGradPara, aForwardCache, rBackwardCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aFuseSize);
            return;
        }
        default: {
            return;
        }}
    }
}
static void calBackward(jdouble *aNlDx, jdouble *aNlDy, jdouble *aNlDz, jint *aNlType, jint aNN,
                        jdouble *aGradFp, jdouble *rGradPara, jdouble *aForwardCache, jdouble *rBackwardCache,
                        jint aTypeNum, jdouble aRCut, jint aNMax, jint aLMax, jboolean aNoRadial,
                        jint aL3Max, jboolean aL3Cross, jint aWType, jint aFuseSize) noexcept {
    if (aWType == jsex_nnap_basis_SphericalChebyshev_WTYPE_FUSE) {
        calBackward<jsex_nnap_basis_SphericalChebyshev_WTYPE_FUSE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aGradFp, rGradPara, aForwardCache, rBackwardCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aL3Max, aL3Cross, aFuseSize);
    }
}


template <jboolean NO_RADIAL, jint L3MAX, jboolean L3CROSS, jint WTYPE>
static inline void calForce(jdouble *aNlDx, jdouble *aNlDy, jdouble *aNlDz, jint *aNlType, jint aNN,
                            jdouble *aNNGrad, jdouble *rFx, jdouble *rFy, jdouble *rFz,
                            jdouble *aForwardCache, jdouble *rForwardForceCache, jboolean aFullCache,
                            jint aTypeNum, jdouble aRCut, jint aNMax, jint aLMax, jdouble *aFuseWeight, jint aFuseSize) noexcept {
    switch (aLMax) {
    case 0: {calForce<0, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, rFx, rFy, rFz, aForwardCache, rForwardForceCache, aFullCache, aTypeNum, aRCut, aNMax, aFuseWeight, aFuseSize); return;}
    case 1: {calForce<1, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, rFx, rFy, rFz, aForwardCache, rForwardForceCache, aFullCache, aTypeNum, aRCut, aNMax, aFuseWeight, aFuseSize); return;}
    case 2: {calForce<2, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, rFx, rFy, rFz, aForwardCache, rForwardForceCache, aFullCache, aTypeNum, aRCut, aNMax, aFuseWeight, aFuseSize); return;}
    case 3: {calForce<3, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, rFx, rFy, rFz, aForwardCache, rForwardForceCache, aFullCache, aTypeNum, aRCut, aNMax, aFuseWeight, aFuseSize); return;}
    case 4: {calForce<4, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, rFx, rFy, rFz, aForwardCache, rForwardForceCache, aFullCache, aTypeNum, aRCut, aNMax, aFuseWeight, aFuseSize); return;}
    case 5: {calForce<5, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, rFx, rFy, rFz, aForwardCache, rForwardForceCache, aFullCache, aTypeNum, aRCut, aNMax, aFuseWeight, aFuseSize); return;}
    case 6: {calForce<6, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, rFx, rFy, rFz, aForwardCache, rForwardForceCache, aFullCache, aTypeNum, aRCut, aNMax, aFuseWeight, aFuseSize); return;}
    case 7: {calForce<7, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, rFx, rFy, rFz, aForwardCache, rForwardForceCache, aFullCache, aTypeNum, aRCut, aNMax, aFuseWeight, aFuseSize); return;}
    case 8: {calForce<8, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, rFx, rFy, rFz, aForwardCache, rForwardForceCache, aFullCache, aTypeNum, aRCut, aNMax, aFuseWeight, aFuseSize); return;}
    case 9: {calForce<9, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, rFx, rFy, rFz, aForwardCache, rForwardForceCache, aFullCache, aTypeNum, aRCut, aNMax, aFuseWeight, aFuseSize); return;}
    case 10: {calForce<10, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, rFx, rFy, rFz, aForwardCache, rForwardForceCache, aFullCache, aTypeNum, aRCut, aNMax, aFuseWeight, aFuseSize); return;}
    case 11: {calForce<11, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, rFx, rFy, rFz, aForwardCache, rForwardForceCache, aFullCache, aTypeNum, aRCut, aNMax, aFuseWeight, aFuseSize); return;}
    case 12: {calForce<12, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, rFx, rFy, rFz, aForwardCache, rForwardForceCache, aFullCache, aTypeNum, aRCut, aNMax, aFuseWeight, aFuseSize); return;}
    default: {return;}
    }
}
template <jint L3MAX, jboolean L3CROSS, jint WTYPE>
static inline void calForce(jdouble *aNlDx, jdouble *aNlDy, jdouble *aNlDz, jint *aNlType, jint aNN,
                            jdouble *aNNGrad, jdouble *rFx, jdouble *rFy, jdouble *rFz,
                            jdouble *aForwardCache, jdouble *rForwardForceCache, jboolean aFullCache,
                            jint aTypeNum, jdouble aRCut, jint aNMax, jint aLMax, jboolean aNoRadial, jdouble *aFuseWeight, jint aFuseSize) noexcept {
    if (aNoRadial) {
        calForce<JNI_TRUE, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, rFx, rFy, rFz, aForwardCache, rForwardForceCache, aFullCache, aTypeNum, aRCut, aNMax, aLMax, aFuseWeight, aFuseSize);
    } else {
        calForce<JNI_FALSE, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, rFx, rFy, rFz, aForwardCache, rForwardForceCache, aFullCache, aTypeNum, aRCut, aNMax, aLMax, aFuseWeight, aFuseSize);
    }
}
template <jint WTYPE>
static inline void calForce(jdouble *aNlDx, jdouble *aNlDy, jdouble *aNlDz, jint *aNlType, jint aNN,
                            jdouble *aNNGrad, jdouble *rFx, jdouble *rFy, jdouble *rFz,
                            jdouble *aForwardCache, jdouble *rForwardForceCache, jboolean aFullCache,
                            jint aTypeNum, jdouble aRCut, jint aNMax, jint aLMax, jboolean aNoRadial,
                            jint aL3Max, jboolean aL3Cross, jdouble *aFuseWeight, jint aFuseSize) noexcept {
    if (aL3Cross) {
        switch (aL3Max) {
        case 0: case 1: {
            calForce<0, JNI_FALSE, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, rFx, rFy, rFz, aForwardCache, rForwardForceCache, aFullCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aFuseWeight, aFuseSize);
            return;
        }
        case 2: {
            calForce<2, JNI_TRUE, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, rFx, rFy, rFz, aForwardCache, rForwardForceCache, aFullCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aFuseWeight, aFuseSize);
            return;
        }
        case 3: {
            calForce<3, JNI_TRUE, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, rFx, rFy, rFz, aForwardCache, rForwardForceCache, aFullCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aFuseWeight, aFuseSize);
            return;
        }
        case 4: {
            calForce<4, JNI_TRUE, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, rFx, rFy, rFz, aForwardCache, rForwardForceCache, aFullCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aFuseWeight, aFuseSize);
            return;
        }
        default: {
            return;
        }}
    } else {
        switch (aL3Max) {
        case 0: case 1: {
            calForce<0, JNI_FALSE, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, rFx, rFy, rFz, aForwardCache, rForwardForceCache, aFullCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aFuseWeight, aFuseSize);
            return;
        }
        case 2: case 3: {
            calForce<2, JNI_FALSE, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, rFx, rFy, rFz, aForwardCache, rForwardForceCache, aFullCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aFuseWeight, aFuseSize);
            return;
        }
        case 4: {
            calForce<4, JNI_FALSE, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, rFx, rFy, rFz, aForwardCache, rForwardForceCache, aFullCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aFuseWeight, aFuseSize);
            return;
        }
        default: {
            return;
        }}
    }
}
static inline void calForce(jdouble *aNlDx, jdouble *aNlDy, jdouble *aNlDz, jint *aNlType, jint aNN,
                            jdouble *aNNGrad, jdouble *rFx, jdouble *rFy, jdouble *rFz,
                            jdouble *aForwardCache, jdouble *rForwardForceCache, jboolean aFullCache,
                            jint aTypeNum, jdouble aRCut, jint aNMax, jint aLMax, jboolean aNoRadial,
                            jint aL3Max, jboolean aL3Cross, jint aWType, jdouble *aFuseWeight, jint aFuseSize) noexcept {
    if (aTypeNum == 1) {
        switch(aWType) {
        case jsex_nnap_basis_SphericalChebyshev_WTYPE_FUSE: {
            calForce<jsex_nnap_basis_SphericalChebyshev_WTYPE_FUSE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, rFx, rFy, rFz, aForwardCache, rForwardForceCache, aFullCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aL3Max, aL3Cross, aFuseWeight, aFuseSize);
            return;
        }
        case jsex_nnap_basis_SphericalChebyshev_WTYPE_NONE:
        case jsex_nnap_basis_SphericalChebyshev_WTYPE_FULL:
        case jsex_nnap_basis_SphericalChebyshev_WTYPE_EXFULL:
        case jsex_nnap_basis_SphericalChebyshev_WTYPE_DEFAULT: {
            calForce<jsex_nnap_basis_SphericalChebyshev_WTYPE_NONE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, rFx, rFy, rFz, aForwardCache, rForwardForceCache, aFullCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aL3Max, aL3Cross, aFuseWeight, aFuseSize);
            return;
        }
        default: {
            return;
        }}
    } else {
        switch(aWType) {
        case jsex_nnap_basis_SphericalChebyshev_WTYPE_EXFULL: {
            calForce<jsex_nnap_basis_SphericalChebyshev_WTYPE_EXFULL>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, rFx, rFy, rFz, aForwardCache, rForwardForceCache, aFullCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aL3Max, aL3Cross, aFuseWeight, aFuseSize);
            return;
        }
        case jsex_nnap_basis_SphericalChebyshev_WTYPE_FULL: {
            calForce<jsex_nnap_basis_SphericalChebyshev_WTYPE_FULL>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, rFx, rFy, rFz, aForwardCache, rForwardForceCache, aFullCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aL3Max, aL3Cross, aFuseWeight, aFuseSize);
            return;
        }
        case jsex_nnap_basis_SphericalChebyshev_WTYPE_NONE: {
            calForce<jsex_nnap_basis_SphericalChebyshev_WTYPE_NONE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, rFx, rFy, rFz, aForwardCache, rForwardForceCache, aFullCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aL3Max, aL3Cross, aFuseWeight, aFuseSize);
            return;
        }
        case jsex_nnap_basis_SphericalChebyshev_WTYPE_DEFAULT: {
            calForce<jsex_nnap_basis_SphericalChebyshev_WTYPE_DEFAULT>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, rFx, rFy, rFz, aForwardCache, rForwardForceCache, aFullCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aL3Max, aL3Cross, aFuseWeight, aFuseSize);
            return;
        }
        case jsex_nnap_basis_SphericalChebyshev_WTYPE_FUSE: {
            calForce<jsex_nnap_basis_SphericalChebyshev_WTYPE_FUSE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, rFx, rFy, rFz, aForwardCache, rForwardForceCache, aFullCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aL3Max, aL3Cross, aFuseWeight, aFuseSize);
            return;
        }
        default: {
            return;
        }}
    }
}


template <jboolean NO_RADIAL, jint L3MAX, jboolean L3CROSS, jint WTYPE>
static void calBackwardForce(jdouble *aNlDx, jdouble *aNlDy, jdouble *aNlDz, jint *aNlType, jint aNN,
                             jdouble *aNNGrad, jdouble *aGradFx, jdouble *aGradFy, jdouble *aGradFz,
                             jdouble *rGradNNGrad, jdouble *rGradPara,
                             jdouble *aForwardCache, jdouble *aForwardForceCache,
                             jdouble *rBackwardCache, jdouble *rBackwardForceCache, jboolean aFixBasis,
                             jint aTypeNum, jdouble aRCut, jint aNMax, jint aLMax, jdouble *aFuseWeight, jint aFuseSize) noexcept {
    switch (aLMax) {
    case 0: {calBackwardForce<0, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, aGradFx, aGradFy, aGradFz, rGradNNGrad, rGradPara, aForwardCache, aForwardForceCache, rBackwardCache, rBackwardForceCache, aFixBasis, aTypeNum, aRCut, aNMax, aFuseWeight, aFuseSize); return;}
    case 1: {calBackwardForce<1, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, aGradFx, aGradFy, aGradFz, rGradNNGrad, rGradPara, aForwardCache, aForwardForceCache, rBackwardCache, rBackwardForceCache, aFixBasis, aTypeNum, aRCut, aNMax, aFuseWeight, aFuseSize); return;}
    case 2: {calBackwardForce<2, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, aGradFx, aGradFy, aGradFz, rGradNNGrad, rGradPara, aForwardCache, aForwardForceCache, rBackwardCache, rBackwardForceCache, aFixBasis, aTypeNum, aRCut, aNMax, aFuseWeight, aFuseSize); return;}
    case 3: {calBackwardForce<3, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, aGradFx, aGradFy, aGradFz, rGradNNGrad, rGradPara, aForwardCache, aForwardForceCache, rBackwardCache, rBackwardForceCache, aFixBasis, aTypeNum, aRCut, aNMax, aFuseWeight, aFuseSize); return;}
    case 4: {calBackwardForce<4, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, aGradFx, aGradFy, aGradFz, rGradNNGrad, rGradPara, aForwardCache, aForwardForceCache, rBackwardCache, rBackwardForceCache, aFixBasis, aTypeNum, aRCut, aNMax, aFuseWeight, aFuseSize); return;}
    case 5: {calBackwardForce<5, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, aGradFx, aGradFy, aGradFz, rGradNNGrad, rGradPara, aForwardCache, aForwardForceCache, rBackwardCache, rBackwardForceCache, aFixBasis, aTypeNum, aRCut, aNMax, aFuseWeight, aFuseSize); return;}
    case 6: {calBackwardForce<6, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, aGradFx, aGradFy, aGradFz, rGradNNGrad, rGradPara, aForwardCache, aForwardForceCache, rBackwardCache, rBackwardForceCache, aFixBasis, aTypeNum, aRCut, aNMax, aFuseWeight, aFuseSize); return;}
    case 7: {calBackwardForce<7, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, aGradFx, aGradFy, aGradFz, rGradNNGrad, rGradPara, aForwardCache, aForwardForceCache, rBackwardCache, rBackwardForceCache, aFixBasis, aTypeNum, aRCut, aNMax, aFuseWeight, aFuseSize); return;}
    case 8: {calBackwardForce<8, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, aGradFx, aGradFy, aGradFz, rGradNNGrad, rGradPara, aForwardCache, aForwardForceCache, rBackwardCache, rBackwardForceCache, aFixBasis, aTypeNum, aRCut, aNMax, aFuseWeight, aFuseSize); return;}
    case 9: {calBackwardForce<9, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, aGradFx, aGradFy, aGradFz, rGradNNGrad, rGradPara, aForwardCache, aForwardForceCache, rBackwardCache, rBackwardForceCache, aFixBasis, aTypeNum, aRCut, aNMax, aFuseWeight, aFuseSize); return;}
    case 10: {calBackwardForce<10, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, aGradFx, aGradFy, aGradFz, rGradNNGrad, rGradPara, aForwardCache, aForwardForceCache, rBackwardCache, rBackwardForceCache, aFixBasis, aTypeNum, aRCut, aNMax, aFuseWeight, aFuseSize); return;}
    case 11: {calBackwardForce<11, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, aGradFx, aGradFy, aGradFz, rGradNNGrad, rGradPara, aForwardCache, aForwardForceCache, rBackwardCache, rBackwardForceCache, aFixBasis, aTypeNum, aRCut, aNMax, aFuseWeight, aFuseSize); return;}
    case 12: {calBackwardForce<12, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, aGradFx, aGradFy, aGradFz, rGradNNGrad, rGradPara, aForwardCache, aForwardForceCache, rBackwardCache, rBackwardForceCache, aFixBasis, aTypeNum, aRCut, aNMax, aFuseWeight, aFuseSize); return;}
    default: {return;}
    }
}
template <jint L3MAX, jboolean L3CROSS, jint WTYPE>
static void calBackwardForce(jdouble *aNlDx, jdouble *aNlDy, jdouble *aNlDz, jint *aNlType, jint aNN,
                             jdouble *aNNGrad, jdouble *aGradFx, jdouble *aGradFy, jdouble *aGradFz,
                             jdouble *rGradNNGrad, jdouble *rGradPara,
                             jdouble *aForwardCache, jdouble *aForwardForceCache,
                             jdouble *rBackwardCache, jdouble *rBackwardForceCache, jboolean aFixBasis,
                             jint aTypeNum, jdouble aRCut, jint aNMax, jint aLMax, jboolean aNoRadial, jdouble *aFuseWeight, jint aFuseSize) noexcept {
    if (aNoRadial) {
        calBackwardForce<JNI_TRUE, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, aGradFx, aGradFy, aGradFz, rGradNNGrad, rGradPara, aForwardCache, aForwardForceCache, rBackwardCache, rBackwardForceCache, aFixBasis, aTypeNum, aRCut, aNMax, aLMax, aFuseWeight, aFuseSize);
    } else {
        calBackwardForce<JNI_FALSE, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, aGradFx, aGradFy, aGradFz, rGradNNGrad, rGradPara, aForwardCache, aForwardForceCache, rBackwardCache, rBackwardForceCache, aFixBasis, aTypeNum, aRCut, aNMax, aLMax, aFuseWeight, aFuseSize);
    }
}
template <jint WTYPE>
static void calBackwardForce(jdouble *aNlDx, jdouble *aNlDy, jdouble *aNlDz, jint *aNlType, jint aNN,
                             jdouble *aNNGrad, jdouble *aGradFx, jdouble *aGradFy, jdouble *aGradFz,
                             jdouble *rGradNNGrad, jdouble *rGradPara,
                             jdouble *aForwardCache, jdouble *aForwardForceCache,
                             jdouble *rBackwardCache, jdouble *rBackwardForceCache, jboolean aFixBasis,
                             jint aTypeNum, jdouble aRCut, jint aNMax, jint aLMax, jboolean aNoRadial,
                             jint aL3Max, jboolean aL3Cross, jdouble *aFuseWeight, jint aFuseSize) noexcept {
    if (aL3Cross) {
        switch (aL3Max) {
        case 0: case 1: {
            calBackwardForce<0, JNI_FALSE, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, aGradFx, aGradFy, aGradFz, rGradNNGrad, rGradPara, aForwardCache, aForwardForceCache, rBackwardCache, rBackwardForceCache, aFixBasis, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aFuseWeight, aFuseSize);
            return;
        }
        case 2: {
            calBackwardForce<2, JNI_TRUE, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, aGradFx, aGradFy, aGradFz, rGradNNGrad, rGradPara, aForwardCache, aForwardForceCache, rBackwardCache, rBackwardForceCache, aFixBasis, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aFuseWeight, aFuseSize);
            return;
        }
        case 3: {
            calBackwardForce<3, JNI_TRUE, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, aGradFx, aGradFy, aGradFz, rGradNNGrad, rGradPara, aForwardCache, aForwardForceCache, rBackwardCache, rBackwardForceCache, aFixBasis, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aFuseWeight, aFuseSize);
            return;
        }
        case 4: {
            calBackwardForce<4, JNI_TRUE, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, aGradFx, aGradFy, aGradFz, rGradNNGrad, rGradPara, aForwardCache, aForwardForceCache, rBackwardCache, rBackwardForceCache, aFixBasis, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aFuseWeight, aFuseSize);
            return;
        }
        default: {
            return;
        }}
    } else {
        switch (aL3Max) {
        case 0: case 1: {
            calBackwardForce<0, JNI_FALSE, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, aGradFx, aGradFy, aGradFz, rGradNNGrad, rGradPara, aForwardCache, aForwardForceCache, rBackwardCache, rBackwardForceCache, aFixBasis, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aFuseWeight, aFuseSize);
            return;
        }
        case 2: case 3: {
            calBackwardForce<2, JNI_FALSE, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, aGradFx, aGradFy, aGradFz, rGradNNGrad, rGradPara, aForwardCache, aForwardForceCache, rBackwardCache, rBackwardForceCache, aFixBasis, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aFuseWeight, aFuseSize);
            return;
        }
        case 4: {
            calBackwardForce<4, JNI_FALSE, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, aGradFx, aGradFy, aGradFz, rGradNNGrad, rGradPara, aForwardCache, aForwardForceCache, rBackwardCache, rBackwardForceCache, aFixBasis, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aFuseWeight, aFuseSize);
            return;
        }
        default: {
            return;
        }}
    }
}
static void calBackwardForce(jdouble *aNlDx, jdouble *aNlDy, jdouble *aNlDz, jint *aNlType, jint aNN,
                             jdouble *aNNGrad, jdouble *aGradFx, jdouble *aGradFy, jdouble *aGradFz,
                             jdouble *rGradNNGrad, jdouble *rGradPara,
                             jdouble *aForwardCache, jdouble *aForwardForceCache,
                             jdouble *rBackwardCache, jdouble *rBackwardForceCache, jboolean aFixBasis,
                             jint aTypeNum, jdouble aRCut, jint aNMax, jint aLMax, jboolean aNoRadial,
                             jint aL3Max, jboolean aL3Cross, jint aWType, jdouble *aFuseWeight, jint aFuseSize) noexcept {
    if (aTypeNum == 1) {
        switch(aWType) {
        case jsex_nnap_basis_SphericalChebyshev_WTYPE_FUSE: {
            calBackwardForce<jsex_nnap_basis_SphericalChebyshev_WTYPE_FUSE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, aGradFx, aGradFy, aGradFz, rGradNNGrad, rGradPara, aForwardCache, aForwardForceCache, rBackwardCache, rBackwardForceCache, aFixBasis, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aL3Max, aL3Cross, aFuseWeight, aFuseSize);
            return;
        }
        case jsex_nnap_basis_SphericalChebyshev_WTYPE_NONE:
        case jsex_nnap_basis_SphericalChebyshev_WTYPE_FULL:
        case jsex_nnap_basis_SphericalChebyshev_WTYPE_EXFULL:
        case jsex_nnap_basis_SphericalChebyshev_WTYPE_DEFAULT: {
            calBackwardForce<jsex_nnap_basis_SphericalChebyshev_WTYPE_NONE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, aGradFx, aGradFy, aGradFz, rGradNNGrad, rGradPara, aForwardCache, aForwardForceCache, rBackwardCache, rBackwardForceCache, aFixBasis, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aL3Max, aL3Cross, aFuseWeight, aFuseSize);
            return;
        }
        default: {
            return;
        }}
    } else {
        switch(aWType) {
        case jsex_nnap_basis_SphericalChebyshev_WTYPE_EXFULL: {
            calBackwardForce<jsex_nnap_basis_SphericalChebyshev_WTYPE_EXFULL>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, aGradFx, aGradFy, aGradFz, rGradNNGrad, rGradPara, aForwardCache, aForwardForceCache, rBackwardCache, rBackwardForceCache, aFixBasis, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aL3Max, aL3Cross, aFuseWeight, aFuseSize);
            return;
        }
        case jsex_nnap_basis_SphericalChebyshev_WTYPE_FULL: {
            calBackwardForce<jsex_nnap_basis_SphericalChebyshev_WTYPE_FULL>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, aGradFx, aGradFy, aGradFz, rGradNNGrad, rGradPara, aForwardCache, aForwardForceCache, rBackwardCache, rBackwardForceCache, aFixBasis, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aL3Max, aL3Cross, aFuseWeight, aFuseSize);
            return;
        }
        case jsex_nnap_basis_SphericalChebyshev_WTYPE_NONE: {
            calBackwardForce<jsex_nnap_basis_SphericalChebyshev_WTYPE_NONE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, aGradFx, aGradFy, aGradFz, rGradNNGrad, rGradPara, aForwardCache, aForwardForceCache, rBackwardCache, rBackwardForceCache, aFixBasis, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aL3Max, aL3Cross, aFuseWeight, aFuseSize);
            return;
        }
        case jsex_nnap_basis_SphericalChebyshev_WTYPE_DEFAULT: {
            calBackwardForce<jsex_nnap_basis_SphericalChebyshev_WTYPE_DEFAULT>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, aGradFx, aGradFy, aGradFz, rGradNNGrad, rGradPara, aForwardCache, aForwardForceCache, rBackwardCache, rBackwardForceCache, aFixBasis, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aL3Max, aL3Cross, aFuseWeight, aFuseSize);
            return;
        }
        case jsex_nnap_basis_SphericalChebyshev_WTYPE_FUSE: {
            calBackwardForce<jsex_nnap_basis_SphericalChebyshev_WTYPE_FUSE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, aGradFx, aGradFy, aGradFz, rGradNNGrad, rGradPara, aForwardCache, aForwardForceCache, rBackwardCache, rBackwardForceCache, aFixBasis, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aL3Max, aL3Cross, aFuseWeight, aFuseSize);
            return;
        }
        default: {
            return;
        }}
    }
}


extern "C" {

JNIEXPORT void JNICALL Java_jsex_nnap_basis_SphericalChebyshev_forward1(JNIEnv *aEnv, jclass aClazz,
        jdoubleArray aNlDx, jdoubleArray aNlDy, jdoubleArray aNlDz, jintArray aNlType, jint aNN,
        jdoubleArray rFp, jint aShiftFp, jdoubleArray rForwardCache, jint aForwardCacheShift, jboolean aFullCache,
        jint aTypeNum, jdouble aRCut, jint aNMax, jint aLMax, jboolean aNoRadial, jint aL3Max, jboolean aL3Cross, jint aWType, jdoubleArray aFuseWeight, jint aFuseSize) {
    // java array init
    jdouble *tNlDx = (jdouble *)getJArrayBuf(aEnv, aNlDx);
    jdouble *tNlDy = (jdouble *)getJArrayBuf(aEnv, aNlDy);
    jdouble *tNlDz = (jdouble *)getJArrayBuf(aEnv, aNlDz);
    jint *tNlType = (jint *)getJArrayBuf(aEnv, aNlType);
    jdouble *tFp = (jdouble *)getJArrayBuf(aEnv, rFp);
    jdouble *tForwardCache = (jdouble *)getJArrayBuf(aEnv, rForwardCache);
    jdouble *tFuseWeight = aFuseWeight==NULL ? NULL : (jdouble *)getJArrayBuf(aEnv, aFuseWeight);
    
    calFp(tNlDx, tNlDy, tNlDz, tNlType, aNN, tFp+aShiftFp,
          tForwardCache+aForwardCacheShift, aFullCache,
          aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aL3Max, aL3Cross, aWType, tFuseWeight, aFuseSize);
    
    // release java array
    releaseJArrayBuf(aEnv, aNlDx, tNlDx, JNI_ABORT);
    releaseJArrayBuf(aEnv, aNlDy, tNlDy, JNI_ABORT);
    releaseJArrayBuf(aEnv, aNlDz, tNlDz, JNI_ABORT);
    releaseJArrayBuf(aEnv, aNlType, tNlType, JNI_ABORT);
    releaseJArrayBuf(aEnv, rFp, tFp, 0);
    releaseJArrayBuf(aEnv, rForwardCache, tForwardCache, 0);
    if (aFuseWeight!=NULL) releaseJArrayBuf(aEnv, aFuseWeight, tFuseWeight, JNI_ABORT);
}

JNIEXPORT void JNICALL Java_jsex_nnap_basis_SphericalChebyshev_backward1(JNIEnv *aEnv, jclass aClazz,
        jdoubleArray aNlDx, jdoubleArray aNlDy, jdoubleArray aNlDz, jintArray aNlType, jint aNN,
        jdoubleArray aGradFp, jint aShiftGradFp, jdoubleArray rGradPara, jint aShiftGradPara,
        jdoubleArray aForwardCache, jint aForwardCacheShift, jdoubleArray rBackwardCache, jint aBackwardCacheShift,
        jint aTypeNum, jdouble aRCut, jint aNMax, jint aLMax, jboolean aNoRadial, jint aL3Max, jboolean aL3Cross, jint aWType, jint aFuseSize) {
    // java array init
    jdouble *tNlDx = (jdouble *)getJArrayBuf(aEnv, aNlDx);
    jdouble *tNlDy = (jdouble *)getJArrayBuf(aEnv, aNlDy);
    jdouble *tNlDz = (jdouble *)getJArrayBuf(aEnv, aNlDz);
    jint *tNlType = (jint *)getJArrayBuf(aEnv, aNlType);
    jdouble *tGradFp = (jdouble *)getJArrayBuf(aEnv, aGradFp);
    jdouble *tGradPara = (jdouble *)getJArrayBuf(aEnv, rGradPara);
    jdouble *tForwardCache = (jdouble *)getJArrayBuf(aEnv, aForwardCache);
    jdouble *tBackwardCache = (jdouble *)getJArrayBuf(aEnv, rBackwardCache);
    
    calBackward(tNlDx, tNlDy, tNlDz, tNlType, aNN,
                tGradFp+aShiftGradFp, tGradPara+aShiftGradPara,
                tForwardCache+aForwardCacheShift, tBackwardCache+aBackwardCacheShift,
                aTypeNum, aRCut, aNMax, aLMax, aNoRadial,
                aL3Max, aL3Cross, aWType, aFuseSize);
    
    // release java array
    releaseJArrayBuf(aEnv, aNlDx, tNlDx, JNI_ABORT);
    releaseJArrayBuf(aEnv, aNlDy, tNlDy, JNI_ABORT);
    releaseJArrayBuf(aEnv, aNlDz, tNlDz, JNI_ABORT);
    releaseJArrayBuf(aEnv, aNlType, tNlType, JNI_ABORT);
    releaseJArrayBuf(aEnv, aGradFp, tGradFp, JNI_ABORT);
    releaseJArrayBuf(aEnv, rGradPara, tGradPara, 0);
    releaseJArrayBuf(aEnv, aForwardCache, tForwardCache, JNI_ABORT);
    releaseJArrayBuf(aEnv, rBackwardCache, tBackwardCache, 0);
}

JNIEXPORT void JNICALL Java_jsex_nnap_basis_SphericalChebyshev_forwardForce1(JNIEnv *aEnv, jclass aClazz,
        jdoubleArray aNlDx, jdoubleArray aNlDy, jdoubleArray aNlDz, jintArray aNlType, jint aNN,
        jdoubleArray aNNGrad, jint aShiftFp, jdoubleArray rFx, jdoubleArray rFy, jdoubleArray rFz,
        jdoubleArray aForwardCache, jint aForwardCacheShift, jdoubleArray rForwardForceCache, jint aForwardForceCacheShift, jboolean aFullCache,
        jint aTypeNum, jdouble aRCut, jint aNMax, jint aLMax, jboolean aNoRadial, jint aL3Max, jboolean aL3Cross, jint aWType, jdoubleArray aFuseWeight, jint aFuseSize) {
    // java array init
    jdouble *tNlDx = (jdouble *)getJArrayBuf(aEnv, aNlDx);
    jdouble *tNlDy = (jdouble *)getJArrayBuf(aEnv, aNlDy);
    jdouble *tNlDz = (jdouble *)getJArrayBuf(aEnv, aNlDz);
    jint *tNlType = (jint *)getJArrayBuf(aEnv, aNlType);
    jdouble *tNNGrad = (jdouble *)getJArrayBuf(aEnv, aNNGrad);
    jdouble *tFx = (jdouble *)getJArrayBuf(aEnv, rFx);
    jdouble *tFy = (jdouble *)getJArrayBuf(aEnv, rFy);
    jdouble *tFz = (jdouble *)getJArrayBuf(aEnv, rFz);
    jdouble *tForwardCache = (jdouble *)getJArrayBuf(aEnv, aForwardCache);
    jdouble *tForwardForceCache = (jdouble *)getJArrayBuf(aEnv, rForwardForceCache);
    jdouble *tFuseWeight = aFuseWeight==NULL ? NULL : (jdouble *)getJArrayBuf(aEnv, aFuseWeight);
    
    calForce(tNlDx, tNlDy, tNlDz, tNlType, aNN,
             tNNGrad+aShiftFp, tFx, tFy, tFz,
             tForwardCache+aForwardCacheShift, tForwardForceCache+aForwardForceCacheShift, aFullCache,
             aTypeNum, aRCut, aNMax, aLMax, aNoRadial,
             aL3Max, aL3Cross, aWType, tFuseWeight, aFuseSize);
    
    // release java array
    releaseJArrayBuf(aEnv, aNlDx, tNlDx, JNI_ABORT);
    releaseJArrayBuf(aEnv, aNlDy, tNlDy, JNI_ABORT);
    releaseJArrayBuf(aEnv, aNlDz, tNlDz, JNI_ABORT);
    releaseJArrayBuf(aEnv, aNlType, tNlType, JNI_ABORT);
    releaseJArrayBuf(aEnv, aNNGrad, tNNGrad, JNI_ABORT);
    releaseJArrayBuf(aEnv, rFx, tFx, 0);
    releaseJArrayBuf(aEnv, rFy, tFy, 0);
    releaseJArrayBuf(aEnv, rFz, tFz, 0);
    releaseJArrayBuf(aEnv, aForwardCache, tForwardCache, JNI_ABORT);
    releaseJArrayBuf(aEnv, rForwardForceCache, tForwardForceCache, 0);
    if (aFuseWeight!=NULL) releaseJArrayBuf(aEnv, aFuseWeight, tFuseWeight, JNI_ABORT);
}

JNIEXPORT void JNICALL Java_jsex_nnap_basis_SphericalChebyshev_backwardForce1(JNIEnv *aEnv, jclass aClazz,
        jdoubleArray aNlDx, jdoubleArray aNlDy, jdoubleArray aNlDz, jintArray aNlType, jint aNN,
        jdoubleArray aNNGrad, jint aShiftNNGrad, jdoubleArray aGradFx, jdoubleArray aGradFy, jdoubleArray aGradFz,
        jdoubleArray rGradNNGrad, jint aShiftGradNNGrad, jdoubleArray rGradPara, jint aShiftGradPara,
        jdoubleArray aForwardCache, jint aForwardCacheShift, jdoubleArray aForwardForceCache, jint aForwardForceCacheShift,
        jdoubleArray rBackwardCache, jint aBackwardCacheShift, jdoubleArray rBackwardForceCache, jint aBackwardForceCacheShift, jboolean aFixBasis,
        jint aTypeNum, jdouble aRCut, jint aNMax, jint aLMax, jboolean aNoRadial, jint aL3Max, jboolean aL3Cross, jint aWType, jdoubleArray aFuseWeight, jint aFuseSize) {
    // java array init
    jdouble *tNlDx = (jdouble *)getJArrayBuf(aEnv, aNlDx);
    jdouble *tNlDy = (jdouble *)getJArrayBuf(aEnv, aNlDy);
    jdouble *tNlDz = (jdouble *)getJArrayBuf(aEnv, aNlDz);
    jint *tNlType = (jint *)getJArrayBuf(aEnv, aNlType);
    jdouble *tNNGrad = (jdouble *)getJArrayBuf(aEnv, aNNGrad);
    jdouble *tGradFx = (jdouble *)getJArrayBuf(aEnv, aGradFx);
    jdouble *tGradFy = (jdouble *)getJArrayBuf(aEnv, aGradFy);
    jdouble *tGradFz = (jdouble *)getJArrayBuf(aEnv, aGradFz);
    jdouble *tGradNNGrad = (jdouble *)getJArrayBuf(aEnv, rGradNNGrad);
    jdouble *tGradPara = rGradPara==NULL ? NULL : (jdouble *)getJArrayBuf(aEnv, rGradPara);
    jdouble *tForwardCache = (jdouble *)getJArrayBuf(aEnv, aForwardCache);
    jdouble *tForwardForceCache = (jdouble *)getJArrayBuf(aEnv, aForwardForceCache);
    jdouble *tBackwardCache = (jdouble *)getJArrayBuf(aEnv, rBackwardCache);
    jdouble *tBackwardForceCache = (jdouble *)getJArrayBuf(aEnv, rBackwardForceCache);
    jdouble *tFuseWeight = aFuseWeight==NULL ? NULL : (jdouble *)getJArrayBuf(aEnv, aFuseWeight);
    
    calBackwardForce(tNlDx, tNlDy, tNlDz, tNlType, aNN,
                     tNNGrad+aShiftNNGrad, tGradFx, tGradFy, tGradFz,
                     tGradNNGrad+aShiftGradNNGrad, tGradPara==NULL?NULL:(tGradPara+aShiftGradPara),
                     tForwardCache+aForwardCacheShift, tForwardForceCache+aForwardForceCacheShift,
                     tBackwardCache+aBackwardCacheShift, tBackwardForceCache+aBackwardForceCacheShift, aFixBasis,
                     aTypeNum, aRCut, aNMax, aLMax, aNoRadial,
                     aL3Max, aL3Cross, aWType, tFuseWeight, aFuseSize);
    
    // release java array
    releaseJArrayBuf(aEnv, aNlDx, tNlDx, JNI_ABORT);
    releaseJArrayBuf(aEnv, aNlDy, tNlDy, JNI_ABORT);
    releaseJArrayBuf(aEnv, aNlDz, tNlDz, JNI_ABORT);
    releaseJArrayBuf(aEnv, aNlType, tNlType, JNI_ABORT);
    releaseJArrayBuf(aEnv, aNNGrad, tNNGrad, JNI_ABORT);
    releaseJArrayBuf(aEnv, aGradFx, tGradFx, JNI_ABORT);
    releaseJArrayBuf(aEnv, aGradFy, tGradFy, JNI_ABORT);
    releaseJArrayBuf(aEnv, aGradFz, tGradFz, JNI_ABORT);
    releaseJArrayBuf(aEnv, rGradNNGrad, tGradNNGrad, 0);
    if (rGradPara!=NULL) releaseJArrayBuf(aEnv, rGradPara, tGradPara, 0);
    releaseJArrayBuf(aEnv, aForwardCache, tForwardCache, JNI_ABORT);
    releaseJArrayBuf(aEnv, aForwardForceCache, tForwardForceCache, JNI_ABORT);
    releaseJArrayBuf(aEnv, rBackwardCache, tBackwardCache, 0);
    releaseJArrayBuf(aEnv, rBackwardForceCache, tBackwardForceCache, 0);
    if (aFuseWeight!=NULL) releaseJArrayBuf(aEnv, aFuseWeight, tFuseWeight, JNI_ABORT);
}

}
