#include "jsex_nnap_basis_SphericalChebyshev.h"
#include "nnap_util.hpp"


#define SH_LARGEST_L (20)

#define WIGNER_222_000 (-0.23904572186687872)
#define WIGNER_222_011 (0.11952286093343936)
#define WIGNER_222_022 (0.23904572186687872)
#define WIGNER_222_112 (-0.29277002188455997)

#define WIGNER_112_000 (0.3651483716701107)
#define WIGNER_112_011 (-0.3162277660168379)
#define WIGNER_112_110 (0.18257418583505536)
#define WIGNER_112_112 (0.44721359549995787)

#define WIGNER_233_000 (0.19518001458970663)
#define WIGNER_233_011 (-0.14638501094227996)
#define WIGNER_233_022 (-0.0)
#define WIGNER_233_033 (0.2439750182371333)
#define WIGNER_233_110 (-0.06900655593423542)
#define WIGNER_233_220 (-0.2182178902359924)
#define WIGNER_233_112 (0.1889822365046136)
#define WIGNER_233_211 (0.23904572186687872)
#define WIGNER_233_123 (-0.2439750182371333)
#define WIGNER_233_213 (0.15430334996209188)

#define WIGNER_123_000 (-0.29277002188455997)
#define WIGNER_123_011 (0.2760262237369417)
#define WIGNER_123_022 (-0.2182178902359924)
#define WIGNER_123_110 (-0.1690308509457033)
#define WIGNER_123_101 (0.23904572186687872)
#define WIGNER_123_112 (-0.3086066999241838)
#define WIGNER_123_121 ( 0.09759000729485331)
#define WIGNER_123_123 (0.3779644730092272)

#define WIGNER_444_000 (0.13409704688030227)
#define WIGNER_444_011 (-0.06704852344015112)
#define WIGNER_444_022 (-0.08194819531574027)
#define WIGNER_444_033 (0.15644655469368596)
#define WIGNER_444_044 (0.10429770312912397)
#define WIGNER_444_112 (0.14135069854804388)
#define WIGNER_444_224 (0.18698939800169143)
#define WIGNER_444_123 (-0.06232979933389714)
#define WIGNER_444_134 (-0.1649091483060512)

#define WIGNER_224_000 (0.23904572186687872)
#define WIGNER_224_011 (-0.21821789023599236)
#define WIGNER_224_022 (0.15430334996209188)
#define WIGNER_224_110 (0.15936381457791915)
#define WIGNER_224_220 (0.03984095364447979)
#define WIGNER_224_112 (0.25197631533948484)
#define WIGNER_224_224 (0.3333333333333333)
#define WIGNER_224_121 (-0.0890870806374748)
#define WIGNER_224_123 (-0.23570226039551587)

#define WIGNER_334_000 (-0.16116459280507608)
#define WIGNER_334_011 (0.10403129732205986)
#define WIGNER_334_022 (0.046524210519923545)
#define WIGNER_334_033 (-0.21320071635561044)
#define WIGNER_334_110 (0.02686076546751269)
#define WIGNER_334_220 (0.18802535827258873)
#define WIGNER_334_330 (0.08058229640253803)
#define WIGNER_334_112 (-0.1698823971458752)
#define WIGNER_334_224 (-0.2247332874877474)
#define WIGNER_334_121 (-0.15194743527951726)
#define WIGNER_334_123 (0.10050378152592121)
#define WIGNER_334_132 (0.1973855084879307)
#define WIGNER_334_231 (-0.14712247158412492)
#define WIGNER_334_134 (0.17407765595569782)

#define WIGNER_244_000 (-0.1698823971458752)
#define WIGNER_244_011 (0.14440003757399392)
#define WIGNER_244_022 (-0.06795295885835007)
#define WIGNER_244_033 (-0.059458839001056314)
#define WIGNER_244_044 (0.23783535600422528)
#define WIGNER_244_110 (0.046524210519923545)
#define WIGNER_244_220 (0.19738550848793068)
#define WIGNER_244_211 (-0.20806259464411975)
#define WIGNER_244_112 (-0.13241022442571243)
#define WIGNER_244_224 (0.11009637651263607)
#define WIGNER_244_123 (0.19462473604038075)
#define WIGNER_244_213 (-0.1651445647689541)
#define WIGNER_244_134 (-0.2059714602177749)

#define WIGNER_134_000 (0.25197631533948484)
#define WIGNER_134_011 (-0.2439750182371333)
#define WIGNER_134_022 (0.2182178902359924)
#define WIGNER_134_033 (-0.16666666666666669)
#define WIGNER_134_110 (0.1543033499620919)
#define WIGNER_134_101 (-0.19920476822239896)
#define WIGNER_134_112 (0.2439750182371333)
#define WIGNER_134_121 (-0.1091089451179962)
#define WIGNER_134_123 (-0.2886751345948129)
#define WIGNER_134_132 (0.06299407883487121)
#define WIGNER_134_134 (0.33333333333333337)

static constexpr jint L3NCOLS[5] = {0, 0, 2, 4, 9};
static constexpr jint L3NCOLS_NOCROSS[5] = {0, 0, 1, 1, 2};
static constexpr jdouble SH_Alm[(SH_LARGEST_L+2)*(SH_LARGEST_L+1)/2] = {
    0.0,
    0.0, 0.0,
    1.9364916731037085, 0.0, 0.0,
    1.9720265943665387, 2.091650066335189, 0.0, 0.0,
    1.984313483298443, 2.04939015319192, 2.29128784747792, 0.0, 0.0,
    1.98997487421324, 2.03100960115899, 2.1712405933672376, 2.48746859276655, 0.0, 0.0,
    1.9930434571835665, 2.0213149892370277, 2.1139418156609704, 2.301368353023109, 2.6739483914241875, 0.0, 0.0,
    1.9948914348241344, 2.0155644370746373, 2.0816659994661326, 2.207940216581962, 2.4308621740219887, 2.850438562747845, 0.0, 0.0,
    1.996089927833914, 2.011869540407391, 2.0615528128088303, 2.15322168769582, 2.3048861143232218, 2.557041559783794, 3.017804310611087, 0.0, 0.0,
    1.9969111950679366, 2.0093531297410117, 2.048122358357819, 2.1180441711898057, 2.229177150706235, 2.401636346922061, 2.679137506321349, 3.1770662567847086, 0.0, 0.0,
    1.997498435543818, 2.0075614636426526, 2.038688303787511, 2.0939473213563384, 2.179449471770337, 2.3065125189341593, 2.496873044429772, 2.7970572771691153, 3.3291640592396967, 0.0, 0.0,
    1.9979328159850827, 2.006240264773888, 2.031798495964875, 2.0766559657295187, 2.1447610589527217, 2.2430448056157952, 2.3837686425440854, 2.5900450446533423, 2.910959328215754, 3.4749100707788108, 0.0, 0.0,
    1.998263134713633, 2.0052378963551982, 2.026608708444444, 2.0637972912229676, 2.1194781197266463, 2.1981657747106436, 2.307395517477243, 2.460209661583209, 2.680951323690902, 3.021089890583219, 3.614994027406106, 0.0, 0.0,
    1.998520162579474, 2.004459314343183, 2.0225995873897262, 2.053959590644373, 2.100420126042015, 2.165063509461097, 2.252817784447915, 2.3717082451262845, 2.53546276418555, 2.7695585470349866, 3.1277162108561214, 3.75, 0.0, 0.0,
    1.9987240828047461, 2.0038424627162224, 2.019436802675439, 2.0462565272714635, 2.085665361461421, 2.1398475105532757, 2.212182180562894, 2.307927774486216, 2.435532422657966, 2.6093477445855915, 2.8559149146989657, 3.2310988842807022, 3.880424243261593, 0.0, 0.0,
    1.9988885800753267, 2.003345416333104, 2.0168969490698876, 2.040107114108727, 2.0739902137422357, 2.120141504711419, 2.1809662438042814, 2.260078437898682, 2.363017336304797, 2.4986107250941583, 2.6817904466978773, 2.9401072717216916, 3.331480966792211, 4.006690832666208, 0.0, 0.0,
    1.9990231989649345, 2.002939017015334, 2.014825999813336, 2.035116803738375, 2.064582282206258, 2.104417123236605, 2.1563858652847827, 2.2230674720995864, 2.3082731640774234, 2.4177911997760035, 2.5607991541103545, 2.7527763762750106, 3.0222389997200043, 3.4290845264669656, 4.129164564412516, 0.0, 0.0,
    1.999134760937227, 2.002602473449653, 2.013114894621608, 2.03100960115899, 2.0568833780186058, 2.091650066335189, 2.1366369348357592, 2.1937410968480306, 2.265686062395524, 2.356455943866682, 2.4720661623652207, 2.622022120425379, 2.822324793743504, 3.1024184114977142, 3.5241105031922135, 4.248161366991607, 0.0, 0.0,
    1.9992282461607314, 2.0023206350873464, 2.011684617428885, 2.0275875100994063, 2.050498830661811, 2.081130384894172, 2.120501774999912, 2.170043987823959, 2.231763704062155, 2.3085099321848035, 2.404423007708918, 2.5257296658248256, 2.6822461565718467, 2.8904737863674566, 3.1807526624998683, 3.616739979706598, 4.363956650455962, 0.0, 0.0,
    1.9993073592865873, 2.0020822493927, 2.0104767610501466, 2.024705365770985, 2.045142707894042, 2.0723520109148583, 2.1071307505705477, 2.1505813167606567, 2.2042200113840402, 2.27014788693852, 2.351326355949745, 2.452039967047846, 2.5787147157554005, 2.7414640249326636, 2.957271469692045, 3.2573446421352252, 3.7071359757712075, 4.476792006187765, 0.0, 0.0,
    1.9993749023132206, 2.0018788167600157, 2.0094473837049796, 2.0222546987202583, 2.0406034646643136, 2.064945519862449, 2.0959143930173156, 2.1343747458109497, 2.181496864867922, 2.2388700687965297, 2.3086792761230392, 2.393988887964797, 2.499218627891526, 2.630984211674012, 2.7996848562146504, 3.0227707252027662, 3.3322915038553673, 3.7954453500749294, 4.586880604965702, 0.0, 0.0
};
static constexpr jdouble SH_Blm[(SH_LARGEST_L+2)*(SH_LARGEST_L+1)/2] = {
    0.0,
    0.0, 0.0,
    -0.5773502691896257, 0.0, 0.0,
    -0.5163977794943222, -0.4472135954999579, 0.0, 0.0,
    -0.50709255283711, -0.47809144373375745, -0.3779644730092272, 0.0, 0.0,
    -0.5039526306789697, -0.4879500364742666, -0.4364357804719847, -0.3333333333333333, 0.0, 0.0,
    -0.502518907629606, -0.49236596391733095, -0.4605661864718383, -0.40201512610368484, -0.30151134457776363, 0.0, 0.0,
    -0.5017452060042545, -0.4947274449181537, -0.47304991679126607, -0.4345240946267408, -0.3739787960033829, -0.2773500981126146, 0.0, 0.0,
    -0.501280411827603, -0.4961389383568338, -0.4803844614152614, -0.4529108136578383, -0.41137667560372115, -0.35082320772281167, -0.2581988897471611, 0.0, 0.0,
    -0.5009794328681196, -0.4970501217477084, -0.48507125007266594, -0.464420364012824, -0.4338609156373123, -0.39107694443752145, -0.3313667478318056, -0.24253562503633297, 0.0, 0.0,
    -0.5007733956671915, -0.4976726017934395, -0.4882520792370033, -0.47213368521878024, -0.44859602103995444, -0.4163827722217815, -0.3732544513450796, -0.3147557901458535, -0.22941573387056177, 0.0, 0.0,
    -0.5006261743217588, -0.4981167541368988, -0.49051147158797265, -0.4775669329409193, -0.45883146774112354, -0.43355498476206, -0.4005009394574071, -0.3575185993374057, -0.3003757045930553, -0.21821789023599236, 0.0, 0.0,
    -0.5005173307126191, -0.49844478627922684, -0.4921747909480132, -0.4815434123430768, -0.4662524041201569, -0.44582257006028225, -0.4195037983773235, -0.38609367125267213, -0.34352936171490267, -0.2877772315344771, -0.20851441405707477, 0.0, 0.0,
    -0.5004345937369794, -0.4986939463979015, -0.49343516379516894, -0.48454371185234896, -0.4718142596956708, -0.4549247429401158, -0.4333890711087691, -0.4064694223485302, -0.3730019232961255, -0.33100637062042226, -0.27662562992324985, -0.2, 0.0, 0.0,
    -0.5003702332976756, -0.49888765156985887, -0.4944132324730442, -0.48686449556014766, -0.4760952285695233, -0.46188021535170065, -0.44388854123195953, -0.4216370213557839, -0.39440531887330776, -0.361068373539376, -0.3197221015541813, -0.26666666666666666, -0.19245008972987526, 0.0, 0.0,
    -0.5003191829243042, -0.49904122634695197, -0.4951875684721383, -0.4886972804594683, -0.47946330148538413, -0.46732301954611777, -0.4520423357472069, -0.433289122413121, -0.4105878413676265, -0.38323753592253257, -0.3501504876259268, -0.30949223029508643, -0.25770378116168946, -0.18569533817705186, 0.0, 0.0,
    -0.5002780094738025, -0.4991650425568579, -0.4958111521072805, -0.49017034109842594, -0.4821623522493073, -0.4716666306365782, -0.458512369387107, -0.4424625195441246, -0.42318775433267225, -0.40022240757904204, -0.3728852122772354, -0.34012364433710335, -0.3001668056842815, -0.24958252127842895, -0.1796053020267749, 0.0, 0.0,
    -0.5002443195845779, -0.4992663238894528, -0.49632077414756665, -0.4913722879016409, -0.4843594796964828, -0.47519096331149147, -0.4637388957601683, -0.44982890197909525, -0.43322428885910585, -0.41360064512297223, -0.39050309681448225, -0.36326960977236206, -0.33088051609837776, -0.2916230242449912, -0.2421797398482414, -0.17407765595569785, 0.0, 0.0,
    -0.5002164033860247, -0.4993502271458874, -0.496742636335202, -0.49236596391733095, -0.4861724348043977, -0.47809144373375745, -0.4680252333449758, -0.4558423058385518, -0.4413674147523748, -0.4243660920556449, -0.40451991747794525, -0.3813850356982369, -0.3543178312491844, -0.3223291856101521, -0.28375954701028216, -0.23539595453459988, -0.1690308509457033, 0.0, 0.0,
    -0.5001930129390556, -0.4994205136163806, -0.49709581280096005, -0.4931969619160719, -0.4876862083736199, -0.48050809658946525, -0.4715864951351156, -0.4608201518545086, -0.44807611046807744, -0.4331798560007005, -0.41590019592802907, -0.3959251908590268, -0.37282185960072, -0.3459640439281511, -0.3143909967567437, -0.2764920911127051, -0.2291498472826297, -0.1643989873053573, 0.0, 0.0,
    -0.5001732201680236, -0.49947997905846986, -0.49739445855502595, -0.493899022003733, -0.48896343328028025, -0.4825435035810065, -0.4745789978762495, -0.46499055497527714, -0.4536752206382952, -0.44049993648148694, -0.4252918772715756, -0.40782369514309286, -0.38779008546009835, -0.3647686020700426, -0.3381495443514812, -0.3069985248304855, -0.26975001902701096, -0.22337423731498202, -0.16012815380508713, 0.0, 0.0
};
static constexpr jdouble SQRT_LPM_LMM1[(SH_LARGEST_L+1)*(SH_LARGEST_L+1)] = {
    0.0,
    0.0, 1.4142135623730951, 1.4142135623730951,
    0.0, 2.0, 2.449489742783178, 2.449489742783178, 2.0,
    0.0, 2.449489742783178, 3.1622776601683795, 3.4641016151377544, 3.4641016151377544, 3.1622776601683795, 2.449489742783178,
    0.0, 2.8284271247461903, 3.7416573867739413, 4.242640687119285, 4.47213595499958, 4.47213595499958, 4.242640687119285, 3.7416573867739413, 2.8284271247461903,
    0.0, 3.1622776601683795, 4.242640687119285, 4.898979485566356, 5.291502622129181, 5.477225575051661, 5.477225575051661, 5.291502622129181, 4.898979485566356, 4.242640687119285, 3.1622776601683795,
    0.0, 3.4641016151377544, 4.69041575982343, 5.477225575051661, 6.0, 6.324555320336759, 6.48074069840786, 6.48074069840786, 6.324555320336759, 6.0, 5.477225575051661, 4.69041575982343, 3.4641016151377544,
    0.0, 3.7416573867739413, 5.0990195135927845, 6.0, 6.6332495807108, 7.0710678118654755, 7.3484692283495345, 7.483314773547883, 7.483314773547883, 7.3484692283495345, 7.0710678118654755, 6.6332495807108, 6.0, 5.0990195135927845, 3.7416573867739413,
    0.0, 4.0, 5.477225575051661, 6.48074069840786, 7.211102550927978, 7.745966692414834, 8.12403840463596, 8.366600265340756, 8.48528137423857, 8.48528137423857, 8.366600265340756, 8.12403840463596, 7.745966692414834, 7.211102550927978, 6.48074069840786, 5.477225575051661, 4.0,
    0.0, 4.242640687119285, 5.830951894845301, 6.928203230275509, 7.745966692414834, 8.366600265340756, 8.831760866327848, 9.16515138991168, 9.38083151964686, 9.486832980505138, 9.486832980505138, 9.38083151964686, 9.16515138991168, 8.831760866327848, 8.366600265340756, 7.745966692414834, 6.928203230275509, 5.830951894845301, 4.242640687119285,
    0.0, 4.47213595499958, 6.164414002968976, 7.3484692283495345, 8.246211251235321, 8.94427190999916, 9.486832980505138, 9.899494936611665, 10.198039027185569, 10.392304845413264, 10.488088481701515, 10.488088481701515, 10.392304845413264, 10.198039027185569, 9.899494936611665, 9.486832980505138, 8.94427190999916, 8.246211251235321, 7.3484692283495345, 6.164414002968976, 4.47213595499958,
    0.0, 4.69041575982343, 6.48074069840786, 7.745966692414834, 8.717797887081348, 9.486832980505138, 10.099504938362077, 10.583005244258363, 10.954451150103322, 11.224972160321824, 11.40175425099138, 11.489125293076057, 11.489125293076057, 11.40175425099138, 11.224972160321824, 10.954451150103322, 10.583005244258363, 10.099504938362077, 9.486832980505138, 8.717797887081348, 7.745966692414834, 6.48074069840786, 4.69041575982343,
    0.0, 4.898979485566356, 6.782329983125268, 8.12403840463596, 9.16515138991168, 10.0, 10.677078252031311, 11.224972160321824, 11.661903789690601, 12.0, 12.24744871391589, 12.409673645990857, 12.489995996796797, 12.489995996796797, 12.409673645990857, 12.24744871391589, 12.0, 11.661903789690601, 11.224972160321824, 10.677078252031311, 10.0, 9.16515138991168, 8.12403840463596, 6.782329983125268, 4.898979485566356,
    0.0, 5.0990195135927845, 7.0710678118654755, 8.48528137423857, 9.591663046625438, 10.488088481701515, 11.224972160321824, 11.832159566199232, 12.328828005937952, 12.727922061357855, 13.038404810405298, 13.2664991614216, 13.416407864998739, 13.490737563232042, 13.490737563232042, 13.416407864998739, 13.2664991614216, 13.038404810405298, 12.727922061357855, 12.328828005937952, 11.832159566199232, 11.224972160321824, 10.488088481701515, 9.591663046625438, 8.48528137423857, 7.0710678118654755, 5.0990195135927845,
    0.0, 5.291502622129181, 7.3484692283495345, 8.831760866327848, 10.0, 10.954451150103322, 11.74734012447073, 12.409673645990857, 12.96148139681572, 13.416407864998739, 13.784048752090222, 14.071247279470288, 14.2828568570857, 14.422205101855956, 14.491376746189438, 14.491376746189438, 14.422205101855956, 14.2828568570857, 14.071247279470288, 13.784048752090222, 13.416407864998739, 12.96148139681572, 12.409673645990857, 11.74734012447073, 10.954451150103322, 10.0, 8.831760866327848, 7.3484692283495345, 5.291502622129181,
    0.0, 5.477225575051661, 7.615773105863909, 9.16515138991168, 10.392304845413264, 11.40175425099138, 12.24744871391589, 12.96148139681572, 13.564659966250536, 14.071247279470288, 14.491376746189438, 14.832396974191326, 15.0996688705415, 15.297058540778355, 15.427248620541512, 15.491933384829668, 15.491933384829668, 15.427248620541512, 15.297058540778355, 15.0996688705415, 14.832396974191326, 14.491376746189438, 14.071247279470288, 13.564659966250536, 12.96148139681572, 12.24744871391589, 11.40175425099138, 10.392304845413264, 9.16515138991168, 7.615773105863909, 5.477225575051661,
    0.0, 5.656854249492381, 7.874007874011811, 9.486832980505138, 10.770329614269007, 11.832159566199232, 12.727922061357855, 13.490737563232042, 14.142135623730951, 14.696938456699069, 15.165750888103101, 15.556349186104045, 15.874507866387544, 16.1245154965971, 16.30950643030009, 16.431676725154983, 16.492422502470642, 16.492422502470642, 16.431676725154983, 16.30950643030009, 16.1245154965971, 15.874507866387544, 15.556349186104045, 15.165750888103101, 14.696938456699069, 14.142135623730951, 13.490737563232042, 12.727922061357855, 11.832159566199232, 10.770329614269007, 9.486832980505138, 7.874007874011811, 5.656854249492381,
    0.0, 5.830951894845301, 8.12403840463596, 9.797958971132712, 11.135528725660043, 12.24744871391589, 13.19090595827292, 14.0, 14.696938456699069, 15.297058540778355, 15.811388300841896, 16.24807680927192, 16.61324772583615, 16.911534525287763, 17.146428199482248, 17.320508075688775, 17.435595774162696, 17.4928556845359, 17.4928556845359, 17.435595774162696, 17.320508075688775, 17.146428199482248, 16.911534525287763, 16.61324772583615, 16.24807680927192, 15.811388300841896, 15.297058540778355, 14.696938456699069, 14.0, 13.19090595827292, 12.24744871391589, 11.135528725660043, 9.797958971132712, 8.12403840463596, 5.830951894845301,
    0.0, 6.0, 8.366600265340756, 10.099504938362077, 11.489125293076057, 12.649110640673518, 13.638181696985855, 14.491376746189438, 15.231546211727817, 15.874507866387544, 16.431676725154983, 16.911534525287763, 17.320508075688775, 17.663521732655695, 17.944358444926362, 18.16590212458495, 18.33030277982336, 18.439088914585774, 18.49324200890693, 18.49324200890693, 18.439088914585774, 18.33030277982336, 18.16590212458495, 17.944358444926362, 17.663521732655695, 17.320508075688775, 16.911534525287763, 16.431676725154983, 15.874507866387544, 15.231546211727817, 14.491376746189438, 13.638181696985855, 12.649110640673518, 11.489125293076057, 10.099504938362077, 8.366600265340756, 6.0,
    0.0, 6.164414002968976, 8.602325267042627, 10.392304845413264, 11.832159566199232, 13.038404810405298, 14.071247279470288, 14.966629547095765, 15.748015748023622, 16.431676725154983, 17.029386365926403, 17.549928774784245, 18.0, 18.384776310850235, 18.708286933869708, 18.973665961010276, 19.183326093250876, 19.339079605813716, 19.44222209522358, 19.493588689617926, 19.493588689617926, 19.44222209522358, 19.339079605813716, 19.183326093250876, 18.973665961010276, 18.708286933869708, 18.384776310850235, 18.0, 17.549928774784245, 17.029386365926403, 16.431676725154983, 15.748015748023622, 14.966629547095765, 14.071247279470288, 13.038404810405298, 11.832159566199232, 10.392304845413264, 8.602325267042627, 6.164414002968976,
    0.0, 6.324555320336759, 8.831760866327848, 10.677078252031311, 12.165525060596439, 13.416407864998739, 14.491376746189438, 15.427248620541512, 16.24807680927192, 16.97056274847714, 17.60681686165901, 18.16590212458495, 18.65475810617763, 19.078784028338912, 19.44222209522358, 19.748417658131498, 20.0, 20.199009876724155, 20.346989949375804, 20.445048300260872, 20.493901531919196, 20.493901531919196, 20.445048300260872, 20.346989949375804, 20.199009876724155, 20.0, 19.748417658131498, 19.44222209522358, 19.078784028338912, 18.65475810617763, 18.16590212458495, 17.60681686165901, 16.97056274847714, 16.24807680927192, 15.427248620541512, 14.491376746189438, 13.416407864998739, 12.165525060596439, 10.677078252031311, 8.831760866327848, 6.324555320336759
};
static constexpr jdouble SQRT_LPM1_LMM[(SH_LARGEST_L+1)*(SH_LARGEST_L+1)] = {
    0.0,
    1.4142135623730951, 1.4142135623730951, 0.0,
    2.0, 2.449489742783178, 2.449489742783178, 2.0, 0.0,
    2.449489742783178, 3.1622776601683795, 3.4641016151377544, 3.4641016151377544, 3.1622776601683795, 2.449489742783178, 0.0,
    2.8284271247461903, 3.7416573867739413, 4.242640687119285, 4.47213595499958, 4.47213595499958, 4.242640687119285, 3.7416573867739413, 2.8284271247461903, 0.0,
    3.1622776601683795, 4.242640687119285, 4.898979485566356, 5.291502622129181, 5.477225575051661, 5.477225575051661, 5.291502622129181, 4.898979485566356, 4.242640687119285, 3.1622776601683795, 0.0,
    3.4641016151377544, 4.69041575982343, 5.477225575051661, 6.0, 6.324555320336759, 6.48074069840786, 6.48074069840786, 6.324555320336759, 6.0, 5.477225575051661, 4.69041575982343, 3.4641016151377544, 0.0,
    3.7416573867739413, 5.0990195135927845, 6.0, 6.6332495807108, 7.0710678118654755, 7.3484692283495345, 7.483314773547883, 7.483314773547883, 7.3484692283495345, 7.0710678118654755, 6.6332495807108, 6.0, 5.0990195135927845, 3.7416573867739413, 0.0,
    4.0, 5.477225575051661, 6.48074069840786, 7.211102550927978, 7.745966692414834, 8.12403840463596, 8.366600265340756, 8.48528137423857, 8.48528137423857, 8.366600265340756, 8.12403840463596, 7.745966692414834, 7.211102550927978, 6.48074069840786, 5.477225575051661, 4.0, 0.0,
    4.242640687119285, 5.830951894845301, 6.928203230275509, 7.745966692414834, 8.366600265340756, 8.831760866327848, 9.16515138991168, 9.38083151964686, 9.486832980505138, 9.486832980505138, 9.38083151964686, 9.16515138991168, 8.831760866327848, 8.366600265340756, 7.745966692414834, 6.928203230275509, 5.830951894845301, 4.242640687119285, 0.0,
    4.47213595499958, 6.164414002968976, 7.3484692283495345, 8.246211251235321, 8.94427190999916, 9.486832980505138, 9.899494936611665, 10.198039027185569, 10.392304845413264, 10.488088481701515, 10.488088481701515, 10.392304845413264, 10.198039027185569, 9.899494936611665, 9.486832980505138, 8.94427190999916, 8.246211251235321, 7.3484692283495345, 6.164414002968976, 4.47213595499958, 0.0,
    4.69041575982343, 6.48074069840786, 7.745966692414834, 8.717797887081348, 9.486832980505138, 10.099504938362077, 10.583005244258363, 10.954451150103322, 11.224972160321824, 11.40175425099138, 11.489125293076057, 11.489125293076057, 11.40175425099138, 11.224972160321824, 10.954451150103322, 10.583005244258363, 10.099504938362077, 9.486832980505138, 8.717797887081348, 7.745966692414834, 6.48074069840786, 4.69041575982343, 0.0,
    4.898979485566356, 6.782329983125268, 8.12403840463596, 9.16515138991168, 10.0, 10.677078252031311, 11.224972160321824, 11.661903789690601, 12.0, 12.24744871391589, 12.409673645990857, 12.489995996796797, 12.489995996796797, 12.409673645990857, 12.24744871391589, 12.0, 11.661903789690601, 11.224972160321824, 10.677078252031311, 10.0, 9.16515138991168, 8.12403840463596, 6.782329983125268, 4.898979485566356, 0.0,
    5.0990195135927845, 7.0710678118654755, 8.48528137423857, 9.591663046625438, 10.488088481701515, 11.224972160321824, 11.832159566199232, 12.328828005937952, 12.727922061357855, 13.038404810405298, 13.2664991614216, 13.416407864998739, 13.490737563232042, 13.490737563232042, 13.416407864998739, 13.2664991614216, 13.038404810405298, 12.727922061357855, 12.328828005937952, 11.832159566199232, 11.224972160321824, 10.488088481701515, 9.591663046625438, 8.48528137423857, 7.0710678118654755, 5.0990195135927845, 0.0,
    5.291502622129181, 7.3484692283495345, 8.831760866327848, 10.0, 10.954451150103322, 11.74734012447073, 12.409673645990857, 12.96148139681572, 13.416407864998739, 13.784048752090222, 14.071247279470288, 14.2828568570857, 14.422205101855956, 14.491376746189438, 14.491376746189438, 14.422205101855956, 14.2828568570857, 14.071247279470288, 13.784048752090222, 13.416407864998739, 12.96148139681572, 12.409673645990857, 11.74734012447073, 10.954451150103322, 10.0, 8.831760866327848, 7.3484692283495345, 5.291502622129181, 0.0,
    5.477225575051661, 7.615773105863909, 9.16515138991168, 10.392304845413264, 11.40175425099138, 12.24744871391589, 12.96148139681572, 13.564659966250536, 14.071247279470288, 14.491376746189438, 14.832396974191326, 15.0996688705415, 15.297058540778355, 15.427248620541512, 15.491933384829668, 15.491933384829668, 15.427248620541512, 15.297058540778355, 15.0996688705415, 14.832396974191326, 14.491376746189438, 14.071247279470288, 13.564659966250536, 12.96148139681572, 12.24744871391589, 11.40175425099138, 10.392304845413264, 9.16515138991168, 7.615773105863909, 5.477225575051661, 0.0,
    5.656854249492381, 7.874007874011811, 9.486832980505138, 10.770329614269007, 11.832159566199232, 12.727922061357855, 13.490737563232042, 14.142135623730951, 14.696938456699069, 15.165750888103101, 15.556349186104045, 15.874507866387544, 16.1245154965971, 16.30950643030009, 16.431676725154983, 16.492422502470642, 16.492422502470642, 16.431676725154983, 16.30950643030009, 16.1245154965971, 15.874507866387544, 15.556349186104045, 15.165750888103101, 14.696938456699069, 14.142135623730951, 13.490737563232042, 12.727922061357855, 11.832159566199232, 10.770329614269007, 9.486832980505138, 7.874007874011811, 5.656854249492381, 0.0,
    5.830951894845301, 8.12403840463596, 9.797958971132712, 11.135528725660043, 12.24744871391589, 13.19090595827292, 14.0, 14.696938456699069, 15.297058540778355, 15.811388300841896, 16.24807680927192, 16.61324772583615, 16.911534525287763, 17.146428199482248, 17.320508075688775, 17.435595774162696, 17.4928556845359, 17.4928556845359, 17.435595774162696, 17.320508075688775, 17.146428199482248, 16.911534525287763, 16.61324772583615, 16.24807680927192, 15.811388300841896, 15.297058540778355, 14.696938456699069, 14.0, 13.19090595827292, 12.24744871391589, 11.135528725660043, 9.797958971132712, 8.12403840463596, 5.830951894845301, 0.0,
    6.0, 8.366600265340756, 10.099504938362077, 11.489125293076057, 12.649110640673518, 13.638181696985855, 14.491376746189438, 15.231546211727817, 15.874507866387544, 16.431676725154983, 16.911534525287763, 17.320508075688775, 17.663521732655695, 17.944358444926362, 18.16590212458495, 18.33030277982336, 18.439088914585774, 18.49324200890693, 18.49324200890693, 18.439088914585774, 18.33030277982336, 18.16590212458495, 17.944358444926362, 17.663521732655695, 17.320508075688775, 16.911534525287763, 16.431676725154983, 15.874507866387544, 15.231546211727817, 14.491376746189438, 13.638181696985855, 12.649110640673518, 11.489125293076057, 10.099504938362077, 8.366600265340756, 6.0, 0.0,
    6.164414002968976, 8.602325267042627, 10.392304845413264, 11.832159566199232, 13.038404810405298, 14.071247279470288, 14.966629547095765, 15.748015748023622, 16.431676725154983, 17.029386365926403, 17.549928774784245, 18.0, 18.384776310850235, 18.708286933869708, 18.973665961010276, 19.183326093250876, 19.339079605813716, 19.44222209522358, 19.493588689617926, 19.493588689617926, 19.44222209522358, 19.339079605813716, 19.183326093250876, 18.973665961010276, 18.708286933869708, 18.384776310850235, 18.0, 17.549928774784245, 17.029386365926403, 16.431676725154983, 15.748015748023622, 14.966629547095765, 14.071247279470288, 13.038404810405298, 11.832159566199232, 10.392304845413264, 8.602325267042627, 6.164414002968976, 0.0,
    6.324555320336759, 8.831760866327848, 10.677078252031311, 12.165525060596439, 13.416407864998739, 14.491376746189438, 15.427248620541512, 16.24807680927192, 16.97056274847714, 17.60681686165901, 18.16590212458495, 18.65475810617763, 19.078784028338912, 19.44222209522358, 19.748417658131498, 20.0, 20.199009876724155, 20.346989949375804, 20.445048300260872, 20.493901531919196, 20.493901531919196, 20.445048300260872, 20.346989949375804, 20.199009876724155, 20.0, 19.748417658131498, 19.44222209522358, 19.078784028338912, 18.65475810617763, 18.16590212458495, 17.60681686165901, 16.97056274847714, 16.24807680927192, 15.427248620541512, 14.491376746189438, 13.416407864998739, 12.165525060596439, 10.677078252031311, 8.831760866327848, 6.324555320336759, 0.0
};
static constexpr jdouble SQRT_2LM1P3[SH_LARGEST_L+1] = {
    1.0,
    1.7320508075688772,
    2.23606797749979,
    2.6457513110645907,
    3.0,
    3.3166247903554,
    3.605551275463989,
    3.872983346207417,
    4.123105625617661,
    4.358898943540674,
    4.58257569495584,
    4.795831523312719,
    5.0,
    5.196152422706632,
    5.385164807134504,
    5.5677643628300215,
    5.744562646538029,
    5.916079783099616,
    6.082762530298219,
    6.244997998398398,
    6.4031242374328485
};
static constexpr jdouble SQRT_1P1D2L[SH_LARGEST_L+1] = {
    -1.0,
    1.224744871391589,
    1.118033988749895,
    1.0801234497346435,
    1.0606601717798212,
    1.0488088481701516,
    1.0408329997330663,
    1.0350983390135313,
    1.0307764064044151,
    1.0274023338281628,
    1.02469507659596,
    1.02247471629109,
    1.0206207261596576,
    1.0190493307301363,
    1.0177004891982149,
    1.0165300454651272,
    1.015504800579495,
    1.0145993123917847,
    1.0137937550497031,
    1.0130724502589556,
    1.0124228365658292,
};

template <jint L>
static inline void realNormalizedLegendreInterLoop_(jdouble aX, jdouble aY, jdouble *rDest, jdouble &rPll) noexcept {
    static_assert(L > 1, "INVALID L");
    const jint tStartL = L*L + L;
    const jint tStartLmm = (L-1)*(L-1) + (L-1);
    const jint tStartLm2 = (L-2)*(L-2) + (L-2);
    const jint tStartAB = L*(L+1)/2;
    rDest[tStartL] = SH_Alm[tStartAB] * (aX*rDest[tStartLmm] + SH_Blm[tStartAB]*rDest[tStartLm2]);
    for (jint m = 1; m < L-1; ++m) {
        jdouble tPlm = SH_Alm[tStartAB+m] * (aX*rDest[tStartLmm+m] + SH_Blm[tStartAB+m]*rDest[tStartLm2+m]);
        rDest[tStartL+m] = tPlm;
        rDest[tStartL-m] = tPlm;
    }
    jdouble tPlm = aX * SQRT_2LM1P3[L] * rPll;
    rDest[tStartL+(L-1)] = tPlm;
    rDest[tStartL-(L-1)] = tPlm;
    rPll *= (-SQRT_1P1D2L[L] * aY);
    rDest[tStartL+L] = rPll;
    rDest[tStartL-L] = rPll;
}
template <jint LMAX>
static inline void realNormalizedLegendreFull(jdouble aX, jdouble aY, jdouble *rDest) noexcept {
    jdouble tPll = 0.28209479177387814347403972578039; // = sqrt(1/(4*PI))
    rDest[0] = tPll;
    if (LMAX == 0) return;
    rDest[2] = SQRT3 * aX * tPll;
    tPll *= (-SQRT3DIV2 * aY);
    rDest[2+1] = tPll;
    rDest[2-1] = tPll;
    if (LMAX == 1) return;
    realNormalizedLegendreInterLoop_<2>(aX, aY, rDest, tPll);
    if (LMAX == 2) return;
    realNormalizedLegendreInterLoop_<3>(aX, aY, rDest, tPll);
    if (LMAX == 3) return;
    realNormalizedLegendreInterLoop_<4>(aX, aY, rDest, tPll);
    if (LMAX == 4) return;
    realNormalizedLegendreInterLoop_<5>(aX, aY, rDest, tPll);
    if (LMAX == 5) return;
    realNormalizedLegendreInterLoop_<6>(aX, aY, rDest, tPll);
    if (LMAX == 6) return;
    realNormalizedLegendreInterLoop_<7>(aX, aY, rDest, tPll);
    if (LMAX == 7) return;
    realNormalizedLegendreInterLoop_<8>(aX, aY, rDest, tPll);
}

template <jint M, jint LMAX>
static inline void realSphericalHarmonicsFull4InterLoop_(jdouble aCosPhi2, jdouble &rSinMPhi, jdouble &rSinMmmPhi, jdouble &rCosMPhi, jdouble &rCosMmmPhi, jdouble *rDest) noexcept {
    const jdouble fSqrt2CosMPhi = SQRT2*rCosMPhi;
    const jdouble fSqrt2SinMPhi = SQRT2*rSinMPhi;
    for (jint l = M; l <= LMAX; ++l) {
        rDest[l*l+l + M] *= fSqrt2CosMPhi;
        rDest[l*l+l - M] *= fSqrt2SinMPhi;
    }
    jdouble tSinMppPhi = aCosPhi2 * rSinMPhi - rSinMmmPhi;
    jdouble tCosMppPhi = aCosPhi2 * rCosMPhi - rCosMmmPhi;
    rSinMmmPhi = rSinMPhi; rCosMmmPhi = rCosMPhi;
    rSinMPhi = tSinMppPhi; rCosMPhi = tCosMppPhi;
}
template <jint LMAX>
static inline void realSphericalHarmonicsFull4(jdouble aX, jdouble aY, jdouble aZ, jdouble aDis, jdouble *rDest) noexcept {
    jdouble tXY = hypot(aX, aY);
    jdouble tCosTheta = aZ / aDis;
    jdouble tSinTheta = tXY / aDis;
    jdouble tCosPhi;
    jdouble tSinPhi;
    // avoid nan
    if (JSE_NNAP::numericEqual(tXY, 0.0)) {
        tCosPhi = 1.0;
        tSinPhi = 0.0;
    } else {
        tCosPhi = aX / tXY;
        tSinPhi = aY / tXY;
    }
    // cal real Legendre
    realNormalizedLegendreFull<LMAX>(tCosTheta, tSinTheta, rDest);
    if (LMAX == 0) return;
    // cal sinMPhi & conMPhi
    jdouble rSinMmmPhi = 0.0;
    jdouble rCosMmmPhi = 1.0;
    jdouble rSinMPhi = tSinPhi;
    jdouble rCosMPhi = tCosPhi;
    const jdouble tCosPhi2 = rCosMPhi+rCosMPhi;
    realSphericalHarmonicsFull4InterLoop_<1, LMAX>(tCosPhi2, rSinMPhi, rSinMmmPhi, rCosMPhi, rCosMmmPhi, rDest);
    if (LMAX == 1) return;
    realSphericalHarmonicsFull4InterLoop_<2, LMAX>(tCosPhi2, rSinMPhi, rSinMmmPhi, rCosMPhi, rCosMmmPhi, rDest);
    if (LMAX == 2) return;
    realSphericalHarmonicsFull4InterLoop_<3, LMAX>(tCosPhi2, rSinMPhi, rSinMmmPhi, rCosMPhi, rCosMmmPhi, rDest);
    if (LMAX == 3) return;
    realSphericalHarmonicsFull4InterLoop_<4, LMAX>(tCosPhi2, rSinMPhi, rSinMmmPhi, rCosMPhi, rCosMmmPhi, rDest);
    if (LMAX == 4) return;
    realSphericalHarmonicsFull4InterLoop_<5, LMAX>(tCosPhi2, rSinMPhi, rSinMmmPhi, rCosMPhi, rCosMmmPhi, rDest);
    if (LMAX == 5) return;
    realSphericalHarmonicsFull4InterLoop_<6, LMAX>(tCosPhi2, rSinMPhi, rSinMmmPhi, rCosMPhi, rCosMmmPhi, rDest);
    if (LMAX == 6) return;
    realSphericalHarmonicsFull4InterLoop_<7, LMAX>(tCosPhi2, rSinMPhi, rSinMmmPhi, rCosMPhi, rCosMmmPhi, rDest);
    if (LMAX == 7) return;
    realSphericalHarmonicsFull4InterLoop_<8, LMAX>(tCosPhi2, rSinMPhi, rSinMmmPhi, rCosMPhi, rCosMmmPhi, rDest);
}

template <jint NMAX, jint LMALL>
static inline void calBnlm(jdouble *rBnlm, jdouble *aY, jdouble aFc, jdouble *aRn) noexcept {
    for (jint n = 0, i = 0; n <= NMAX; ++n) {
        jdouble tMul = aFc*aRn[n];
        for (jint k = 0; k < LMALL; ++k, ++i) {
            rBnlm[i] = tMul*aY[k];
        }
    }
}
template <jint LMALL>
static inline void calBnlm(jdouble *rBnlm, jdouble *aY, jdouble aFc, jdouble *aRn, jint aNMax) noexcept {
    switch (aNMax) {
    case 0: {calBnlm<0, LMALL>(rBnlm, aY, aFc, aRn); return;}
    case 1: {calBnlm<1, LMALL>(rBnlm, aY, aFc, aRn); return;}
    case 2: {calBnlm<2, LMALL>(rBnlm, aY, aFc, aRn); return;}
    case 3: {calBnlm<3, LMALL>(rBnlm, aY, aFc, aRn); return;}
    case 4: {calBnlm<4, LMALL>(rBnlm, aY, aFc, aRn); return;}
    case 5: {calBnlm<5, LMALL>(rBnlm, aY, aFc, aRn); return;}
    case 6: {calBnlm<6, LMALL>(rBnlm, aY, aFc, aRn); return;}
    case 7: {calBnlm<7, LMALL>(rBnlm, aY, aFc, aRn); return;}
    case 8: {calBnlm<8, LMALL>(rBnlm, aY, aFc, aRn); return;}
    case 9: {calBnlm<9, LMALL>(rBnlm, aY, aFc, aRn); return;}
    case 10: {calBnlm<10, LMALL>(rBnlm, aY, aFc, aRn); return;}
    case 11: {calBnlm<11, LMALL>(rBnlm, aY, aFc, aRn); return;}
    case 12: {calBnlm<12, LMALL>(rBnlm, aY, aFc, aRn); return;}
    case 13: {calBnlm<13, LMALL>(rBnlm, aY, aFc, aRn); return;}
    case 14: {calBnlm<14, LMALL>(rBnlm, aY, aFc, aRn); return;}
    case 15: {calBnlm<15, LMALL>(rBnlm, aY, aFc, aRn); return;}
    case 16: {calBnlm<16, LMALL>(rBnlm, aY, aFc, aRn); return;}
    case 17: {calBnlm<17, LMALL>(rBnlm, aY, aFc, aRn); return;}
    case 18: {calBnlm<18, LMALL>(rBnlm, aY, aFc, aRn); return;}
    case 19: {calBnlm<19, LMALL>(rBnlm, aY, aFc, aRn); return;}
    case 20: {calBnlm<20, LMALL>(rBnlm, aY, aFc, aRn); return;}
    default: {return;}
    }
}
template <jint N>
static inline void mplusBnlm2Cnlm(jdouble *rCnlm, jdouble *aBnlm, jdouble aWt) noexcept {
    for (jint i = 0; i < N; ++i) {
        rCnlm[i] += aWt*aBnlm[i];
    }
}
template <jint LMALL>
static inline void mplusBnlm2Cnlm(jdouble *rCnlm, jdouble *aBnlm, jdouble aWt, jint aNMax) noexcept {
    switch (aNMax) {
    case 0: {mplusBnlm2Cnlm<(0+1)*LMALL>(rCnlm, aBnlm, aWt); return;}
    case 1: {mplusBnlm2Cnlm<(1+1)*LMALL>(rCnlm, aBnlm, aWt); return;}
    case 2: {mplusBnlm2Cnlm<(2+1)*LMALL>(rCnlm, aBnlm, aWt); return;}
    case 3: {mplusBnlm2Cnlm<(3+1)*LMALL>(rCnlm, aBnlm, aWt); return;}
    case 4: {mplusBnlm2Cnlm<(4+1)*LMALL>(rCnlm, aBnlm, aWt); return;}
    case 5: {mplusBnlm2Cnlm<(5+1)*LMALL>(rCnlm, aBnlm, aWt); return;}
    case 6: {mplusBnlm2Cnlm<(6+1)*LMALL>(rCnlm, aBnlm, aWt); return;}
    case 7: {mplusBnlm2Cnlm<(7+1)*LMALL>(rCnlm, aBnlm, aWt); return;}
    case 8: {mplusBnlm2Cnlm<(8+1)*LMALL>(rCnlm, aBnlm, aWt); return;}
    case 9: {mplusBnlm2Cnlm<(9+1)*LMALL>(rCnlm, aBnlm, aWt); return;}
    case 10: {mplusBnlm2Cnlm<(10+1)*LMALL>(rCnlm, aBnlm, aWt); return;}
    case 11: {mplusBnlm2Cnlm<(11+1)*LMALL>(rCnlm, aBnlm, aWt); return;}
    case 12: {mplusBnlm2Cnlm<(12+1)*LMALL>(rCnlm, aBnlm, aWt); return;}
    case 13: {mplusBnlm2Cnlm<(13+1)*LMALL>(rCnlm, aBnlm, aWt); return;}
    case 14: {mplusBnlm2Cnlm<(14+1)*LMALL>(rCnlm, aBnlm, aWt); return;}
    case 15: {mplusBnlm2Cnlm<(15+1)*LMALL>(rCnlm, aBnlm, aWt); return;}
    case 16: {mplusBnlm2Cnlm<(16+1)*LMALL>(rCnlm, aBnlm, aWt); return;}
    case 17: {mplusBnlm2Cnlm<(17+1)*LMALL>(rCnlm, aBnlm, aWt); return;}
    case 18: {mplusBnlm2Cnlm<(18+1)*LMALL>(rCnlm, aBnlm, aWt); return;}
    case 19: {mplusBnlm2Cnlm<(19+1)*LMALL>(rCnlm, aBnlm, aWt); return;}
    case 20: {mplusBnlm2Cnlm<(20+1)*LMALL>(rCnlm, aBnlm, aWt); return;}
    default: {return;}
    }
}

template <jint NMAX, jint LMALL>
static inline void mplusCnlm(jdouble *rCnlm, jdouble *aY, jdouble aFc, jdouble *aRn) noexcept {
    for (jint n = 0, i = 0; n <= NMAX; ++n) {
        jdouble tMul = aFc*aRn[n];
        for (jint k = 0; k < LMALL; ++k, ++i) {
            rCnlm[i] += tMul*aY[k];
        }
    }
}
template <jint LMALL>
static inline void mplusCnlm(jdouble *rCnlm, jdouble *aY, jdouble aFc, jdouble *aRn, jint aNMax) noexcept {
    switch (aNMax) {
    case 0: {mplusCnlm<0, LMALL>(rCnlm, aY, aFc, aRn); return;}
    case 1: {mplusCnlm<1, LMALL>(rCnlm, aY, aFc, aRn); return;}
    case 2: {mplusCnlm<2, LMALL>(rCnlm, aY, aFc, aRn); return;}
    case 3: {mplusCnlm<3, LMALL>(rCnlm, aY, aFc, aRn); return;}
    case 4: {mplusCnlm<4, LMALL>(rCnlm, aY, aFc, aRn); return;}
    case 5: {mplusCnlm<5, LMALL>(rCnlm, aY, aFc, aRn); return;}
    case 6: {mplusCnlm<6, LMALL>(rCnlm, aY, aFc, aRn); return;}
    case 7: {mplusCnlm<7, LMALL>(rCnlm, aY, aFc, aRn); return;}
    case 8: {mplusCnlm<8, LMALL>(rCnlm, aY, aFc, aRn); return;}
    case 9: {mplusCnlm<9, LMALL>(rCnlm, aY, aFc, aRn); return;}
    case 10: {mplusCnlm<10, LMALL>(rCnlm, aY, aFc, aRn); return;}
    case 11: {mplusCnlm<11, LMALL>(rCnlm, aY, aFc, aRn); return;}
    case 12: {mplusCnlm<12, LMALL>(rCnlm, aY, aFc, aRn); return;}
    case 13: {mplusCnlm<13, LMALL>(rCnlm, aY, aFc, aRn); return;}
    case 14: {mplusCnlm<14, LMALL>(rCnlm, aY, aFc, aRn); return;}
    case 15: {mplusCnlm<15, LMALL>(rCnlm, aY, aFc, aRn); return;}
    case 16: {mplusCnlm<16, LMALL>(rCnlm, aY, aFc, aRn); return;}
    case 17: {mplusCnlm<17, LMALL>(rCnlm, aY, aFc, aRn); return;}
    case 18: {mplusCnlm<18, LMALL>(rCnlm, aY, aFc, aRn); return;}
    case 19: {mplusCnlm<19, LMALL>(rCnlm, aY, aFc, aRn); return;}
    case 20: {mplusCnlm<20, LMALL>(rCnlm, aY, aFc, aRn); return;}
    default: {return;}
    }
}
template <jint NMAX, jint LMALL>
static inline void mplusCnlmWt(jdouble *rCnlm, jdouble *rCnlmWt, jdouble *aY, jdouble aFc, jdouble *aRn, jdouble aWt) noexcept {
    for (jint n = 0, i = 0; n <= NMAX; ++n) {
        jdouble tMul = aFc*aRn[n];
        jdouble tMulWt = aWt*tMul;
        for (jint k = 0; k < LMALL; ++k, ++i) {
            jdouble subY = aY[k];
            rCnlm[i] += tMul*subY;
            rCnlmWt[i] += tMulWt*subY;
        }
    }
}
template <jint LMALL>
static inline void mplusCnlmWt(jdouble *rCnlm, jdouble *rCnlmWt, jdouble *aY, jdouble aFc, jdouble *aRn, jdouble aWt, jint aNMax) noexcept {
    switch (aNMax) {
    case 0: {mplusCnlmWt<0, LMALL>(rCnlm, rCnlmWt, aY, aFc, aRn, aWt); return;}
    case 1: {mplusCnlmWt<1, LMALL>(rCnlm, rCnlmWt, aY, aFc, aRn, aWt); return;}
    case 2: {mplusCnlmWt<2, LMALL>(rCnlm, rCnlmWt, aY, aFc, aRn, aWt); return;}
    case 3: {mplusCnlmWt<3, LMALL>(rCnlm, rCnlmWt, aY, aFc, aRn, aWt); return;}
    case 4: {mplusCnlmWt<4, LMALL>(rCnlm, rCnlmWt, aY, aFc, aRn, aWt); return;}
    case 5: {mplusCnlmWt<5, LMALL>(rCnlm, rCnlmWt, aY, aFc, aRn, aWt); return;}
    case 6: {mplusCnlmWt<6, LMALL>(rCnlm, rCnlmWt, aY, aFc, aRn, aWt); return;}
    case 7: {mplusCnlmWt<7, LMALL>(rCnlm, rCnlmWt, aY, aFc, aRn, aWt); return;}
    case 8: {mplusCnlmWt<8, LMALL>(rCnlm, rCnlmWt, aY, aFc, aRn, aWt); return;}
    case 9: {mplusCnlmWt<9, LMALL>(rCnlm, rCnlmWt, aY, aFc, aRn, aWt); return;}
    case 10: {mplusCnlmWt<10, LMALL>(rCnlm, rCnlmWt, aY, aFc, aRn, aWt); return;}
    case 11: {mplusCnlmWt<11, LMALL>(rCnlm, rCnlmWt, aY, aFc, aRn, aWt); return;}
    case 12: {mplusCnlmWt<12, LMALL>(rCnlm, rCnlmWt, aY, aFc, aRn, aWt); return;}
    case 13: {mplusCnlmWt<13, LMALL>(rCnlm, rCnlmWt, aY, aFc, aRn, aWt); return;}
    case 14: {mplusCnlmWt<14, LMALL>(rCnlm, rCnlmWt, aY, aFc, aRn, aWt); return;}
    case 15: {mplusCnlmWt<15, LMALL>(rCnlm, rCnlmWt, aY, aFc, aRn, aWt); return;}
    case 16: {mplusCnlmWt<16, LMALL>(rCnlm, rCnlmWt, aY, aFc, aRn, aWt); return;}
    case 17: {mplusCnlmWt<17, LMALL>(rCnlm, rCnlmWt, aY, aFc, aRn, aWt); return;}
    case 18: {mplusCnlmWt<18, LMALL>(rCnlm, rCnlmWt, aY, aFc, aRn, aWt); return;}
    case 19: {mplusCnlmWt<19, LMALL>(rCnlm, rCnlmWt, aY, aFc, aRn, aWt); return;}
    case 20: {mplusCnlmWt<20, LMALL>(rCnlm, rCnlmWt, aY, aFc, aRn, aWt); return;}
    default: {return;}
    }
}

template <jint N>
static inline jdouble dotBnlmGradCnlm(jdouble *aBnlm, jdouble *aGradCnlm) noexcept {
    jdouble rDot = 0.0;
    for (jint i = 0; i < N; ++i) {
        rDot += aBnlm[i]*aGradCnlm[i];
    }
    return rDot;
}
template <jint LMALL>
static inline jdouble dotBnlmGradCnlm(jdouble *aBnlm, jdouble *aGradCnlm, jint aNMax) noexcept {
    switch (aNMax) {
    case 0: {return dotBnlmGradCnlm<(0+1)*LMALL>(aBnlm, aGradCnlm);}
    case 1: {return dotBnlmGradCnlm<(1+1)*LMALL>(aBnlm, aGradCnlm);}
    case 2: {return dotBnlmGradCnlm<(2+1)*LMALL>(aBnlm, aGradCnlm);}
    case 3: {return dotBnlmGradCnlm<(3+1)*LMALL>(aBnlm, aGradCnlm);}
    case 4: {return dotBnlmGradCnlm<(4+1)*LMALL>(aBnlm, aGradCnlm);}
    case 5: {return dotBnlmGradCnlm<(5+1)*LMALL>(aBnlm, aGradCnlm);}
    case 6: {return dotBnlmGradCnlm<(6+1)*LMALL>(aBnlm, aGradCnlm);}
    case 7: {return dotBnlmGradCnlm<(7+1)*LMALL>(aBnlm, aGradCnlm);}
    case 8: {return dotBnlmGradCnlm<(8+1)*LMALL>(aBnlm, aGradCnlm);}
    case 9: {return dotBnlmGradCnlm<(9+1)*LMALL>(aBnlm, aGradCnlm);}
    case 10: {return dotBnlmGradCnlm<(10+1)*LMALL>(aBnlm, aGradCnlm);}
    case 11: {return dotBnlmGradCnlm<(11+1)*LMALL>(aBnlm, aGradCnlm);}
    case 12: {return dotBnlmGradCnlm<(12+1)*LMALL>(aBnlm, aGradCnlm);}
    case 13: {return dotBnlmGradCnlm<(13+1)*LMALL>(aBnlm, aGradCnlm);}
    case 14: {return dotBnlmGradCnlm<(14+1)*LMALL>(aBnlm, aGradCnlm);}
    case 15: {return dotBnlmGradCnlm<(15+1)*LMALL>(aBnlm, aGradCnlm);}
    case 16: {return dotBnlmGradCnlm<(16+1)*LMALL>(aBnlm, aGradCnlm);}
    case 17: {return dotBnlmGradCnlm<(17+1)*LMALL>(aBnlm, aGradCnlm);}
    case 18: {return dotBnlmGradCnlm<(18+1)*LMALL>(aBnlm, aGradCnlm);}
    case 19: {return dotBnlmGradCnlm<(19+1)*LMALL>(aBnlm, aGradCnlm);}
    case 20: {return dotBnlmGradCnlm<(20+1)*LMALL>(aBnlm, aGradCnlm);}
    default: {return 0.0;}
    }
}

template <jint LMALL>
static inline void gradBnlm2Fxyz(jint j, jdouble *aGradBnlm, jdouble *rGradY,
                                 jdouble *aY, jdouble aFc, jdouble *aRn, jint aNMax,
                                 jdouble aFcPx, jdouble aFcPy, jdouble aFcPz,
                                 jdouble *aRnPx, jdouble *aRnPy, jdouble *aRnPz,
                                 jdouble *aYPx, jdouble *aYPy, jdouble *aYPz,
                                 jdouble *rFx, jdouble *rFy, jdouble *rFz) noexcept {
    // clear gradY here
    for (jint k = 0; k < LMALL; ++k) {
        rGradY[k] = 0.0;
    }
    jdouble tGradFc = 0.0;
    jdouble rFxj = 0.0, rFyj = 0.0, rFzj = 0.0;
    jdouble *tGradBnlm = aGradBnlm;
    for (jint n = 0; n <= aNMax; ++n, tGradBnlm+=LMALL) {
        jdouble tRnn = aRn[n];
        jdouble tMul = aFc * tRnn;
        jdouble tGradRn = 0.0;
        for (jint k = 0; k < LMALL; ++k) {
            jdouble subGradBnlm = tGradBnlm[k];
            rGradY[k] += tMul * subGradBnlm;
            tGradRn += aY[k] * subGradBnlm;
        }
        tGradFc += tRnn * tGradRn;
        tGradRn *= aFc;
        rFxj += tGradRn*aRnPx[n];
        rFyj += tGradRn*aRnPy[n];
        rFzj += tGradRn*aRnPz[n];
    }
    for (jint k = 0; k < LMALL; ++k) {
        jdouble subGradY = rGradY[k];
        rFxj += subGradY*aYPx[k];
        rFyj += subGradY*aYPy[k];
        rFzj += subGradY*aYPz[k];
    }
    rFxj += aFcPx*tGradFc;
    rFyj += aFcPy*tGradFc;
    rFzj += aFcPz*tGradFc;
    rFx[j] += rFxj; rFy[j] += rFyj; rFz[j] += rFzj;
}
template <jint LMALL>
static inline void gradCnlmWt2Fxyz(jint j, jdouble *aGradCnlm, jdouble *aGradCnlmWt, jdouble *rGradY,
                                   jdouble *aY, jdouble aFc, jdouble *aRn, jdouble aWt, jint aNMax,
                                   jdouble aFcPx, jdouble aFcPy, jdouble aFcPz,
                                   jdouble *aRnPx, jdouble *aRnPy, jdouble *aRnPz,
                                   jdouble *aYPx, jdouble *aYPy, jdouble *aYPz,
                                   jdouble *rFx, jdouble *rFy, jdouble *rFz) noexcept {
    // clear gradY here
    for (jint k = 0; k < LMALL; ++k) {
        rGradY[k] = 0.0;
    }
    jdouble tGradFc = 0.0;
    jdouble rFxj = 0.0, rFyj = 0.0, rFzj = 0.0;
    jdouble *tGradCnlm = aGradCnlm;
    jdouble *tGradCnlmWt = aGradCnlmWt;
    for (jint n = 0; n <= aNMax; ++n, tGradCnlm+=LMALL, tGradCnlmWt+=LMALL) {
        jdouble tRnn = aRn[n];
        jdouble tMul = aFc * tRnn;
        jdouble tGradRn = 0.0;
        for (jint k = 0; k < LMALL; ++k) {
            jdouble subGradBnlm = tGradCnlm[k] + aWt*tGradCnlmWt[k];
            rGradY[k] += tMul * subGradBnlm;
            tGradRn += aY[k] * subGradBnlm;
        }
        tGradFc += tRnn * tGradRn;
        tGradRn *= aFc;
        rFxj += tGradRn*aRnPx[n];
        rFyj += tGradRn*aRnPy[n];
        rFzj += tGradRn*aRnPz[n];
    }
    for (jint k = 0; k < LMALL; ++k) {
        jdouble subGradY = rGradY[k];
        rFxj += subGradY*aYPx[k];
        rFyj += subGradY*aYPy[k];
        rFzj += subGradY*aYPz[k];
    }
    rFxj += aFcPx*tGradFc;
    rFyj += aFcPy*tGradFc;
    rFzj += aFcPz*tGradFc;
    rFx[j] += rFxj; rFy[j] += rFyj; rFz[j] += rFzj;
}

template <jint L>
static inline void calL2Sub_(jdouble *aCnlm, jdouble *rFp) noexcept {
    const jint tLen = L+L+1;
    jdouble rDot = JSE_NNAP::dot<tLen>(aCnlm + (L*L));
    rFp[L-1] = (PI4/(jdouble)tLen) * rDot;
}
template <jint LMAX, jboolean NO_RADIAL>
static void calL2_(jdouble *aCnlm, jdouble *rFp) noexcept {
    // l == 0
    jdouble tCnl0;
    jdouble tMul;
    jdouble *tFp = rFp;
    if (!NO_RADIAL) {
        tCnl0 = aCnlm[0];
        tMul = PI4;
        tFp[0] = tMul * (tCnl0*tCnl0);
        ++tFp;
    }
    if (LMAX == 0) return;
    calL2Sub_<1>(aCnlm, tFp);
    if (LMAX == 1) return;
    calL2Sub_<2>(aCnlm, tFp);
    if (LMAX == 2) return;
    calL2Sub_<3>(aCnlm, tFp);
    if (LMAX == 3) return;
    calL2Sub_<4>(aCnlm, tFp);
    if (LMAX == 4) return;
    calL2Sub_<5>(aCnlm, tFp);
    if (LMAX == 5) return;
    calL2Sub_<6>(aCnlm, tFp);
    if (LMAX == 6) return;
    calL2Sub_<7>(aCnlm, tFp);
    if (LMAX == 7) return;
    calL2Sub_<8>(aCnlm, tFp);
}
template <jint L3MAX, jboolean L3CROSS>
static void calL3_(jdouble *aCnlm, jdouble *rFp, jint aLMax, jboolean aNoRadial) noexcept {
    if (L3MAX <= 1) return;
    jint tIdxFP = aNoRadial ? aLMax : (aLMax+1);
    /// l1 = l2 = l3 = 2
    jdouble c20  = aCnlm[(2*2+2)  ];
    jdouble c21  = aCnlm[(2*2+2)+1];
    jdouble c2n1 = aCnlm[(2*2+2)-1];
    jdouble c22  = aCnlm[(2*2+2)+2];
    jdouble c2n2 = aCnlm[(2*2+2)-2];
    jdouble rFp3 = 0.0;
    rFp3 += WIGNER_222_000 * c20*c20*c20;
    rFp3 -= (3.0*WIGNER_222_011) * c20 * (c21*c21 + c2n1*c2n1);
    rFp3 += (3.0*WIGNER_222_022) * c20 * (c22*c22 + c2n2*c2n2);
    rFp3 += (3.0*SQRT2_INV*WIGNER_222_112) * c22 * (c21*c21 - c2n1*c2n1);
    rFp3 += (6.0*SQRT2_INV*WIGNER_222_112) * c21*c2n1*c2n2;
    rFp[tIdxFP] = rFp3;
    ++tIdxFP;
    jdouble c10, c11, c1n1;
    if (L3CROSS) {
        /// l1 = l2 = 1, l3 = 2
        c10  = aCnlm[(1+1)  ];
        c11  = aCnlm[(1+1)+1];
        c1n1 = aCnlm[(1+1)-1];
        rFp3 = 0.0;
        rFp3 += WIGNER_112_000 * c10*c10*c20;
        rFp3 -= WIGNER_112_110 * c20 * (c11*c11 + c1n1*c1n1);
        rFp3 -= (2.0*WIGNER_112_011) * c10 * (c11*c21 + c1n1*c2n1);
        rFp3 += (SQRT2_INV*WIGNER_112_112) * c22 * (c11*c11 - c1n1*c1n1);
        rFp3 += (2.0*SQRT2_INV*WIGNER_112_112) * c11*c1n1*c2n2;
        rFp[tIdxFP] = rFp3;
        ++tIdxFP;
    } else {
        c10 = c11 = c1n1 = 0.0;
    }
    if (L3MAX == 2) return;
    jdouble c30, c31, c3n1, c32, c3n2, c33, c3n3;
    if (L3CROSS) {
        /// l1 = 2, l2 = l3 = 3
        c30  = aCnlm[(3*3+3)  ];
        c31  = aCnlm[(3*3+3)+1];
        c3n1 = aCnlm[(3*3+3)-1];
        c32  = aCnlm[(3*3+3)+2];
        c3n2 = aCnlm[(3*3+3)-2];
        c33  = aCnlm[(3*3+3)+3];
        c3n3 = aCnlm[(3*3+3)-3];
        rFp3 = 0.0;
        rFp3 += WIGNER_233_000 * c20*c30*c30;
        rFp3 -= WIGNER_233_011 * c20 * (c31*c31 + c3n1*c3n1);
        rFp3 += WIGNER_233_022 * c20 * (c32*c32 + c3n2*c3n2);
        rFp3 -= WIGNER_233_033 * c20 * (c33*c33 + c3n3*c3n3);
        rFp3 -= (2.0*WIGNER_233_110) * c30 * (c21*c31 + c2n1*c3n1);
        rFp3 += (2.0*WIGNER_233_220) * c30 * (c22*c32 + c2n2*c3n2);
        rFp3 += (SQRT2_INV*WIGNER_233_211) * c22 * (c31*c31 - c3n1*c3n1);
        rFp3 += (2.0*SQRT2_INV*WIGNER_233_211) * c2n2*c31*c3n1;
        rFp3 += (2.0*SQRT2_INV*WIGNER_233_112) * c21 * (c31*c32 + c3n1*c3n2);
        rFp3 += (2.0*SQRT2_INV*WIGNER_233_112) * c2n1 * (c31*c3n2 - c3n1*c32);
        rFp3 -= (2.0*SQRT2_INV*WIGNER_233_123) * c21 * (c32*c33 + c3n2*c3n3);
        rFp3 -= (2.0*SQRT2_INV*WIGNER_233_123) * c2n1 * (c32*c3n3 - c3n2*c33);
        rFp3 -= (2.0*SQRT2_INV*WIGNER_233_213) * c22 * (c31*c33 + c3n1*c3n3);
        rFp3 -= (2.0*SQRT2_INV*WIGNER_233_213) * c2n2 * (c31*c3n3 - c3n1*c33);
        rFp[tIdxFP] = rFp3;
        ++tIdxFP;
        /// l1 = 1, l2 = 2, l3 = 3
        rFp3 = 0.0;
        rFp3 += WIGNER_123_000 * c10*c20*c30;
        rFp3 -= WIGNER_123_011 * c10 * (c21*c31 + c2n1*c3n1);
        rFp3 += WIGNER_123_022 * c10 * (c22*c32 + c2n2*c3n2);
        rFp3 -= WIGNER_123_101 * c20 * (c11*c31 + c1n1*c3n1);
        rFp3 -= WIGNER_123_110 * c30 * (c11*c21 + c1n1*c2n1);
        rFp3 += (SQRT2_INV*WIGNER_123_112) * c11 * (c21*c32 + c2n1*c3n2);
        rFp3 += (SQRT2_INV*WIGNER_123_112) * c1n1 * (c21*c3n2 - c2n1*c32);
        rFp3 += (SQRT2_INV*WIGNER_123_121) * c11 * (c22*c31 + c2n2*c3n1);
        rFp3 += (SQRT2_INV*WIGNER_123_121) * c1n1 * (c2n2*c31 - c22*c3n1);
        rFp3 -= (SQRT2_INV*WIGNER_123_123) * c11 * (c22*c33 + c2n2*c3n3);
        rFp3 -= (SQRT2_INV*WIGNER_123_123) * c1n1 * (c22*c3n3 - c2n2*c33);
        rFp[tIdxFP] = rFp3;
        ++tIdxFP;
    } else {
        c30 = c31 = c3n1 = c32 = c3n2 = c33 = c3n3 = 0.0;
    }
    if (L3MAX == 3) return;
    /// l1 = l2 = l3 = 4
    jdouble c40  = aCnlm[(4*4+4)  ];
    jdouble c41  = aCnlm[(4*4+4)+1];
    jdouble c4n1 = aCnlm[(4*4+4)-1];
    jdouble c42  = aCnlm[(4*4+4)+2];
    jdouble c4n2 = aCnlm[(4*4+4)-2];
    jdouble c43  = aCnlm[(4*4+4)+3];
    jdouble c4n3 = aCnlm[(4*4+4)-3];
    jdouble c44  = aCnlm[(4*4+4)+4];
    jdouble c4n4 = aCnlm[(4*4+4)-4];
    rFp3 = 0.0;
    rFp3 += WIGNER_444_000 * c40*c40*c40;
    rFp3 -= (3.0*WIGNER_444_011) * c40 * (c41*c41 + c4n1*c4n1);
    rFp3 += (3.0*WIGNER_444_022) * c40 * (c42*c42 + c4n2*c4n2);
    rFp3 -= (3.0*WIGNER_444_033) * c40 * (c43*c43 + c4n3*c4n3);
    rFp3 += (3.0*WIGNER_444_044) * c40 * (c44*c44 + c4n4*c4n4);
    rFp3 += (3.0*SQRT2_INV*WIGNER_444_112) * c42 * (c41*c41 - c4n1*c4n1);
    rFp3 += (6.0*SQRT2_INV*WIGNER_444_112) * c41*c4n1*c4n2;
    rFp3 += (3.0*SQRT2_INV*WIGNER_444_224) * c44 * (c42*c42 - c4n2*c4n2);
    rFp3 += (6.0*SQRT2_INV*WIGNER_444_224) * c42*c4n2*c4n4;
    rFp3 -= (6.0*SQRT2_INV*WIGNER_444_123) * c41 * (c42*c43 + c4n2*c4n3);
    rFp3 -= (6.0*SQRT2_INV*WIGNER_444_123) * c4n1 * (c42*c4n3 - c4n2*c43);
    rFp3 += (6.0*SQRT2_INV*WIGNER_444_134) * c41 * (c43*c44 + c4n3*c4n4);
    rFp3 += (6.0*SQRT2_INV*WIGNER_444_134) * c4n1 * (c43*c4n4 - c4n3*c44);
    rFp[tIdxFP] = rFp3;
    ++tIdxFP;
    if (L3CROSS) {
        /// l1 = l2 = 2, l3 = 4
        rFp3 = 0.0;
        rFp3 += WIGNER_224_000 * c20*c20*c40;
        rFp3 -= WIGNER_224_110 * c40 * (c21*c21 + c2n1*c2n1);
        rFp3 += WIGNER_224_220 * c40 * (c22*c22 + c2n2*c2n2);
        rFp3 -= (2.0*WIGNER_224_011) * c20 * (c21*c41 + c2n1*c4n1);
        rFp3 += (2.0*WIGNER_224_022) * c20 * (c22*c42 + c2n2*c4n2);
        rFp3 += (SQRT2_INV*WIGNER_224_112) * c42 * (c21*c21 - c2n1*c2n1);
        rFp3 += (2.0*SQRT2_INV*WIGNER_224_112) * c21*c2n1*c4n2;
        rFp3 += (SQRT2_INV*WIGNER_224_224) * c44 * (c22*c22 - c2n2*c2n2);
        rFp3 += (2.0*SQRT2_INV*WIGNER_224_224) * c22*c2n2*c4n4;
        rFp3 += (2.0*SQRT2_INV*WIGNER_224_121) * c21 * (c22*c41 + c2n2*c4n1);
        rFp3 += (2.0*SQRT2_INV*WIGNER_224_121) * c2n1 * (c2n2*c41 - c22*c4n1);
        rFp3 -= (2.0*SQRT2_INV*WIGNER_224_123) * c21 * (c22*c43 + c2n2*c4n3);
        rFp3 -= (2.0*SQRT2_INV*WIGNER_224_123) * c2n1 * (c22*c4n3 - c2n2*c43);
        rFp[tIdxFP] = rFp3;
        ++tIdxFP;
        /// l1 = l2 = 3, l3 = 4
        rFp3 = 0.0;
        rFp3 += WIGNER_334_000 * c30*c30*c40;
        rFp3 -= WIGNER_334_110 * c40 * (c31*c31 + c3n1*c3n1);
        rFp3 += WIGNER_334_220 * c40 * (c32*c32 + c3n2*c3n2);
        rFp3 -= WIGNER_334_330 * c40 * (c33*c33 + c3n3*c3n3);
        rFp3 -= (2.0*WIGNER_334_011) * c30 * (c31*c41 + c3n1*c4n1);
        rFp3 += (2.0*WIGNER_334_022) * c30 * (c32*c42 + c3n2*c4n2);
        rFp3 -= (2.0*WIGNER_334_033) * c30 * (c33*c43 + c3n3*c4n3);
        rFp3 += (SQRT2_INV*WIGNER_334_112) * c42 * (c31*c31 - c3n1*c3n1);
        rFp3 += (2.0*SQRT2_INV*WIGNER_334_112) * c31*c3n1*c4n2;
        rFp3 += (SQRT2_INV*WIGNER_334_224) * c44 * (c32*c32 - c3n2*c3n2);
        rFp3 += (2.0*SQRT2_INV*WIGNER_334_224) * c32*c3n2*c4n4;
        rFp3 += (2.0*SQRT2_INV*WIGNER_334_121) * c31 * (c32*c41 + c3n2*c4n1);
        rFp3 += (2.0*SQRT2_INV*WIGNER_334_121) * c3n1 * (c3n2*c41 - c32*c4n1);
        rFp3 -= (2.0*SQRT2_INV*WIGNER_334_123) * c31 * (c32*c43 + c3n2*c4n3);
        rFp3 -= (2.0*SQRT2_INV*WIGNER_334_123) * c3n1 * (c32*c4n3 - c3n2*c43);
        rFp3 -= (2.0*SQRT2_INV*WIGNER_334_132) * c31 * (c33*c42 + c3n3*c4n2);
        rFp3 -= (2.0*SQRT2_INV*WIGNER_334_132) * c3n1 * (c3n3*c42 - c33*c4n2);
        rFp3 -= (2.0*SQRT2_INV*WIGNER_334_231) * c32 * (c33*c41 + c3n3*c4n1);
        rFp3 -= (2.0*SQRT2_INV*WIGNER_334_231) * c3n2 * (c3n3*c41 - c33*c4n1);
        rFp3 += (2.0*SQRT2_INV*WIGNER_334_134) * c31 * (c33*c44 + c3n3*c4n4);
        rFp3 += (2.0*SQRT2_INV*WIGNER_334_134) * c3n1 * (c33*c4n4 - c3n3*c44);
        rFp[tIdxFP] = rFp3;
        ++tIdxFP;
        /// l1 = 2, l2 = l3 = 4
        rFp3 = 0.0;
        rFp3 += WIGNER_244_000 * c20*c40*c40;
        rFp3 -= WIGNER_244_011 * c20 * (c41*c41 + c4n1*c4n1);
        rFp3 += WIGNER_244_022 * c20 * (c42*c42 + c4n2*c4n2);
        rFp3 -= WIGNER_244_033 * c20 * (c43*c43 + c4n3*c4n3);
        rFp3 += WIGNER_244_044 * c20 * (c44*c44 + c4n4*c4n4);
        rFp3 -= (2.0*WIGNER_244_110) * c40 * (c21*c41 + c2n1*c4n1);
        rFp3 += (2.0*WIGNER_244_220) * c40 * (c22*c42 + c2n2*c4n2);
        rFp3 += (SQRT2_INV*WIGNER_244_211) * c22 * (c41*c41 - c4n1*c4n1);
        rFp3 += (2.0*SQRT2_INV*WIGNER_244_211) * c2n2*c41*c4n1;
        rFp3 += (2.0*SQRT2_INV*WIGNER_244_112) * c21 * (c41*c42 + c4n1*c4n2);
        rFp3 += (2.0*SQRT2_INV*WIGNER_244_112) * c2n1 * (c41*c4n2 - c4n1*c42);
        rFp3 += (2.0*SQRT2_INV*WIGNER_244_224) * c22 * (c42*c44 + c4n2*c4n4);
        rFp3 += (2.0*SQRT2_INV*WIGNER_244_224) * c2n2 * (c42*c4n4 - c4n2*c44);
        rFp3 -= (2.0*SQRT2_INV*WIGNER_244_123) * c21 * (c42*c43 + c4n2*c4n3);
        rFp3 -= (2.0*SQRT2_INV*WIGNER_244_123) * c2n1 * (c42*c4n3 - c4n2*c43);
        rFp3 -= (2.0*SQRT2_INV*WIGNER_244_213) * c22 * (c41*c43 + c4n1*c4n3);
        rFp3 -= (2.0*SQRT2_INV*WIGNER_244_213) * c2n2 * (c41*c4n3 - c4n1*c43);
        rFp3 += (2.0*SQRT2_INV*WIGNER_244_134) * c21 * (c43*c44 + c4n3*c4n4);
        rFp3 += (2.0*SQRT2_INV*WIGNER_244_134) * c2n1 * (c43*c4n4 - c4n3*c44);
        rFp[tIdxFP] = rFp3;
        ++tIdxFP;
        /// l1 = 1, l2 = 3, l3 = 4
        rFp3 = 0.0;
        rFp3 += WIGNER_134_000 * c10*c30*c40;
        rFp3 -= WIGNER_134_011 * c10 * (c31*c41 + c3n1*c4n1);
        rFp3 += WIGNER_134_022 * c10 * (c32*c42 + c3n2*c4n2);
        rFp3 -= WIGNER_134_033 * c10 * (c33*c43 + c3n3*c4n3);
        rFp3 -= WIGNER_134_110 * c40 * (c11*c31 + c1n1*c3n1);
        rFp3 -= WIGNER_134_101 * c30 * (c11*c41 + c1n1*c4n1);
        rFp3 += (SQRT2_INV*WIGNER_134_112) * c11 * (c31*c42 + c3n1*c4n2);
        rFp3 += (SQRT2_INV*WIGNER_134_112) * c1n1 * (c31*c4n2 - c3n1*c42);
        rFp3 += (SQRT2_INV*WIGNER_134_121) * c11 * (c32*c41 + c3n2*c4n1);
        rFp3 += (SQRT2_INV*WIGNER_134_121) * c1n1 * (c3n2*c41 - c32*c4n1);
        rFp3 -= (SQRT2_INV*WIGNER_134_123) * c11 * (c32*c43 + c3n2*c4n3);
        rFp3 -= (SQRT2_INV*WIGNER_134_123) * c1n1 * (c32*c4n3 - c3n2*c43);
        rFp3 -= (SQRT2_INV*WIGNER_134_132) * c11 * (c33*c42 + c3n3*c4n2);
        rFp3 -= (SQRT2_INV*WIGNER_134_132) * c1n1 * (c3n3*c42 - c33*c4n2);
        rFp3 += (SQRT2_INV*WIGNER_134_134) * c11 * (c33*c44 + c3n3*c4n4);
        rFp3 += (SQRT2_INV*WIGNER_134_134) * c1n1 * (c33*c4n4 - c3n3*c44);
        rFp[tIdxFP] = rFp3;
        ++tIdxFP;
    }
}

template <jint L>
static inline void calYPphi(jdouble *rYPphi, jdouble *aY) noexcept {
    const jint tStart = L*L;
    const jint tIdx = tStart+L;
    for (jint m = -L; m <= L; ++m) {
        rYPphi[tIdx+m] = -m * aY[tIdx-m];
    }
}
template <jint L>
static inline void calYPtheta(jdouble aCosPhi, jdouble aSinPhi, jdouble *rYPtheta, jdouble *aY) noexcept {
    switch(L) {
    case 0: {
        rYPtheta[0] = 0.0;
        return;
    }
    case 1: {
        const jdouble tMul = SQRT_LPM_LMM1[2]*SQRT2_INV;
        rYPtheta[1] = -tMul * aSinPhi*aY[2];
        rYPtheta[2] =  tMul * (aCosPhi*aY[3] + aSinPhi*aY[1]);
        rYPtheta[3] = -tMul * aCosPhi*aY[2];
        return;
    }
    default: {
        const jint tStart = L*L;
        const jint tIdx = tStart+L;
        const jdouble tMul = SQRT_LPM_LMM1[tIdx]*SQRT2_INV;
        rYPtheta[tIdx] = tMul * (aCosPhi*aY[tIdx+1] + aSinPhi*aY[tIdx-1]);
        rYPtheta[tIdx+1] = -tMul * aCosPhi*aY[tIdx];
        rYPtheta[tIdx-1] = -tMul * aSinPhi*aY[tIdx];
        for (jint m = 2; m <= L; ++m) {
            const jdouble tMul2 = -0.5*SQRT_LPM_LMM1[tIdx+m];
            rYPtheta[tIdx+m] = tMul2 * (aCosPhi*aY[tIdx+m-1] - aSinPhi*aY[tIdx-m+1]);
            rYPtheta[tIdx-m] = tMul2 * (aCosPhi*aY[tIdx-m+1] + aSinPhi*aY[tIdx+m-1]);
        }
        for (jint m = 1; m < L; ++m) {
            const jdouble tMul2 = 0.5*SQRT_LPM1_LMM[tIdx+m];
            rYPtheta[tIdx+m] += tMul2 * (aCosPhi*aY[tIdx+m+1] + aSinPhi*aY[tIdx-m-1]);
            rYPtheta[tIdx-m] += tMul2 * (aCosPhi*aY[tIdx-m-1] - aSinPhi*aY[tIdx+m+1]);
        }
        return;
    }}
}
template <jint LMAX>
static void calYPphiPtheta(jdouble *rYPphi, jdouble aCosPhi, jdouble aSinPhi, jdouble *rYPtheta, jdouble *aY) noexcept {
    calYPphi<0>(rYPphi, aY); calYPtheta<0>(aCosPhi, aSinPhi, rYPtheta, aY);
    if (LMAX == 0) return;
    calYPphi<1>(rYPphi, aY); calYPtheta<1>(aCosPhi, aSinPhi, rYPtheta, aY);
    if (LMAX == 1) return;
    calYPphi<2>(rYPphi, aY); calYPtheta<2>(aCosPhi, aSinPhi, rYPtheta, aY);
    if (LMAX == 2) return;
    calYPphi<3>(rYPphi, aY); calYPtheta<3>(aCosPhi, aSinPhi, rYPtheta, aY);
    if (LMAX == 3) return;
    calYPphi<4>(rYPphi, aY); calYPtheta<4>(aCosPhi, aSinPhi, rYPtheta, aY);
    if (LMAX == 4) return;
    calYPphi<5>(rYPphi, aY); calYPtheta<5>(aCosPhi, aSinPhi, rYPtheta, aY);
    if (LMAX == 5) return;
    calYPphi<6>(rYPphi, aY); calYPtheta<6>(aCosPhi, aSinPhi, rYPtheta, aY);
    if (LMAX == 6) return;
    calYPphi<7>(rYPphi, aY); calYPtheta<7>(aCosPhi, aSinPhi, rYPtheta, aY);
    if (LMAX == 7) return;
    calYPphi<8>(rYPphi, aY); calYPtheta<8>(aCosPhi, aSinPhi, rYPtheta, aY);
}
template <jint N>
static inline void convertYPPhiPtheta2YPxyz(jdouble aCosTheta, jdouble aSinTheta, jdouble aCosPhi, jdouble aSinPhi, jdouble aDis, jdouble aDxy, jboolean aDxyCloseZero,
                                            jdouble *rYPx, jdouble *rYPy, jdouble *rYPz, jdouble *aYPtheta, jdouble *aYPphi) noexcept {
    const jdouble thetaPx = -aCosTheta * aCosPhi / aDis;
    const jdouble thetaPy = -aCosTheta * aSinPhi / aDis;
    const jdouble thetaPz =  aSinTheta / aDis;
    const jdouble phiPx = aDxyCloseZero ? 0.0 :  aSinPhi / aDxy;
    const jdouble phiPy = aDxyCloseZero ? 0.0 : -aCosPhi / aDxy;
    for (jint i = 0; i < N; ++i) {
        const jdouble tYPtheta = aYPtheta[i];
        const jdouble tYPphi = aYPphi[i];
        rYPx[i] = tYPtheta*thetaPx + tYPphi*phiPx;
        rYPy[i] = tYPtheta*thetaPy + tYPphi*phiPy;
        rYPz[i] = tYPtheta*thetaPz;
    }
}
template <jint LMAX, jint LMALL>
static inline void calYPxyz(jdouble *aY, jdouble aDx, jdouble aDy, jdouble aDz, jdouble aDis,
                            jdouble *rYPx, jdouble *rYPy, jdouble *rYPz, jdouble *rYPtheta, jdouble *rYPphi) noexcept {
    jdouble dxy = hypot(aDx, aDy);
    jdouble cosTheta = aDz / aDis;
    jdouble sinTheta = dxy / aDis;
    jdouble cosPhi;
    jdouble sinPhi;
    jboolean dxyCloseZero = JSE_NNAP::numericEqual(dxy, 0.0);
    if (dxyCloseZero) {
        cosPhi = 1.0;
        sinPhi = 0.0;
    } else {
        cosPhi = aDx / dxy;
        sinPhi = aDy / dxy;
    }
    calYPphiPtheta<LMAX>(rYPphi, cosPhi, sinPhi, rYPtheta, aY);
    if (dxyCloseZero) {
        // fix singularity
        for (jint k = 0; k < LMALL; ++k) rYPphi[k] = 0.0;
    }
    // conert to Pxyz
    convertYPPhiPtheta2YPxyz<LMALL>(cosTheta, sinTheta, cosPhi, sinPhi, aDis, dxy, dxyCloseZero,
                                    rYPx, rYPy, rYPz, rYPtheta, rYPphi);
}

template <jint L>
static inline void calGradL2Sub_(jdouble *aCnlm, jdouble *rGradCnlm, jdouble *aNNGrad) noexcept {
    const jint tStart = L*L;
    const jint tLen = L+L+1;
    const jint tEnd = tStart+tLen;
    const jdouble tMul = 2.0 * PI4/(jdouble)tLen;
    jdouble subNNGrad = aNNGrad[L-1];
    for (jint i = tStart; i < tEnd; ++i) {
        rGradCnlm[i] += tMul * aCnlm[i] * subNNGrad;
    }
}
template <jint LMAX, jboolean NO_RADIAL>
static void calGradL2_(jdouble *aCnlm, jdouble *rGradCnlm, jdouble *aNNGrad) noexcept {
    // l = 0
    jdouble *tNNGrad = aNNGrad;
    if (!NO_RADIAL) {
        rGradCnlm[0] += (PI4+PI4) * aCnlm[0] * tNNGrad[0];
        ++tNNGrad;
    }
    if (LMAX == 0) return;
    calGradL2Sub_<1>(aCnlm, rGradCnlm, tNNGrad);
    if (LMAX == 1) return;
    calGradL2Sub_<2>(aCnlm, rGradCnlm, tNNGrad);
    if (LMAX == 2) return;
    calGradL2Sub_<3>(aCnlm, rGradCnlm, tNNGrad);
    if (LMAX == 3) return;
    calGradL2Sub_<4>(aCnlm, rGradCnlm, tNNGrad);
    if (LMAX == 4) return;
    calGradL2Sub_<5>(aCnlm, rGradCnlm, tNNGrad);
    if (LMAX == 5) return;
    calGradL2Sub_<6>(aCnlm, rGradCnlm, tNNGrad);
    if (LMAX == 6) return;
    calGradL2Sub_<7>(aCnlm, rGradCnlm, tNNGrad);
    if (LMAX == 7) return;
    calGradL2Sub_<8>(aCnlm, rGradCnlm, tNNGrad);
}
template <jint L3MAX, jboolean L3CROSS>
static void calGradL3_(jdouble *aCnlm, jdouble *rGradCnlm, jdouble *aNNGrad, jint aLMax, jboolean aNoRadial) noexcept {
    if (L3MAX <= 1) return;
    jint tIdxFP = aNoRadial ? aLMax : (aLMax+1);
    /// l1 = l2 = l3 = 2
    jdouble c20  = aCnlm[(2*2+2)  ]; jdouble *gc20  = rGradCnlm + (2*2+2);
    jdouble c21  = aCnlm[(2*2+2)+1]; jdouble *gc21  = rGradCnlm + (2*2+2)+1;
    jdouble c2n1 = aCnlm[(2*2+2)-1]; jdouble *gc2n1 = rGradCnlm + (2*2+2)-1;
    jdouble c22  = aCnlm[(2*2+2)+2]; jdouble *gc22  = rGradCnlm + (2*2+2)+2;
    jdouble c2n2 = aCnlm[(2*2+2)-2]; jdouble *gc2n2 = rGradCnlm + (2*2+2)-2;
    jdouble subNNGrad = aNNGrad[tIdxFP];
    *gc20  += (WIGNER_222_000*3.0) * c20*c20 * subNNGrad;
    *gc20  -= (3.0*WIGNER_222_011) * (c21*c21 + c2n1*c2n1) * subNNGrad;
    *gc21  -= (6.0*WIGNER_222_011) * c20*c21 * subNNGrad;
    *gc2n1 -= (6.0*WIGNER_222_011) * c20*c2n1 * subNNGrad;
    *gc20  += (3.0*WIGNER_222_022) * (c22*c22 + c2n2*c2n2) * subNNGrad;
    *gc22  += (6.0*WIGNER_222_022) * c20*c22 * subNNGrad;
    *gc2n2 += (6.0*WIGNER_222_022) * c20*c2n2 * subNNGrad;
    *gc22  += (3.0*SQRT2_INV*WIGNER_222_112) * (c21*c21 - c2n1*c2n1) * subNNGrad;
    *gc21  += (6.0*SQRT2_INV*WIGNER_222_112) * (c22*c21 + c2n1*c2n2) * subNNGrad;
    *gc2n1 += (6.0*SQRT2_INV*WIGNER_222_112) * (c21*c2n2 - c22*c2n1) * subNNGrad;
    *gc2n2 += (6.0*SQRT2_INV*WIGNER_222_112) * c21*c2n1 * subNNGrad;
    ++tIdxFP;
    jdouble c10, c11, c1n1;
    jdouble *gc10, *gc11, *gc1n1;
    if (L3CROSS) {
        /// l1 = l2 = 1, l3 = 2
        c10  = aCnlm[(1+1)  ]; gc10  = rGradCnlm + (1+1);
        c11  = aCnlm[(1+1)+1]; gc11  = rGradCnlm + (1+1)+1;
        c1n1 = aCnlm[(1+1)-1]; gc1n1 = rGradCnlm + (1+1)-1;
        subNNGrad = aNNGrad[tIdxFP];
        *gc10  += (WIGNER_112_000*2.0) * c10*c20 * subNNGrad;
        *gc20  += WIGNER_112_000 * c10*c10 * subNNGrad;
        *gc20  -= WIGNER_112_110 * (c11*c11 + c1n1*c1n1) * subNNGrad;
        *gc11  -= (WIGNER_112_110*2.0) * c20*c11 * subNNGrad;
        *gc1n1 -= (WIGNER_112_110*2.0) * c20*c1n1 * subNNGrad;
        *gc10  -= (2.0*WIGNER_112_011) * (c11*c21 + c1n1*c2n1) * subNNGrad;
        *gc11  -= (2.0*WIGNER_112_011) * c10*c21 * subNNGrad;
        *gc21  -= (2.0*WIGNER_112_011) * c10*c11 * subNNGrad;
        *gc1n1 -= (2.0*WIGNER_112_011) * c10*c2n1 * subNNGrad;
        *gc2n1 -= (2.0*WIGNER_112_011) * c10*c1n1 * subNNGrad;
        *gc22  += (SQRT2_INV*WIGNER_112_112) * (c11*c11 - c1n1*c1n1)* subNNGrad;
        *gc11  += (2.0*SQRT2_INV*WIGNER_112_112) * (c22*c11 + c1n1*c2n2) * subNNGrad;
        *gc1n1 += (2.0*SQRT2_INV*WIGNER_112_112) * (c11*c2n2 - c22*c1n1) * subNNGrad;
        *gc2n2 += (2.0*SQRT2_INV*WIGNER_112_112) * c11*c1n1 * subNNGrad;
        ++tIdxFP;
    } else {
        c10 = c11 = c1n1 = 0.0;
        gc10 = gc11 = gc1n1 = NULL;
    }
    if (L3MAX == 2) return;
    jdouble c30, c31, c3n1, c32, c3n2, c33, c3n3;
    jdouble *gc30, *gc31, *gc3n1, *gc32, *gc3n2, *gc33, *gc3n3;
    if (L3CROSS) {
        /// l1 = 2, l2 = l3 = 3
        c30  = aCnlm[(3*3+3)  ]; gc30  = rGradCnlm + (3*3+3);
        c31  = aCnlm[(3*3+3)+1]; gc31  = rGradCnlm + (3*3+3)+1;
        c3n1 = aCnlm[(3*3+3)-1]; gc3n1 = rGradCnlm + (3*3+3)-1;
        c32  = aCnlm[(3*3+3)+2]; gc32  = rGradCnlm + (3*3+3)+2;
        c3n2 = aCnlm[(3*3+3)-2]; gc3n2 = rGradCnlm + (3*3+3)-2;
        c33  = aCnlm[(3*3+3)+3]; gc33  = rGradCnlm + (3*3+3)+3;
        c3n3 = aCnlm[(3*3+3)-3]; gc3n3 = rGradCnlm + (3*3+3)-3;
        subNNGrad = aNNGrad[tIdxFP];
        *gc20  += WIGNER_233_000 * c30*c30 * subNNGrad;
        *gc30  += (WIGNER_233_000*2.0) * c20*c30 * subNNGrad;
        *gc20  -= WIGNER_233_011 * (c31*c31 + c3n1*c3n1) * subNNGrad;
        *gc31  -= (WIGNER_233_011*2.0) * c20*c31 * subNNGrad;
        *gc3n1 -= (WIGNER_233_011*2.0) * c20*c3n1 * subNNGrad;
        *gc20  += WIGNER_233_022 * (c32*c32 + c3n2*c3n2) * subNNGrad;
        *gc32  += (WIGNER_233_022*2.0) * c20*c32 * subNNGrad;
        *gc3n2 += (WIGNER_233_022*2.0) * c20*c3n2 * subNNGrad;
        *gc20  -= WIGNER_233_033 * (c33*c33 + c3n3*c3n3) * subNNGrad;
        *gc33  -= (WIGNER_233_033*2.0) * c20*c33 * subNNGrad;
        *gc3n3 -= (WIGNER_233_033*2.0) * c20*c3n3 * subNNGrad;
        *gc30  -= (2.0*WIGNER_233_110) * (c21*c31 + c2n1*c3n1) * subNNGrad;
        *gc21  -= (2.0*WIGNER_233_110) * c30*c31 * subNNGrad;
        *gc31  -= (2.0*WIGNER_233_110) * c30*c21 * subNNGrad;
        *gc2n1 -= (2.0*WIGNER_233_110) * c30*c3n1 * subNNGrad;
        *gc3n1 -= (2.0*WIGNER_233_110) * c30*c2n1 * subNNGrad;
        *gc30  += (2.0*WIGNER_233_220) * (c22*c32 + c2n2*c3n2) * subNNGrad;
        *gc22  += (2.0*WIGNER_233_220) * c30*c32 * subNNGrad;
        *gc32  += (2.0*WIGNER_233_220) * c30*c22 * subNNGrad;
        *gc2n2 += (2.0*WIGNER_233_220) * c30*c3n2 * subNNGrad;
        *gc3n2 += (2.0*WIGNER_233_220) * c30*c2n2 * subNNGrad;
        *gc22  += (SQRT2_INV*WIGNER_233_211) * (c31*c31 - c3n1*c3n1) * subNNGrad;
        *gc31  += (2.0*SQRT2_INV*WIGNER_233_211) * (c22*c31 + c2n2*c3n1) * subNNGrad;
        *gc3n1 += (2.0*SQRT2_INV*WIGNER_233_211) * (c2n2*c31 - c22*c3n1) * subNNGrad;
        *gc2n2 += (2.0*SQRT2_INV*WIGNER_233_211) * c31*c3n1 * subNNGrad;
        *gc21  += (2.0*SQRT2_INV*WIGNER_233_112) * (c31*c32 + c3n1*c3n2) * subNNGrad;
        *gc2n1 += (2.0*SQRT2_INV*WIGNER_233_112) * (c31*c3n2 - c3n1*c32) * subNNGrad;
        *gc31  += (2.0*SQRT2_INV*WIGNER_233_112) * (c21*c32 + c2n1*c3n2) * subNNGrad;
        *gc32  += (2.0*SQRT2_INV*WIGNER_233_112) * (c21*c31 - c2n1*c3n1) * subNNGrad;
        *gc3n1 += (2.0*SQRT2_INV*WIGNER_233_112) * (c21*c3n2 - c2n1*c32) * subNNGrad;
        *gc3n2 += (2.0*SQRT2_INV*WIGNER_233_112) * (c21*c3n1 + c2n1*c31) * subNNGrad;
        *gc21  -= (2.0*SQRT2_INV*WIGNER_233_123) * (c32*c33 + c3n2*c3n3) * subNNGrad;
        *gc2n1 -= (2.0*SQRT2_INV*WIGNER_233_123) * (c32*c3n3 - c3n2*c33) * subNNGrad;
        *gc32  -= (2.0*SQRT2_INV*WIGNER_233_123) * (c21*c33 + c2n1*c3n3) * subNNGrad;
        *gc33  -= (2.0*SQRT2_INV*WIGNER_233_123) * (c21*c32 - c2n1*c3n2) * subNNGrad;
        *gc3n2 -= (2.0*SQRT2_INV*WIGNER_233_123) * (c21*c3n3 - c2n1*c33) * subNNGrad;
        *gc3n3 -= (2.0*SQRT2_INV*WIGNER_233_123) * (c21*c3n2 + c2n1*c32) * subNNGrad;
        *gc22  -= (2.0*SQRT2_INV*WIGNER_233_213) * (c31*c33 + c3n1*c3n3) * subNNGrad;
        *gc2n2 -= (2.0*SQRT2_INV*WIGNER_233_213) * (c31*c3n3 - c3n1*c33) * subNNGrad;
        *gc31  -= (2.0*SQRT2_INV*WIGNER_233_213) * (c22*c33 + c2n2*c3n3) * subNNGrad;
        *gc33  -= (2.0*SQRT2_INV*WIGNER_233_213) * (c22*c31 - c2n2*c3n1) * subNNGrad;
        *gc3n1 -= (2.0*SQRT2_INV*WIGNER_233_213) * (c22*c3n3 - c2n2*c33) * subNNGrad;
        *gc3n3 -= (2.0*SQRT2_INV*WIGNER_233_213) * (c22*c3n1 + c2n2*c31) * subNNGrad;
        ++tIdxFP;
        /// l1 = 1, l2 = 2, l3 = 3
        subNNGrad = aNNGrad[tIdxFP];
        *gc10  += WIGNER_123_000 * c20*c30 * subNNGrad;
        *gc20  += WIGNER_123_000 * c10*c30 * subNNGrad;
        *gc30  += WIGNER_123_000 * c10*c20 * subNNGrad;
        *gc10  -= WIGNER_123_011 * (c21*c31 + c2n1*c3n1) * subNNGrad;
        *gc21  -= WIGNER_123_011 * c10*c31 * subNNGrad;
        *gc31  -= WIGNER_123_011 * c10*c21 * subNNGrad;
        *gc2n1 -= WIGNER_123_011 * c10*c3n1 * subNNGrad;
        *gc3n1 -= WIGNER_123_011 * c10*c2n1 * subNNGrad;
        *gc10  += WIGNER_123_022 * (c22*c32 + c2n2*c3n2) * subNNGrad;
        *gc22  += WIGNER_123_022 * c10*c32 * subNNGrad;
        *gc32  += WIGNER_123_022 * c10*c22 * subNNGrad;
        *gc2n2  += WIGNER_123_022 * c10*c3n2 * subNNGrad;
        *gc3n2  += WIGNER_123_022 * c10*c2n2 * subNNGrad;
        *gc20  -= WIGNER_123_101 * (c11*c31 + c1n1*c3n1) * subNNGrad;
        *gc11  -= WIGNER_123_101 * c20*c31 * subNNGrad;
        *gc31  -= WIGNER_123_101 * c20*c11 * subNNGrad;
        *gc1n1 -= WIGNER_123_101 * c20*c3n1 * subNNGrad;
        *gc3n1 -= WIGNER_123_101 * c20*c1n1 * subNNGrad;
        *gc30  -= WIGNER_123_110 * (c11*c21 + c1n1*c2n1) * subNNGrad;
        *gc11  -= WIGNER_123_110 * c30*c21 * subNNGrad;
        *gc21  -= WIGNER_123_110 * c30*c11 * subNNGrad;
        *gc1n1 -= WIGNER_123_110 * c30*c2n1 * subNNGrad;
        *gc2n1 -= WIGNER_123_110 * c30*c1n1 * subNNGrad;
        *gc11  += (SQRT2_INV*WIGNER_123_112) * (c21*c32 + c2n1*c3n2) * subNNGrad;
        *gc1n1 += (SQRT2_INV*WIGNER_123_112) * (c21*c3n2 - c2n1*c32) * subNNGrad;
        *gc21  += (SQRT2_INV*WIGNER_123_112) * (c11*c32 + c1n1*c3n2) * subNNGrad;
        *gc32  += (SQRT2_INV*WIGNER_123_112) * (c11*c21 - c1n1*c2n1) * subNNGrad;
        *gc2n1 += (SQRT2_INV*WIGNER_123_112) * (c11*c3n2 - c1n1*c32) * subNNGrad;
        *gc3n2 += (SQRT2_INV*WIGNER_123_112) * (c11*c2n1 + c1n1*c21) * subNNGrad;
        *gc11  += (SQRT2_INV*WIGNER_123_121) * (c22*c31 + c2n2*c3n1) * subNNGrad;
        *gc1n1 += (SQRT2_INV*WIGNER_123_121) * (c2n2*c31 - c22*c3n1) * subNNGrad;
        *gc22  += (SQRT2_INV*WIGNER_123_121) * (c11*c31 - c1n1*c3n1) * subNNGrad;
        *gc31  += (SQRT2_INV*WIGNER_123_121) * (c11*c22 + c1n1*c2n2) * subNNGrad;
        *gc2n2 += (SQRT2_INV*WIGNER_123_121) * (c11*c3n1 + c1n1*c31) * subNNGrad;
        *gc3n1 += (SQRT2_INV*WIGNER_123_121) * (c11*c2n2 - c1n1*c22) * subNNGrad;
        *gc11  -= (SQRT2_INV*WIGNER_123_123) * (c22*c33 + c2n2*c3n3) * subNNGrad;
        *gc1n1 -= (SQRT2_INV*WIGNER_123_123) * (c22*c3n3 - c2n2*c33) * subNNGrad;
        *gc22  -= (SQRT2_INV*WIGNER_123_123) * (c11*c33 + c1n1*c3n3) * subNNGrad;
        *gc33  -= (SQRT2_INV*WIGNER_123_123) * (c11*c22 - c1n1*c2n2) * subNNGrad;
        *gc2n2 -= (SQRT2_INV*WIGNER_123_123) * (c11*c3n3 - c1n1*c33) * subNNGrad;
        *gc3n3 -= (SQRT2_INV*WIGNER_123_123) * (c11*c2n2 + c1n1*c22) * subNNGrad;
        ++tIdxFP;
    } else {
        c30 = c31 = c3n1 = c32 = c3n2 = c33 = c3n3 = 0.0;
        gc30 = gc31 = gc3n1 = gc32 = gc3n2 = gc33 = gc3n3 = NULL;
    }
    if (L3MAX == 3) return;
    /// l1 = l2 = l3 = 4
    jdouble c40  = aCnlm[(4*4+4)  ]; jdouble *gc40  = rGradCnlm + (4*4+4);
    jdouble c41  = aCnlm[(4*4+4)+1]; jdouble *gc41  = rGradCnlm + (4*4+4)+1;
    jdouble c4n1 = aCnlm[(4*4+4)-1]; jdouble *gc4n1 = rGradCnlm + (4*4+4)-1;
    jdouble c42  = aCnlm[(4*4+4)+2]; jdouble *gc42  = rGradCnlm + (4*4+4)+2;
    jdouble c4n2 = aCnlm[(4*4+4)-2]; jdouble *gc4n2 = rGradCnlm + (4*4+4)-2;
    jdouble c43  = aCnlm[(4*4+4)+3]; jdouble *gc43  = rGradCnlm + (4*4+4)+3;
    jdouble c4n3 = aCnlm[(4*4+4)-3]; jdouble *gc4n3 = rGradCnlm + (4*4+4)-3;
    jdouble c44  = aCnlm[(4*4+4)+4]; jdouble *gc44  = rGradCnlm + (4*4+4)+4;
    jdouble c4n4 = aCnlm[(4*4+4)-4]; jdouble *gc4n4 = rGradCnlm + (4*4+4)-4;
    subNNGrad = aNNGrad[tIdxFP];
    *gc40  += (WIGNER_444_000*3.0) * c40*c40 * subNNGrad;
    *gc40  -= (3.0*WIGNER_444_011) * (c41*c41 + c4n1*c4n1) * subNNGrad;
    *gc41  -= (3.0*WIGNER_444_011*2.0) * c40*c41 * subNNGrad;
    *gc4n1 -= (3.0*WIGNER_444_011*2.0) * c40*c4n1 * subNNGrad;
    *gc40  += (3.0*WIGNER_444_022) * (c42*c42 + c4n2*c4n2) * subNNGrad;
    *gc42  += (3.0*WIGNER_444_022*2.0) * c40*c42 * subNNGrad;
    *gc4n2 += (3.0*WIGNER_444_022*2.0) * c40*c4n2 * subNNGrad;
    *gc40  -= (3.0*WIGNER_444_033) * (c43*c43 + c4n3*c4n3) * subNNGrad;
    *gc43  -= (3.0*WIGNER_444_033*2.0) * c40*c43 * subNNGrad;
    *gc4n3 -= (3.0*WIGNER_444_033*2.0) * c40*c4n3 * subNNGrad;
    *gc40  += (3.0*WIGNER_444_044) * (c44*c44 + c4n4*c4n4) * subNNGrad;
    *gc44  += (3.0*WIGNER_444_044*2.0) * c40*c44 * subNNGrad;
    *gc4n4 += (3.0*WIGNER_444_044*2.0) * c40*c4n4 * subNNGrad;
    *gc42  += (3.0*SQRT2_INV*WIGNER_444_112) * (c41*c41 - c4n1*c4n1) * subNNGrad;
    *gc4n2 += (6.0*SQRT2_INV*WIGNER_444_112) * c41*c4n1 * subNNGrad;
    *gc41  += (6.0*SQRT2_INV*WIGNER_444_112) * (c42*c41 + c4n1*c4n2) * subNNGrad;
    *gc4n1 += (6.0*SQRT2_INV*WIGNER_444_112) * (c41*c4n2 - c42*c4n1) * subNNGrad;
    *gc44  += (3.0*SQRT2_INV*WIGNER_444_224) * (c42*c42 - c4n2*c4n2) * subNNGrad;
    *gc4n4 += (6.0*SQRT2_INV*WIGNER_444_224) * c42*c4n2 * subNNGrad;
    *gc42  += (6.0*SQRT2_INV*WIGNER_444_224) * (c44*c42 + c4n2*c4n4) * subNNGrad;
    *gc4n2 += (6.0*SQRT2_INV*WIGNER_444_224) * (c42*c4n4 - c44*c4n2) * subNNGrad;
    *gc41  -= (6.0*SQRT2_INV*WIGNER_444_123) * (c42*c43 + c4n2*c4n3) * subNNGrad;
    *gc4n1 -= (6.0*SQRT2_INV*WIGNER_444_123) * (c42*c4n3 - c4n2*c43) * subNNGrad;
    *gc42  -= (6.0*SQRT2_INV*WIGNER_444_123) * (c41*c43 + c4n1*c4n3) * subNNGrad;
    *gc43  -= (6.0*SQRT2_INV*WIGNER_444_123) * (c41*c42 - c4n1*c4n2) * subNNGrad;
    *gc4n2 -= (6.0*SQRT2_INV*WIGNER_444_123) * (c41*c4n3 - c4n1*c43) * subNNGrad;
    *gc4n3 -= (6.0*SQRT2_INV*WIGNER_444_123) * (c41*c4n2 + c4n1*c42) * subNNGrad;
    *gc41  += (6.0*SQRT2_INV*WIGNER_444_134) * (c43*c44 + c4n3*c4n4) * subNNGrad;
    *gc4n1 += (6.0*SQRT2_INV*WIGNER_444_134) * (c43*c4n4 - c4n3*c44) * subNNGrad;
    *gc43  += (6.0*SQRT2_INV*WIGNER_444_134) * (c41*c44 + c4n1*c4n4) * subNNGrad;
    *gc44  += (6.0*SQRT2_INV*WIGNER_444_134) * (c41*c43 - c4n1*c4n3) * subNNGrad;
    *gc4n3 += (6.0*SQRT2_INV*WIGNER_444_134) * (c41*c4n4 - c4n1*c44) * subNNGrad;
    *gc4n4 += (6.0*SQRT2_INV*WIGNER_444_134) * (c41*c4n3 + c4n1*c43) * subNNGrad;
    ++tIdxFP;
    if (L3CROSS) {
        /// l1 = l2 = 2, l3 = 4
        subNNGrad = aNNGrad[tIdxFP];
        *gc20  += (WIGNER_224_000*2.0) * c20*c40 * subNNGrad;
        *gc40  += WIGNER_224_000 * c20*c20 * subNNGrad;
        *gc40  -= WIGNER_224_110 * (c21*c21 + c2n1*c2n1) * subNNGrad;
        *gc21  -= (WIGNER_224_110*2.0) * c40*c21 * subNNGrad;
        *gc2n1 -= (WIGNER_224_110*2.0) * c40*c2n1 * subNNGrad;
        *gc40  += WIGNER_224_220 * (c22*c22 + c2n2*c2n2) * subNNGrad;
        *gc22  += (WIGNER_224_220*2.0) * c40*c22 * subNNGrad;
        *gc2n2 += (WIGNER_224_220*2.0) * c40*c2n2 * subNNGrad;
        *gc20  -= (2.0*WIGNER_224_011) * (c21*c41 + c2n1*c4n1) * subNNGrad;
        *gc21  -= (2.0*WIGNER_224_011) * c20*c41 * subNNGrad;
        *gc41  -= (2.0*WIGNER_224_011) * c20*c21 * subNNGrad;
        *gc2n1 -= (2.0*WIGNER_224_011) * c20*c4n1 * subNNGrad;
        *gc4n1 -= (2.0*WIGNER_224_011) * c20*c2n1 * subNNGrad;
        *gc20  += (2.0*WIGNER_224_022) * (c22*c42 + c2n2*c4n2) * subNNGrad;
        *gc22  += (2.0*WIGNER_224_022) * c20*c42 * subNNGrad;
        *gc42  += (2.0*WIGNER_224_022) * c20*c22 * subNNGrad;
        *gc2n2 += (2.0*WIGNER_224_022) * c20*c4n2 * subNNGrad;
        *gc4n2 += (2.0*WIGNER_224_022) * c20*c2n2 * subNNGrad;
        *gc42  += (SQRT2_INV*WIGNER_224_112) * (c21*c21 - c2n1*c2n1) * subNNGrad;
        *gc4n2 += (2.0*SQRT2_INV*WIGNER_224_112) * c21*c2n1 * subNNGrad;
        *gc21  += (2.0*SQRT2_INV*WIGNER_224_112) * (c42*c21 + c2n1*c4n2) * subNNGrad;
        *gc2n1 += (2.0*SQRT2_INV*WIGNER_224_112) * (c21*c4n2 - c42*c2n1) * subNNGrad;
        *gc44  += (SQRT2_INV*WIGNER_224_224) * (c22*c22 - c2n2*c2n2) * subNNGrad;
        *gc4n4 += (2.0*SQRT2_INV*WIGNER_224_224) * c22*c2n2 * subNNGrad;
        *gc22  += (2.0*SQRT2_INV*WIGNER_224_224) * (c44*c22 + c2n2*c4n4) * subNNGrad;
        *gc2n2 += (2.0*SQRT2_INV*WIGNER_224_224) * (c22*c4n4 - c44*c2n2) * subNNGrad;
        *gc21  += (2.0*SQRT2_INV*WIGNER_224_121) * (c22*c41 + c2n2*c4n1) * subNNGrad;
        *gc2n1 += (2.0*SQRT2_INV*WIGNER_224_121) * (c2n2*c41 - c22*c4n1) * subNNGrad;
        *gc22  += (2.0*SQRT2_INV*WIGNER_224_121) * (c21*c41 - c2n1*c4n1) * subNNGrad;
        *gc41  += (2.0*SQRT2_INV*WIGNER_224_121) * (c21*c22 + c2n1*c2n2) * subNNGrad;
        *gc2n2 += (2.0*SQRT2_INV*WIGNER_224_121) * (c21*c4n1 + c2n1*c41) * subNNGrad;
        *gc4n1 += (2.0*SQRT2_INV*WIGNER_224_121) * (c21*c2n2 - c2n1*c22) * subNNGrad;
        *gc21  -= (2.0*SQRT2_INV*WIGNER_224_123) * (c22*c43 + c2n2*c4n3) * subNNGrad;
        *gc2n1 -= (2.0*SQRT2_INV*WIGNER_224_123) * (c22*c4n3 - c2n2*c43) * subNNGrad;
        *gc22  -= (2.0*SQRT2_INV*WIGNER_224_123) * (c21*c43 + c2n1*c4n3) * subNNGrad;
        *gc43  -= (2.0*SQRT2_INV*WIGNER_224_123) * (c21*c22 - c2n1*c2n2) * subNNGrad;
        *gc2n2 -= (2.0*SQRT2_INV*WIGNER_224_123) * (c21*c4n3 - c2n1*c43) * subNNGrad;
        *gc4n3 -= (2.0*SQRT2_INV*WIGNER_224_123) * (c21*c2n2 + c2n1*c22) * subNNGrad;
        ++tIdxFP;
        /// l1 = l2 = 3, l3 = 4
        subNNGrad = aNNGrad[tIdxFP];
        *gc30  += (WIGNER_334_000*2.0) * c30*c40 * subNNGrad;
        *gc40  += WIGNER_334_000 * c30*c30 * subNNGrad;
        *gc40  -= WIGNER_334_110 * (c31*c31 + c3n1*c3n1) * subNNGrad;
        *gc31  -= (WIGNER_334_110*2.0) * c40*c31 * subNNGrad;
        *gc3n1 -= (WIGNER_334_110*2.0) * c40*c3n1 * subNNGrad;
        *gc40  += WIGNER_334_220 * (c32*c32 + c3n2*c3n2) * subNNGrad;
        *gc32  += (WIGNER_334_220*2.0) * c40*c32 * subNNGrad;
        *gc3n2  += (WIGNER_334_220*2.0) * c40*c3n2 * subNNGrad;
        *gc40  -= WIGNER_334_330 * (c33*c33 + c3n3*c3n3) * subNNGrad;
        *gc33  -= (WIGNER_334_330*2.0) * c40*c33 * subNNGrad;
        *gc3n3 -= (WIGNER_334_330*2.0) * c40*c3n3 * subNNGrad;
        *gc30  -= (2.0*WIGNER_334_011) * (c31*c41 + c3n1*c4n1) * subNNGrad;
        *gc31  -= (2.0*WIGNER_334_011) * c30*c41 * subNNGrad;
        *gc41  -= (2.0*WIGNER_334_011) * c30*c31 * subNNGrad;
        *gc3n1 -= (2.0*WIGNER_334_011) * c30*c4n1 * subNNGrad;
        *gc4n1 -= (2.0*WIGNER_334_011) * c30*c3n1 * subNNGrad;
        *gc30  += (2.0*WIGNER_334_022) * (c32*c42 + c3n2*c4n2) * subNNGrad;
        *gc32  += (2.0*WIGNER_334_022) * c30*c42 * subNNGrad;
        *gc42  += (2.0*WIGNER_334_022) * c30*c32 * subNNGrad;
        *gc3n2 += (2.0*WIGNER_334_022) * c30*c4n2 * subNNGrad;
        *gc4n2 += (2.0*WIGNER_334_022) * c30*c3n2 * subNNGrad;
        *gc30  -= (2.0*WIGNER_334_033) * (c33*c43 + c3n3*c4n3) * subNNGrad;
        *gc33  -= (2.0*WIGNER_334_033) * c30*c43 * subNNGrad;
        *gc43  -= (2.0*WIGNER_334_033) * c30*c33 * subNNGrad;
        *gc3n3 -= (2.0*WIGNER_334_033) * c30*c4n3 * subNNGrad;
        *gc4n3 -= (2.0*WIGNER_334_033) * c30*c3n3 * subNNGrad;
        *gc42  += (SQRT2_INV*WIGNER_334_112) * (c31*c31 - c3n1*c3n1) * subNNGrad;
        *gc4n2 += (2.0*SQRT2_INV*WIGNER_334_112) * c31*c3n1 * subNNGrad;
        *gc31  += (2.0*SQRT2_INV*WIGNER_334_112) * (c42*c31 + c3n1*c4n2) * subNNGrad;
        *gc3n1 += (2.0*SQRT2_INV*WIGNER_334_112) * (c31*c4n2 - c42*c3n1) * subNNGrad;
        *gc44  += (SQRT2_INV*WIGNER_334_224) * (c32*c32 - c3n2*c3n2) * subNNGrad;
        *gc4n4 += (2.0*SQRT2_INV*WIGNER_334_224) * c32*c3n2 * subNNGrad;
        *gc32  += (2.0*SQRT2_INV*WIGNER_334_224) * (c44*c32 + c3n2*c4n4) * subNNGrad;
        *gc3n2 += (2.0*SQRT2_INV*WIGNER_334_224) * (c32*c4n4 - c44*c3n2) * subNNGrad;
        *gc31  += (2.0*SQRT2_INV*WIGNER_334_121) * (c32*c41 + c3n2*c4n1) * subNNGrad;
        *gc3n1 += (2.0*SQRT2_INV*WIGNER_334_121) * (c3n2*c41 - c32*c4n1) * subNNGrad;
        *gc32  += (2.0*SQRT2_INV*WIGNER_334_121) * (c31*c41 - c3n1*c4n1) * subNNGrad;
        *gc41  += (2.0*SQRT2_INV*WIGNER_334_121) * (c31*c32 + c3n1*c3n2) * subNNGrad;
        *gc3n2 += (2.0*SQRT2_INV*WIGNER_334_121) * (c31*c4n1 + c3n1*c41) * subNNGrad;
        *gc4n1 += (2.0*SQRT2_INV*WIGNER_334_121) * (c31*c3n2 - c3n1*c32) * subNNGrad;
        *gc31  -= (2.0*SQRT2_INV*WIGNER_334_123) * (c32*c43 + c3n2*c4n3) * subNNGrad;
        *gc3n1 -= (2.0*SQRT2_INV*WIGNER_334_123) * (c32*c4n3 - c3n2*c43) * subNNGrad;
        *gc32  -= (2.0*SQRT2_INV*WIGNER_334_123) * (c31*c43 + c3n1*c4n3) * subNNGrad;
        *gc43  -= (2.0*SQRT2_INV*WIGNER_334_123) * (c31*c32 - c3n1*c3n2) * subNNGrad;
        *gc3n2 -= (2.0*SQRT2_INV*WIGNER_334_123) * (c31*c4n3 - c3n1*c43) * subNNGrad;
        *gc4n3 -= (2.0*SQRT2_INV*WIGNER_334_123) * (c31*c3n2 + c3n1*c32) * subNNGrad;
        *gc31  -= (2.0*SQRT2_INV*WIGNER_334_132) * (c33*c42 + c3n3*c4n2) * subNNGrad;
        *gc3n1 -= (2.0*SQRT2_INV*WIGNER_334_132) * (c3n3*c42 - c33*c4n2) * subNNGrad;
        *gc33  -= (2.0*SQRT2_INV*WIGNER_334_132) * (c31*c42 - c3n1*c4n2) * subNNGrad;
        *gc42  -= (2.0*SQRT2_INV*WIGNER_334_132) * (c31*c33 + c3n1*c3n3) * subNNGrad;
        *gc3n3 -= (2.0*SQRT2_INV*WIGNER_334_132) * (c31*c4n2 + c3n1*c42) * subNNGrad;
        *gc4n2 -= (2.0*SQRT2_INV*WIGNER_334_132) * (c31*c3n3 - c3n1*c33) * subNNGrad;
        *gc32  -= (2.0*SQRT2_INV*WIGNER_334_231) * (c33*c41 + c3n3*c4n1) * subNNGrad;
        *gc3n2 -= (2.0*SQRT2_INV*WIGNER_334_231) * (c3n3*c41 - c33*c4n1) * subNNGrad;
        *gc33  -= (2.0*SQRT2_INV*WIGNER_334_231) * (c32*c41 - c3n2*c4n1) * subNNGrad;
        *gc41  -= (2.0*SQRT2_INV*WIGNER_334_231) * (c32*c33 + c3n2*c3n3) * subNNGrad;
        *gc3n3 -= (2.0*SQRT2_INV*WIGNER_334_231) * (c32*c4n1 + c3n2*c41) * subNNGrad;
        *gc4n1 -= (2.0*SQRT2_INV*WIGNER_334_231) * (c32*c3n3 - c3n2*c33) * subNNGrad;
        *gc31  += (2.0*SQRT2_INV*WIGNER_334_134) * (c33*c44 + c3n3*c4n4) * subNNGrad;
        *gc3n1 += (2.0*SQRT2_INV*WIGNER_334_134) * (c33*c4n4 - c3n3*c44) * subNNGrad;
        *gc33  += (2.0*SQRT2_INV*WIGNER_334_134) * (c31*c44 + c3n1*c4n4) * subNNGrad;
        *gc44  += (2.0*SQRT2_INV*WIGNER_334_134) * (c31*c33 - c3n1*c3n3) * subNNGrad;
        *gc3n3 += (2.0*SQRT2_INV*WIGNER_334_134) * (c31*c4n4 - c3n1*c44) * subNNGrad;
        *gc4n4 += (2.0*SQRT2_INV*WIGNER_334_134) * (c31*c3n3 + c3n1*c33) * subNNGrad;
        ++tIdxFP;
        /// l1 = 2, l2 = l3 = 4
        subNNGrad = aNNGrad[tIdxFP];
        *gc20  += WIGNER_244_000 * c40*c40 * subNNGrad;
        *gc40  += (WIGNER_244_000*2.0) * c20*c40 * subNNGrad;
        *gc20  -= WIGNER_244_011 * (c41*c41 + c4n1*c4n1) * subNNGrad;
        *gc41  -= (WIGNER_244_011*2.0) * c20*c41 * subNNGrad;
        *gc4n1 -= (WIGNER_244_011*2.0) * c20*c4n1 * subNNGrad;
        *gc20  += WIGNER_244_022 * (c42*c42 + c4n2*c4n2) * subNNGrad;
        *gc42  += (WIGNER_244_022*2.0) * c20*c42 * subNNGrad;
        *gc4n2 += (WIGNER_244_022*2.0) * c20*c4n2 * subNNGrad;
        *gc20  -= WIGNER_244_033 * (c43*c43 + c4n3*c4n3) * subNNGrad;
        *gc43  -= (WIGNER_244_033*2.0) * c20*c43 * subNNGrad;
        *gc4n3 -= (WIGNER_244_033*2.0) * c20*c4n3 * subNNGrad;
        *gc20  += WIGNER_244_044 * (c44*c44 + c4n4*c4n4) * subNNGrad;
        *gc44  += (WIGNER_244_044*2.0) * c20*c44 * subNNGrad;
        *gc4n4 += (WIGNER_244_044*2.0) * c20*c4n4 * subNNGrad;
        *gc40  -= (2.0*WIGNER_244_110) * (c21*c41 + c2n1*c4n1) * subNNGrad;
        *gc21  -= (2.0*WIGNER_244_110) * c40*c41 * subNNGrad;
        *gc41  -= (2.0*WIGNER_244_110) * c40*c21 * subNNGrad;
        *gc2n1 -= (2.0*WIGNER_244_110) * c40*c4n1 * subNNGrad;
        *gc4n1 -= (2.0*WIGNER_244_110) * c40*c2n1 * subNNGrad;
        *gc40  += (2.0*WIGNER_244_220) * (c22*c42 + c2n2*c4n2) * subNNGrad;
        *gc22  += (2.0*WIGNER_244_220) * c40*c42 * subNNGrad;
        *gc42  += (2.0*WIGNER_244_220) * c40*c22 * subNNGrad;
        *gc2n2 += (2.0*WIGNER_244_220) * c40*c4n2 * subNNGrad;
        *gc4n2 += (2.0*WIGNER_244_220) * c40*c2n2 * subNNGrad;
        *gc22  += (SQRT2_INV*WIGNER_244_211) * (c41*c41 - c4n1*c4n1) * subNNGrad;
        *gc2n2 += (2.0*SQRT2_INV*WIGNER_244_211) * c41*c4n1 * subNNGrad;
        *gc41  += (2.0*SQRT2_INV*WIGNER_244_211) * (c22*c41 + c2n2*c4n1) * subNNGrad;
        *gc4n1 += (2.0*SQRT2_INV*WIGNER_244_211) * (c2n2*c41 - c22*c4n1) * subNNGrad;
        *gc21  += (2.0*SQRT2_INV*WIGNER_244_112) * (c41*c42 + c4n1*c4n2) * subNNGrad;
        *gc2n1 += (2.0*SQRT2_INV*WIGNER_244_112) * (c41*c4n2 - c4n1*c42) * subNNGrad;
        *gc41  += (2.0*SQRT2_INV*WIGNER_244_112) * (c21*c42 + c2n1*c4n2) * subNNGrad;
        *gc42  += (2.0*SQRT2_INV*WIGNER_244_112) * (c21*c41 - c2n1*c4n1) * subNNGrad;
        *gc4n1 += (2.0*SQRT2_INV*WIGNER_244_112) * (c21*c4n2 - c2n1*c42) * subNNGrad;
        *gc4n2 += (2.0*SQRT2_INV*WIGNER_244_112) * (c21*c4n1 + c2n1*c41) * subNNGrad;
        *gc22  += (2.0*SQRT2_INV*WIGNER_244_224) * (c42*c44 + c4n2*c4n4) * subNNGrad;
        *gc2n2 += (2.0*SQRT2_INV*WIGNER_244_224) * (c42*c4n4 - c4n2*c44) * subNNGrad;
        *gc42  += (2.0*SQRT2_INV*WIGNER_244_224) * (c22*c44 + c2n2*c4n4) * subNNGrad;
        *gc44  += (2.0*SQRT2_INV*WIGNER_244_224) * (c22*c42 - c2n2*c4n2) * subNNGrad;
        *gc4n2 += (2.0*SQRT2_INV*WIGNER_244_224) * (c22*c4n4 - c2n2*c44) * subNNGrad;
        *gc4n4 += (2.0*SQRT2_INV*WIGNER_244_224) * (c22*c4n2 + c2n2*c42) * subNNGrad;
        *gc21  -= (2.0*SQRT2_INV*WIGNER_244_123) * (c42*c43 + c4n2*c4n3) * subNNGrad;
        *gc2n1 -= (2.0*SQRT2_INV*WIGNER_244_123) * (c42*c4n3 - c4n2*c43) * subNNGrad;
        *gc42  -= (2.0*SQRT2_INV*WIGNER_244_123) * (c21*c43 + c2n1*c4n3) * subNNGrad;
        *gc43  -= (2.0*SQRT2_INV*WIGNER_244_123) * (c21*c42 - c2n1*c4n2) * subNNGrad;
        *gc4n2 -= (2.0*SQRT2_INV*WIGNER_244_123) * (c21*c4n3 - c2n1*c43) * subNNGrad;
        *gc4n3 -= (2.0*SQRT2_INV*WIGNER_244_123) * (c21*c4n2 + c2n1*c42) * subNNGrad;
        *gc22  -= (2.0*SQRT2_INV*WIGNER_244_213) * (c41*c43 + c4n1*c4n3) * subNNGrad;
        *gc2n2 -= (2.0*SQRT2_INV*WIGNER_244_213) * (c41*c4n3 - c4n1*c43) * subNNGrad;
        *gc41  -= (2.0*SQRT2_INV*WIGNER_244_213) * (c22*c43 + c2n2*c4n3) * subNNGrad;
        *gc43  -= (2.0*SQRT2_INV*WIGNER_244_213) * (c22*c41 - c2n2*c4n1) * subNNGrad;
        *gc4n1 -= (2.0*SQRT2_INV*WIGNER_244_213) * (c22*c4n3 - c2n2*c43) * subNNGrad;
        *gc4n3 -= (2.0*SQRT2_INV*WIGNER_244_213) * (c22*c4n1 + c2n2*c41) * subNNGrad;
        *gc21  += (2.0*SQRT2_INV*WIGNER_244_134) * (c43*c44 + c4n3*c4n4) * subNNGrad;
        *gc2n1 += (2.0*SQRT2_INV*WIGNER_244_134) * (c43*c4n4 - c4n3*c44) * subNNGrad;
        *gc43  += (2.0*SQRT2_INV*WIGNER_244_134) * (c21*c44 + c2n1*c4n4) * subNNGrad;
        *gc44  += (2.0*SQRT2_INV*WIGNER_244_134) * (c21*c43 - c2n1*c4n3) * subNNGrad;
        *gc4n3 += (2.0*SQRT2_INV*WIGNER_244_134) * (c21*c4n4 - c2n1*c44) * subNNGrad;
        *gc4n4 += (2.0*SQRT2_INV*WIGNER_244_134) * (c21*c4n3 + c2n1*c43) * subNNGrad;
        ++tIdxFP;
        /// l1 = 1, l2 = 3, l3 = 4
        subNNGrad = aNNGrad[tIdxFP];
        *gc10  += WIGNER_134_000 * c30*c40 * subNNGrad;
        *gc30  += WIGNER_134_000 * c10*c40 * subNNGrad;
        *gc40  += WIGNER_134_000 * c10*c30 * subNNGrad;
        *gc10  -= WIGNER_134_011 * (c31*c41 + c3n1*c4n1) * subNNGrad;
        *gc31  -= WIGNER_134_011 * c10*c41 * subNNGrad;
        *gc41  -= WIGNER_134_011 * c10*c31 * subNNGrad;
        *gc3n1 -= WIGNER_134_011 * c10*c4n1 * subNNGrad;
        *gc4n1 -= WIGNER_134_011 * c10*c3n1 * subNNGrad;
        *gc10  += WIGNER_134_022 * (c32*c42 + c3n2*c4n2) * subNNGrad;
        *gc32  += WIGNER_134_022 * c10*c42 * subNNGrad;
        *gc42  += WIGNER_134_022 * c10*c32 * subNNGrad;
        *gc3n2 += WIGNER_134_022 * c10*c4n2 * subNNGrad;
        *gc4n2 += WIGNER_134_022 * c10*c3n2 * subNNGrad;
        *gc10  -= WIGNER_134_033 * (c33*c43 + c3n3*c4n3) * subNNGrad;
        *gc33  -= WIGNER_134_033 * c10*c43 * subNNGrad;
        *gc43  -= WIGNER_134_033 * c10*c33 * subNNGrad;
        *gc3n3 -= WIGNER_134_033 * c10*c4n3 * subNNGrad;
        *gc4n3 -= WIGNER_134_033 * c10*c3n3 * subNNGrad;
        *gc40  -= WIGNER_134_110 * (c11*c31 + c1n1*c3n1) * subNNGrad;
        *gc11  -= WIGNER_134_110 * c40*c31 * subNNGrad;
        *gc31  -= WIGNER_134_110 * c40*c11 * subNNGrad;
        *gc1n1 -= WIGNER_134_110 * c40*c3n1 * subNNGrad;
        *gc3n1 -= WIGNER_134_110 * c40*c1n1 * subNNGrad;
        *gc30  -= WIGNER_134_101 * (c11*c41 + c1n1*c4n1) * subNNGrad;
        *gc11  -= WIGNER_134_101 * c30*c41 * subNNGrad;
        *gc41  -= WIGNER_134_101 * c30*c11 * subNNGrad;
        *gc1n1 -= WIGNER_134_101 * c30*c4n1 * subNNGrad;
        *gc4n1 -= WIGNER_134_101 * c30*c1n1 * subNNGrad;
        *gc11  += (SQRT2_INV*WIGNER_134_112) * (c31*c42 + c3n1*c4n2) * subNNGrad;
        *gc1n1 += (SQRT2_INV*WIGNER_134_112) * (c31*c4n2 - c3n1*c42) * subNNGrad;
        *gc31  += (SQRT2_INV*WIGNER_134_112) * (c11*c42 + c1n1*c4n2) * subNNGrad;
        *gc42  += (SQRT2_INV*WIGNER_134_112) * (c11*c31 - c1n1*c3n1) * subNNGrad;
        *gc3n1 += (SQRT2_INV*WIGNER_134_112) * (c11*c4n2 - c1n1*c42) * subNNGrad;
        *gc4n2 += (SQRT2_INV*WIGNER_134_112) * (c11*c3n1 + c1n1*c31) * subNNGrad;
        *gc11  += (SQRT2_INV*WIGNER_134_121) * (c32*c41 + c3n2*c4n1) * subNNGrad;
        *gc1n1 += (SQRT2_INV*WIGNER_134_121) * (c3n2*c41 - c32*c4n1) * subNNGrad;
        *gc32  += (SQRT2_INV*WIGNER_134_121) * (c11*c41 - c1n1*c4n1) * subNNGrad;
        *gc41  += (SQRT2_INV*WIGNER_134_121) * (c11*c32 + c1n1*c3n2) * subNNGrad;
        *gc3n2 += (SQRT2_INV*WIGNER_134_121) * (c11*c4n1 + c1n1*c41) * subNNGrad;
        *gc4n1 += (SQRT2_INV*WIGNER_134_121) * (c11*c3n2 - c1n1*c32) * subNNGrad;
        *gc11  -= (SQRT2_INV*WIGNER_134_123) * (c32*c43 + c3n2*c4n3) * subNNGrad;
        *gc1n1 -= (SQRT2_INV*WIGNER_134_123) * (c32*c4n3 - c3n2*c43) * subNNGrad;
        *gc32  -= (SQRT2_INV*WIGNER_134_123) * (c11*c43 + c1n1*c4n3) * subNNGrad;
        *gc43  -= (SQRT2_INV*WIGNER_134_123) * (c11*c32 - c1n1*c3n2) * subNNGrad;
        *gc3n2 -= (SQRT2_INV*WIGNER_134_123) * (c11*c4n3 - c1n1*c43) * subNNGrad;
        *gc4n3 -= (SQRT2_INV*WIGNER_134_123) * (c11*c3n2 + c1n1*c32) * subNNGrad;
        *gc11  -= (SQRT2_INV*WIGNER_134_132) * (c33*c42 + c3n3*c4n2) * subNNGrad;
        *gc1n1 -= (SQRT2_INV*WIGNER_134_132) * (c3n3*c42 - c33*c4n2) * subNNGrad;
        *gc33  -= (SQRT2_INV*WIGNER_134_132) * (c11*c42 - c1n1*c4n2) * subNNGrad;
        *gc42  -= (SQRT2_INV*WIGNER_134_132) * (c11*c33 + c1n1*c3n3) * subNNGrad;
        *gc3n3 -= (SQRT2_INV*WIGNER_134_132) * (c11*c4n2 + c1n1*c42) * subNNGrad;
        *gc4n2 -= (SQRT2_INV*WIGNER_134_132) * (c11*c3n3 - c1n1*c33) * subNNGrad;
        *gc11  += (SQRT2_INV*WIGNER_134_134) * (c33*c44 + c3n3*c4n4) * subNNGrad;
        *gc1n1 += (SQRT2_INV*WIGNER_134_134) * (c33*c4n4 - c3n3*c44) * subNNGrad;
        *gc33  += (SQRT2_INV*WIGNER_134_134) * (c11*c44 + c1n1*c4n4) * subNNGrad;
        *gc44  += (SQRT2_INV*WIGNER_134_134) * (c11*c33 - c1n1*c3n3) * subNNGrad;
        *gc3n3 += (SQRT2_INV*WIGNER_134_134) * (c11*c4n4 - c1n1*c44) * subNNGrad;
        *gc4n4 += (SQRT2_INV*WIGNER_134_134) * (c11*c3n3 + c1n1*c33) * subNNGrad;
        ++tIdxFP;
    }
}


template <jint LMAXMAX, jint LMALL, jint WTYPE>
static void calCnlm(jdouble *aNlDx, jdouble *aNlDy, jdouble *aNlDz, jint *aNlType, jint aNN,
                    jdouble *rCnlm, jdouble *rForwardCache, jboolean aFullCache,
                    jint aTypeNum, jdouble aRCut, jint aNMax, jdouble *aFuseWeight, jint aFuseSize) noexcept {
    const jint tSizeBnlm = (aNMax+1)*LMALL;
    // init cache
    jdouble *rRn = NULL, *rY = NULL;
    jdouble *rBnlm = NULL;
    jdouble *rNlRn = NULL, *rNlFc = NULL, *rNlY = NULL;
    jdouble *rNlBnlm = NULL;
    if (aFullCache) {
        rNlRn = rForwardCache;
        rNlFc = rNlRn + aNN*(aNMax+1);
        rNlY = rNlFc + aNN;
    } else {
        rRn = rForwardCache;
        rY = rRn + (aNMax+1);
    }
    if (WTYPE==jsex_nnap_basis_SphericalChebyshev_WTYPE_FUSE) {
        if (aFullCache) {
            rNlBnlm = rNlY + aNN*LMALL;
        } else {
            rBnlm = rY + LMALL;
        }
    }
    // loop for neighbor
    for (jint j = 0; j < aNN; ++j) {
        jint type = aNlType[j];
        jdouble dx = aNlDx[j], dy = aNlDy[j], dz = aNlDz[j];
        jdouble dis = sqrt((double)(dx*dx + dy*dy + dz*dz));
        // check rcut for merge
        if (dis >= aRCut) continue;
        // cal fc
        jdouble fc = JSE_NNAP::calFc(dis, aRCut);
        if (aFullCache) rNlFc[j] = fc;
        // cal Rn
        if (aFullCache) rRn = rNlRn + j*(aNMax+1);
        JSE_NNAP::calRn(rRn, aNMax, dis, aRCut);
        // cal Y
        if (aFullCache) rY = rNlY + j*LMALL;
        realSphericalHarmonicsFull4<LMAXMAX>(dx, dy, dz, dis, rY);
        // cal cnlm
        if (WTYPE==jsex_nnap_basis_SphericalChebyshev_WTYPE_FUSE) {
            // cal bnlm
            if (aFullCache) rBnlm = rNlBnlm + j*tSizeBnlm;
            calBnlm<LMALL>(rBnlm, rY, fc, rRn, aNMax);
            // mplus2cnlm
            jdouble *tFuseWeight = aFuseWeight;
            jdouble *tCnlm = rCnlm;
            for (jint k = 0; k < aFuseSize; ++k) {
                jdouble wt = tFuseWeight[type-1];
                mplusBnlm2Cnlm<LMALL>(tCnlm, rBnlm, wt, aNMax);
                tFuseWeight += aTypeNum;
                tCnlm += tSizeBnlm;
            }
        } else
        if (WTYPE==jsex_nnap_basis_SphericalChebyshev_WTYPE_NONE || aTypeNum==1) {
            mplusCnlm<LMALL>(rCnlm, rY, fc, rRn, aNMax);
        } else
        if (WTYPE==jsex_nnap_basis_SphericalChebyshev_WTYPE_FULL) {
            jdouble *tCnlm = rCnlm + tSizeBnlm*(type-1);
            mplusCnlm<LMALL>(tCnlm, rY, fc, rRn, aNMax);
        } else
        if (WTYPE==jsex_nnap_basis_SphericalChebyshev_WTYPE_EXFULL) {
            jdouble *tCnlmWt = rCnlm + tSizeBnlm*type;
            mplusCnlmWt<LMALL>(rCnlm, tCnlmWt, rY, fc, rRn, 1.0, aNMax);
        } else
        if (WTYPE==jsex_nnap_basis_SphericalChebyshev_WTYPE_DEFAULT) {
            jdouble wt = ((type&1)==1) ? type : -type;
            jdouble *tCnlmWt = rCnlm + tSizeBnlm;
            mplusCnlmWt<LMALL>(rCnlm, tCnlmWt, rY, fc, rRn, wt, aNMax);
        }
    }
}

template <jint LMAX, jboolean NO_RADIAL, jint L3MAX, jboolean L3CROSS, jint WTYPE>
static inline void calFp(jdouble *aNlDx, jdouble *aNlDy, jdouble *aNlDz, jint *aNlType, jint aNN, jdouble *rFp,
                         jdouble *rForwardCache, jboolean aFullCache,
                         jint aTypeNum, jdouble aRCut, jint aNMax, jdouble *aFuseWeight, jint aFuseSize) noexcept {
    // const init
    jint tSizeN;
    switch(WTYPE) {
    case jsex_nnap_basis_SphericalChebyshev_WTYPE_EXFULL: {
        tSizeN = aTypeNum>1 ? (aTypeNum+1)*(aNMax+1) : (aNMax+1);
        break;
    }
    case jsex_nnap_basis_SphericalChebyshev_WTYPE_FULL: {
        tSizeN = aTypeNum*(aNMax+1);
        break;
    }
    case jsex_nnap_basis_SphericalChebyshev_WTYPE_NONE: {
        tSizeN = aNMax+1;
        break;
    }
    case jsex_nnap_basis_SphericalChebyshev_WTYPE_DEFAULT: {
        tSizeN = aTypeNum>1 ? (aNMax+aNMax+2) : (aNMax+1);
        break;
    }
    case jsex_nnap_basis_SphericalChebyshev_WTYPE_FUSE: {
        tSizeN = aFuseSize*(aNMax+1);
        break;
    }
    default: {
        tSizeN = 0;
        break;
    }}
    const jint tSizeL = (NO_RADIAL?LMAX:(LMAX+1)) + (L3CROSS?L3NCOLS:L3NCOLS_NOCROSS)[L3MAX];
    const jint tLMaxMax = LMAX>L3MAX ? LMAX : L3MAX;
    const jint tLMAll = (tLMaxMax+1)*(tLMaxMax+1);
    const jint tSizeCnlm = tSizeN*tLMAll;
    // init cache
    jdouble *rCnlm = rForwardCache;
    jdouble *rForwardCacheElse = rCnlm + tSizeCnlm;
    // clear cnlm first
    for (jint i = 0; i < tSizeCnlm; ++i) {
        rCnlm[i] = 0.0;
    }
    // do cal
    calCnlm<tLMaxMax, tLMAll, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, rCnlm, rForwardCacheElse, aFullCache, aTypeNum, aRCut, aNMax, aFuseWeight, aFuseSize);
    for (jint n=0, tShift=0, tShiftFp=0; n<tSizeN; ++n, tShift+=tLMAll, tShiftFp+=tSizeL) {
        calL2_<LMAX, NO_RADIAL>(rCnlm+tShift, rFp+tShiftFp);
        calL3_<L3MAX, L3CROSS>(rCnlm+tShift, rFp+tShiftFp, LMAX, NO_RADIAL);
    }
}

template <jint LMAX, jboolean NO_RADIAL, jint L3MAX, jboolean L3CROSS, jint WTYPE>
static void calBackward(jdouble *aNlDx, jdouble *aNlDy, jdouble *aNlDz, jint *aNlType, jint aNN,
                        jdouble *aGradFp, jdouble *rGradPara, jdouble *aForwardCache, jdouble *rBackwardCache,
                        jint aTypeNum, jdouble aRCut, jint aNMax, jint aFuseSize) noexcept {
    static_assert(WTYPE!=jsex_nnap_basis_SphericalChebyshev_WTYPE_DEFAULT &&
                  WTYPE!=jsex_nnap_basis_SphericalChebyshev_WTYPE_NONE &&
                  WTYPE!=jsex_nnap_basis_SphericalChebyshev_WTYPE_FULL &&
                  WTYPE!=jsex_nnap_basis_SphericalChebyshev_WTYPE_EXFULL, "WTYPE INVALID");
    // const init
    jint tSizeN;
    if (WTYPE==jsex_nnap_basis_SphericalChebyshev_WTYPE_FUSE) {
        tSizeN = aFuseSize*(aNMax+1);
    } else {
        tSizeN = 0;
    }
    const jint tSizeL = (NO_RADIAL?LMAX:(LMAX+1)) + (L3CROSS?L3NCOLS:L3NCOLS_NOCROSS)[L3MAX];
    const jint tLMaxMax = LMAX>L3MAX ? LMAX : L3MAX;
    const jint tLMAll = (tLMaxMax+1)*(tLMaxMax+1);
    const jint tSizeCnlm = tSizeN*tLMAll;
    const jint tSizeBnlm = (aNMax+1)*tLMAll;
    // init cache
    jdouble *tCnlm = aForwardCache;
    jdouble *tNlBnlm = tCnlm + tSizeCnlm + aNN*(aNMax+1 + 1 + tLMAll);
    jdouble *rGradCnlm = rBackwardCache;
    // cal grad cnlm
    for (jint n=0, tShift=0, tShiftFp=0; n<tSizeN; ++n, tShift+=tLMAll, tShiftFp+=tSizeL) {
        calGradL2_<LMAX, NO_RADIAL>(tCnlm+tShift, rGradCnlm+tShift, aGradFp+tShiftFp);
        calGradL3_<L3MAX, L3CROSS>(tCnlm+tShift, rGradCnlm+tShift, aGradFp+tShiftFp, LMAX, NO_RADIAL);
    }
    // plus to para
    for (jint j = 0; j < aNN; ++j) {
        jint type = aNlType[j];
        jdouble dx = aNlDx[j], dy = aNlDy[j], dz = aNlDz[j];
        jdouble dis = sqrt((double)(dx*dx + dy*dy + dz*dz));
        // check rcut for merge
        if (dis >= aRCut) continue;
        jdouble *tBnlm = tNlBnlm + j*tSizeBnlm;
        if (WTYPE==jsex_nnap_basis_SphericalChebyshev_WTYPE_FUSE) {
            jdouble *tGradPara = rGradPara;
            jdouble *tGradCnlm = rGradCnlm;
            for (jint fi = 0; fi < aFuseSize; ++fi) {
                tGradPara[type-1] += dotBnlmGradCnlm<tLMAll>(tBnlm, tGradCnlm, aNMax);
                tGradPara += aTypeNum;
                tGradCnlm += tSizeBnlm;
            }
            continue;
        }
    }
}

template <jint LMAX, jboolean NO_RADIAL, jint L3MAX, jboolean L3CROSS, jint WTYPE>
static void calForce(jdouble *aNlDx, jdouble *aNlDy, jdouble *aNlDz, jint *aNlType, jint aNN,
                     jdouble *aNNGrad, jdouble *rFx, jdouble *rFy, jdouble *rFz,
                     jdouble *aForwardCache, jdouble *rForwardForceCache, jboolean aFullCache,
                     jint aTypeNum, jdouble aRCut, jint aNMax, jdouble *aFuseWeight, jint aFuseSize) noexcept {
    // const init
    jint tSizeN;
    switch(WTYPE) {
    case jsex_nnap_basis_SphericalChebyshev_WTYPE_EXFULL: {
        tSizeN = aTypeNum>1 ? (aTypeNum+1)*(aNMax+1) : (aNMax+1);
        break;
    }
    case jsex_nnap_basis_SphericalChebyshev_WTYPE_FULL: {
        tSizeN = aTypeNum*(aNMax+1);
        break;
    }
    case jsex_nnap_basis_SphericalChebyshev_WTYPE_NONE: {
        tSizeN = aNMax+1;
        break;
    }
    case jsex_nnap_basis_SphericalChebyshev_WTYPE_DEFAULT: {
        tSizeN = aTypeNum>1 ? (aNMax+aNMax+2) : (aNMax+1);
        break;
    }
    case jsex_nnap_basis_SphericalChebyshev_WTYPE_FUSE: {
        tSizeN = aFuseSize*(aNMax+1);
        break;
    }
    default: {
        tSizeN = 0;
        break;
    }}
    const jint tSizeL = (NO_RADIAL?LMAX:(LMAX+1)) + (L3CROSS?L3NCOLS:L3NCOLS_NOCROSS)[L3MAX];
    const jint tLMaxMax = LMAX>L3MAX ? LMAX : L3MAX;
    const jint tLMAll = (tLMaxMax+1)*(tLMaxMax+1);
    const jint tSizeCnlm = tSizeN*tLMAll;
    const jint tSizeBnlm = (aNMax+1)*tLMAll;
    // init cache
    jdouble *tCnlm = aForwardCache;
    jdouble *tNlRn = tCnlm + tSizeCnlm;
    jdouble *tNlFc = tNlRn + aNN*(aNMax+1);
    jdouble *tNlY = tNlFc + aNN;
    jdouble *rGradCnlm = rForwardForceCache;
    jdouble *rRnPx = NULL, *rRnPy = NULL, *rRnPz = NULL, *rCheby2 = NULL;
    jdouble *rYPx = NULL, *rYPy = NULL, *rYPz = NULL, *rYPtheta = NULL, *rYPphi = NULL;
    jdouble *rGradBnlm = NULL;
    jdouble *rNlRnPx = NULL, *rNlRnPy = NULL, *rNlRnPz = NULL;
    jdouble *rNlFcPx = NULL, *rNlFcPy = NULL, *rNlFcPz = NULL;
    jdouble *rNlYPx = NULL, *rNlYPy = NULL, *rNlYPz = NULL;
    jdouble *rNlGradBnlm = NULL;
    if (aFullCache) {
        rNlRnPx = rGradCnlm + tSizeCnlm;
        rNlRnPy = rNlRnPx + aNN*(aNMax+1);
        rNlRnPz = rNlRnPy + aNN*(aNMax+1);
        rNlFcPx = rNlRnPz + aNN*(aNMax+1);
        rNlFcPy = rNlFcPx + aNN;
        rNlFcPz = rNlFcPy + aNN;
        rNlYPx = rNlFcPz + aNN;
        rNlYPy = rNlYPx + aNN*tLMAll;
        rNlYPz = rNlYPy + aNN*tLMAll;
        rYPtheta = rNlYPz + aNN*tLMAll;
        rYPphi = rYPtheta + tLMAll;
        rCheby2 = rYPphi + tLMAll;
    } else {
        rRnPx = rGradCnlm + tSizeCnlm;;
        rRnPy = rRnPx + (aNMax+1);
        rRnPz = rRnPy + (aNMax+1);
        rYPx = rRnPz + (aNMax+1);
        rYPy = rYPx + tLMAll;
        rYPz = rYPy + tLMAll;
        rYPtheta = rYPz + tLMAll;
        rYPphi = rYPtheta + tLMAll;
        rCheby2 = rYPphi + tLMAll;
    }
    if (WTYPE==jsex_nnap_basis_SphericalChebyshev_WTYPE_FUSE) {
        if (aFullCache) {
            rNlGradBnlm = rCheby2 + (aNMax+1);
        } else {
            rGradBnlm = rCheby2 + (aNMax+1);
        }
    }
    // forward need init gradCnlm here
    for (jint i = 0; i < tSizeCnlm; ++i) {
        rGradCnlm[i] = 0.0;
    }
    for (jint n=0, tShift=0, tShiftFp=0; n<tSizeN; ++n, tShift+=tLMAll, tShiftFp+=tSizeL) {
        calGradL2_<LMAX, NO_RADIAL>(tCnlm+tShift, rGradCnlm+tShift, aNNGrad+tShiftFp);
        calGradL3_<L3MAX, L3CROSS>(tCnlm+tShift, rGradCnlm+tShift, aNNGrad+tShiftFp, LMAX, NO_RADIAL);
    }
    // loop for neighbor
    for (jint j = 0; j < aNN; ++j) {
        // init nl
        jint type = aNlType[j];
        jdouble dx = aNlDx[j], dy = aNlDy[j], dz = aNlDz[j];
        jdouble dis = sqrt((double)(dx*dx + dy*dy + dz*dz));
        // check rcut for merge
        if (dis >= aRCut) continue;
        // get fc Rn Y
        jdouble fc = tNlFc[j];
        jdouble *tRn = tNlRn + j*(aNMax+1);
        jdouble *tY = tNlY + j*tLMAll;
        // cal fcPxyz
        jdouble fcPx, fcPy, fcPz;
        JSE_NNAP::calFcPxyz(&fcPx, &fcPy, &fcPz, dis, aRCut, dx, dy, dz);
        if (aFullCache) {
            rNlFcPx[j] = fcPx;
            rNlFcPy[j] = fcPy;
            rNlFcPz[j] = fcPz;
        }
        // cal RnPxyz
        if (aFullCache) {
            rRnPx = rNlRnPx + j*(aNMax+1);
            rRnPy = rNlRnPy + j*(aNMax+1);
            rRnPz = rNlRnPz + j*(aNMax+1);
        }
        JSE_NNAP::calRnPxyz(rRnPx, rRnPy, rRnPz, rCheby2, aNMax, dis, aRCut, dx, dy, dz);
        // cal Ylm
        if (aFullCache) {
            rYPx = rNlYPx + j*tLMAll;
            rYPy = rNlYPy + j*tLMAll;
            rYPz = rNlYPz + j*tLMAll;
        }
        calYPxyz<tLMaxMax, tLMAll>(tY, dx, dy, dz, dis, rYPx, rYPy, rYPz, rYPtheta, rYPphi);
        // cal fxyz
        if (WTYPE==jsex_nnap_basis_SphericalChebyshev_WTYPE_FUSE) {
            if (aFullCache) {
                rGradBnlm = rNlGradBnlm + j*tSizeBnlm;
            }
            for (jint k = 0; k < tSizeBnlm; ++k) {
                rGradBnlm[k] = 0.0;
            }
            jdouble *tFuseWeight = aFuseWeight;
            jdouble *tGradCnlm = rGradCnlm;
            for (jint k = 0; k < aFuseSize; ++k) {
                jdouble wt = tFuseWeight[type-1];
                mplusBnlm2Cnlm<tLMAll>(rGradBnlm, tGradCnlm, wt, aNMax);
                tFuseWeight += aTypeNum;
                tGradCnlm += tSizeBnlm;
            }
            gradBnlm2Fxyz<tLMAll>(j, rGradBnlm, rYPtheta, tY, fc, tRn, aNMax, fcPx, fcPy, fcPz, rRnPx, rRnPy, rRnPz, rYPx, rYPy, rYPz, rFx, rFy, rFz);
        } else
        if (WTYPE==jsex_nnap_basis_SphericalChebyshev_WTYPE_NONE || aTypeNum==1) {
            gradBnlm2Fxyz<tLMAll>(j, rGradCnlm, rYPtheta, tY, fc, tRn, aNMax, fcPx, fcPy, fcPz, rRnPx, rRnPy, rRnPz, rYPx, rYPy, rYPz, rFx, rFy, rFz);
        } else
        if (WTYPE==jsex_nnap_basis_SphericalChebyshev_WTYPE_FULL) {
            jdouble *tGradBnlm = rGradCnlm + tSizeBnlm*(type-1);
            gradBnlm2Fxyz<tLMAll>(j, tGradBnlm, rYPtheta, tY, fc, tRn, aNMax, fcPx, fcPy, fcPz, rRnPx, rRnPy, rRnPz, rYPx, rYPy, rYPz, rFx, rFy, rFz);
        } else
        if (WTYPE==jsex_nnap_basis_SphericalChebyshev_WTYPE_EXFULL) {
            jdouble *tGradCnlmWt = rGradCnlm + tSizeBnlm*type;
            gradCnlmWt2Fxyz<tLMAll>(j, rGradCnlm, tGradCnlmWt, rYPtheta, tY, fc, tRn, 1.0, aNMax, fcPx, fcPy, fcPz, rRnPx, rRnPy, rRnPz, rYPx, rYPy, rYPz, rFx, rFy, rFz);
        } else
        if (WTYPE==jsex_nnap_basis_SphericalChebyshev_WTYPE_DEFAULT) {
            jdouble wt = ((type&1)==1) ? type : -type;
            jdouble *tGradCnlmWt = rGradCnlm + tSizeBnlm;
            gradCnlmWt2Fxyz<tLMAll>(j, rGradCnlm, tGradCnlmWt, rYPtheta, tY, fc, tRn, wt, aNMax, fcPx, fcPy, fcPz, rRnPx, rRnPy, rRnPz, rYPx, rYPy, rYPz, rFx, rFy, rFz);
        }
    }
}

template <jboolean NO_RADIAL, jint L3MAX, jboolean L3CROSS, jint WTYPE>
static inline void calFp(jdouble *aNlDx, jdouble *aNlDy, jdouble *aNlDz, jint *aNlType, jint aNN,
                         jdouble *rFp, jdouble *rForwardCache, jboolean aFullCache,
                         jint aTypeNum, jdouble aRCut, jint aNMax, jint aLMax, jdouble *aFuseWeight, jint aFuseSize) noexcept {
    switch (aLMax) {
    case 0: {
        calFp<0, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, rFp, rForwardCache, aFullCache, aTypeNum, aRCut, aNMax, aFuseWeight, aFuseSize);
        return;
    }
    case 1: {
        calFp<1, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, rFp, rForwardCache, aFullCache, aTypeNum, aRCut, aNMax, aFuseWeight, aFuseSize);
        return;
    }
    case 2: {
        calFp<2, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, rFp, rForwardCache, aFullCache, aTypeNum, aRCut, aNMax, aFuseWeight, aFuseSize);
        return;
    }
    case 3: {
        calFp<3, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, rFp, rForwardCache, aFullCache, aTypeNum, aRCut, aNMax, aFuseWeight, aFuseSize);
        return;
    }
    case 4: {
        calFp<4, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, rFp, rForwardCache, aFullCache, aTypeNum, aRCut, aNMax, aFuseWeight, aFuseSize);
        return;
    }
    case 5: {
        calFp<5, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, rFp, rForwardCache, aFullCache, aTypeNum, aRCut, aNMax, aFuseWeight, aFuseSize);
        return;
    }
    case 6: {
        calFp<6, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, rFp, rForwardCache, aFullCache, aTypeNum, aRCut, aNMax, aFuseWeight, aFuseSize);
        return;
    }
    case 7: {
        calFp<7, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, rFp, rForwardCache, aFullCache, aTypeNum, aRCut, aNMax, aFuseWeight, aFuseSize);
        return;
    }
    case 8: {
        calFp<8, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, rFp, rForwardCache, aFullCache, aTypeNum, aRCut, aNMax, aFuseWeight, aFuseSize);
        return;
    }
    default: {
        return;
    }}
}
template <jint L3MAX, jboolean L3CROSS, jint WTYPE>
static inline void calFp(jdouble *aNlDx, jdouble *aNlDy, jdouble *aNlDz, jint *aNlType, jint aNN,
                         jdouble *rFp, jdouble *rForwardCache, jboolean aFullCache,
                         jint aTypeNum, jdouble aRCut, jint aNMax, jint aLMax, jboolean aNoRadial, jdouble *aFuseWeight, jint aFuseSize) noexcept {
    if (aNoRadial) {
        calFp<JNI_TRUE, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, rFp, rForwardCache, aFullCache, aTypeNum, aRCut, aNMax, aLMax, aFuseWeight, aFuseSize);
    } else {
        calFp<JNI_FALSE, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, rFp, rForwardCache, aFullCache, aTypeNum, aRCut, aNMax, aLMax, aFuseWeight, aFuseSize);
    }
}
template <jint WTYPE>
static inline void calFp(jdouble *aNlDx, jdouble *aNlDy, jdouble *aNlDz, jint *aNlType, jint aNN,
                         jdouble *rFp, jdouble *rForwardCache, jboolean aFullCache,
                         jint aTypeNum, jdouble aRCut, jint aNMax, jint aLMax, jboolean aNoRadial,
                         jint aL3Max, jboolean aL3Cross, jdouble *aFuseWeight, jint aFuseSize) noexcept {
    if (aL3Cross) {
        switch (aL3Max) {
        case 0: case 1: {
            calFp<0, JNI_FALSE, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, rFp, rForwardCache, aFullCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aFuseWeight, aFuseSize);
            return;
        }
        case 2: {
            calFp<2, JNI_TRUE, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, rFp, rForwardCache, aFullCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aFuseWeight, aFuseSize);
            return;
        }
        case 3: {
            calFp<3, JNI_TRUE, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, rFp, rForwardCache, aFullCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aFuseWeight, aFuseSize);
            return;
        }
        case 4: {
            calFp<4, JNI_TRUE, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, rFp, rForwardCache, aFullCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aFuseWeight, aFuseSize);
            return;
        }
        default: {
            return;
        }}
    } else {
        switch (aL3Max) {
        case 0: case 1: {
            calFp<0, JNI_FALSE, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, rFp, rForwardCache, aFullCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aFuseWeight, aFuseSize);
            return;
        }
        case 2: case 3: {
            calFp<2, JNI_FALSE, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, rFp, rForwardCache, aFullCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aFuseWeight, aFuseSize);
            return;
        }
        case 4: {
            calFp<4, JNI_FALSE, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, rFp, rForwardCache, aFullCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aFuseWeight, aFuseSize);
            return;
        }
        default: {
            return;
        }}
    }
}
static inline void calFp(jdouble *aNlDx, jdouble *aNlDy, jdouble *aNlDz, jint *aNlType, jint aNN,
                         jdouble *rFp, jdouble *rForwardCache, jboolean aFullCache,
                         jint aTypeNum, jdouble aRCut, jint aNMax, jint aLMax, jboolean aNoRadial,
                         jint aL3Max, jboolean aL3Cross, jint aWType, jdouble *aFuseWeight, jint aFuseSize) noexcept {
    switch(aWType) {
    case jsex_nnap_basis_SphericalChebyshev_WTYPE_EXFULL: {
        calFp<jsex_nnap_basis_SphericalChebyshev_WTYPE_EXFULL>(aNlDx, aNlDy, aNlDz, aNlType, aNN, rFp, rForwardCache, aFullCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aL3Max, aL3Cross, aFuseWeight, aFuseSize);
        return;
    }
    case jsex_nnap_basis_SphericalChebyshev_WTYPE_FULL: {
        calFp<jsex_nnap_basis_SphericalChebyshev_WTYPE_FULL>(aNlDx, aNlDy, aNlDz, aNlType, aNN, rFp, rForwardCache, aFullCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aL3Max, aL3Cross, aFuseWeight, aFuseSize);
        return;
    }
    case jsex_nnap_basis_SphericalChebyshev_WTYPE_NONE: {
        calFp<jsex_nnap_basis_SphericalChebyshev_WTYPE_NONE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, rFp, rForwardCache, aFullCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aL3Max, aL3Cross, aFuseWeight, aFuseSize);
        return;
    }
    case jsex_nnap_basis_SphericalChebyshev_WTYPE_DEFAULT: {
        calFp<jsex_nnap_basis_SphericalChebyshev_WTYPE_DEFAULT>(aNlDx, aNlDy, aNlDz, aNlType, aNN, rFp, rForwardCache, aFullCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aL3Max, aL3Cross, aFuseWeight, aFuseSize);
        return;
    }
    case jsex_nnap_basis_SphericalChebyshev_WTYPE_FUSE: {
        calFp<jsex_nnap_basis_SphericalChebyshev_WTYPE_FUSE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, rFp, rForwardCache, aFullCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aL3Max, aL3Cross, aFuseWeight, aFuseSize);
        return;
    }
    default: {
        return;
    }}
}


template <jboolean NO_RADIAL, jint L3MAX, jboolean L3CROSS, jint WTYPE>
static void calBackward(jdouble *aNlDx, jdouble *aNlDy, jdouble *aNlDz, jint *aNlType, jint aNN,
                        jdouble *aGradFp, jdouble *rGradPara, jdouble *aForwardCache, jdouble *rBackwardCache,
                        jint aTypeNum, jdouble aRCut, jint aNMax, jint aLMax, jint aFuseSize) noexcept {
    switch (aLMax) {
    case 0: {
        calBackward<0, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aGradFp, rGradPara, aForwardCache, rBackwardCache, aTypeNum, aRCut, aNMax, aFuseSize);
        return;
    }
    case 1: {
        calBackward<1, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aGradFp, rGradPara, aForwardCache, rBackwardCache, aTypeNum, aRCut, aNMax, aFuseSize);
        return;
    }
    case 2: {
        calBackward<2, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aGradFp, rGradPara, aForwardCache, rBackwardCache, aTypeNum, aRCut, aNMax, aFuseSize);
        return;
    }
    case 3: {
        calBackward<3, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aGradFp, rGradPara, aForwardCache, rBackwardCache, aTypeNum, aRCut, aNMax, aFuseSize);
        return;
    }
    case 4: {
        calBackward<4, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aGradFp, rGradPara, aForwardCache, rBackwardCache, aTypeNum, aRCut, aNMax, aFuseSize);
        return;
    }
    case 5: {
        calBackward<5, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aGradFp, rGradPara, aForwardCache, rBackwardCache, aTypeNum, aRCut, aNMax, aFuseSize);
        return;
    }
    case 6: {
        calBackward<6, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aGradFp, rGradPara, aForwardCache, rBackwardCache, aTypeNum, aRCut, aNMax, aFuseSize);
        return;
    }
    case 7: {
        calBackward<7, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aGradFp, rGradPara, aForwardCache, rBackwardCache, aTypeNum, aRCut, aNMax, aFuseSize);
        return;
    }
    case 8: {
        calBackward<8, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aGradFp, rGradPara, aForwardCache, rBackwardCache, aTypeNum, aRCut, aNMax, aFuseSize);
        return;
    }
    default: {
        return;
    }}
}
template <jint L3MAX, jboolean L3CROSS, jint WTYPE>
static void calBackward(jdouble *aNlDx, jdouble *aNlDy, jdouble *aNlDz, jint *aNlType, jint aNN,
                        jdouble *aGradFp, jdouble *rGradPara, jdouble *aForwardCache, jdouble *rBackwardCache,
                        jint aTypeNum, jdouble aRCut, jint aNMax, jint aLMax, jboolean aNoRadial, jint aFuseSize) noexcept {
    if (aNoRadial) {
        calBackward<JNI_TRUE, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aGradFp, rGradPara, aForwardCache, rBackwardCache, aTypeNum, aRCut, aNMax, aLMax, aFuseSize);
    } else {
        calBackward<JNI_FALSE, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aGradFp, rGradPara, aForwardCache, rBackwardCache, aTypeNum, aRCut, aNMax, aLMax, aFuseSize);
    }
}
template <jint WTYPE>
static void calBackward(jdouble *aNlDx, jdouble *aNlDy, jdouble *aNlDz, jint *aNlType, jint aNN,
                        jdouble *aGradFp, jdouble *rGradPara, jdouble *aForwardCache, jdouble *rBackwardCache,
                        jint aTypeNum, jdouble aRCut, jint aNMax, jint aLMax, jboolean aNoRadial,
                        jint aL3Max, jboolean aL3Cross, jint aFuseSize) noexcept {
    if (aL3Cross) {
        switch (aL3Max) {
        case 0: case 1: {
            calBackward<0, JNI_FALSE, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aGradFp, rGradPara, aForwardCache, rBackwardCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aFuseSize);
            return;
        }
        case 2: {
            calBackward<2, JNI_TRUE, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aGradFp, rGradPara, aForwardCache, rBackwardCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aFuseSize);
            return;
        }
        case 3: {
            calBackward<3, JNI_TRUE, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aGradFp, rGradPara, aForwardCache, rBackwardCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aFuseSize);
            return;
        }
        case 4: {
            calBackward<4, JNI_TRUE, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aGradFp, rGradPara, aForwardCache, rBackwardCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aFuseSize);
            return;
        }
        default: {
            return;
        }}
    } else {
        switch (aL3Max) {
        case 0: case 1: {
            calBackward<0, JNI_FALSE, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aGradFp, rGradPara, aForwardCache, rBackwardCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aFuseSize);
            return;
        }
        case 2: case 3: {
            calBackward<2, JNI_FALSE, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aGradFp, rGradPara, aForwardCache, rBackwardCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aFuseSize);
            return;
        }
        case 4: {
            calBackward<4, JNI_FALSE, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aGradFp, rGradPara, aForwardCache, rBackwardCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aFuseSize);
            return;
        }
        default: {
            return;
        }}
    }
}
static void calBackward(jdouble *aNlDx, jdouble *aNlDy, jdouble *aNlDz, jint *aNlType, jint aNN,
                        jdouble *aGradFp, jdouble *rGradPara, jdouble *aForwardCache, jdouble *rBackwardCache,
                        jint aTypeNum, jdouble aRCut, jint aNMax, jint aLMax, jboolean aNoRadial,
                        jint aL3Max, jboolean aL3Cross, jint aWType, jint aFuseSize) noexcept {
    if (aWType == jsex_nnap_basis_SphericalChebyshev_WTYPE_FUSE) {
        calBackward<jsex_nnap_basis_SphericalChebyshev_WTYPE_FUSE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aGradFp, rGradPara, aForwardCache, rBackwardCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aL3Max, aL3Cross, aFuseSize);
    }
}


template <jboolean NO_RADIAL, jint L3MAX, jboolean L3CROSS, jint WTYPE>
static inline void calForce(jdouble *aNlDx, jdouble *aNlDy, jdouble *aNlDz, jint *aNlType, jint aNN,
                            jdouble *aNNGrad, jdouble *rFx, jdouble *rFy, jdouble *rFz,
                            jdouble *aForwardCache, jdouble *rForwardForceCache, jboolean aFullCache,
                            jint aTypeNum, jdouble aRCut, jint aNMax, jint aLMax, jdouble *aFuseWeight, jint aFuseSize) noexcept {
    switch (aLMax) {
    case 0: {
        calForce<0, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, rFx, rFy, rFz, aForwardCache, rForwardForceCache, aFullCache, aTypeNum, aRCut, aNMax, aFuseWeight, aFuseSize);
        return;
    }
    case 1: {
        calForce<1, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, rFx, rFy, rFz, aForwardCache, rForwardForceCache, aFullCache, aTypeNum, aRCut, aNMax, aFuseWeight, aFuseSize);
        return;
    }
    case 2: {
        calForce<2, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, rFx, rFy, rFz, aForwardCache, rForwardForceCache, aFullCache, aTypeNum, aRCut, aNMax, aFuseWeight, aFuseSize);
        return;
    }
    case 3: {
        calForce<3, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, rFx, rFy, rFz, aForwardCache, rForwardForceCache, aFullCache, aTypeNum, aRCut, aNMax, aFuseWeight, aFuseSize);
        return;
    }
    case 4: {
        calForce<4, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, rFx, rFy, rFz, aForwardCache, rForwardForceCache, aFullCache, aTypeNum, aRCut, aNMax, aFuseWeight, aFuseSize);
        return;
    }
    case 5: {
        calForce<5, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, rFx, rFy, rFz, aForwardCache, rForwardForceCache, aFullCache, aTypeNum, aRCut, aNMax, aFuseWeight, aFuseSize);
        return;
    }
    case 6: {
        calForce<6, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, rFx, rFy, rFz, aForwardCache, rForwardForceCache, aFullCache, aTypeNum, aRCut, aNMax, aFuseWeight, aFuseSize);
        return;
    }
    case 7: {
        calForce<7, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, rFx, rFy, rFz, aForwardCache, rForwardForceCache, aFullCache, aTypeNum, aRCut, aNMax, aFuseWeight, aFuseSize);
        return;
    }
    case 8: {
        calForce<8, NO_RADIAL, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, rFx, rFy, rFz, aForwardCache, rForwardForceCache, aFullCache, aTypeNum, aRCut, aNMax, aFuseWeight, aFuseSize);
        return;
    }
    default: {
        return;
    }}
}
template <jint L3MAX, jboolean L3CROSS, jint WTYPE>
static inline void calForce(jdouble *aNlDx, jdouble *aNlDy, jdouble *aNlDz, jint *aNlType, jint aNN,
                            jdouble *aNNGrad, jdouble *rFx, jdouble *rFy, jdouble *rFz,
                            jdouble *aForwardCache, jdouble *rForwardForceCache, jboolean aFullCache,
                            jint aTypeNum, jdouble aRCut, jint aNMax, jint aLMax, jboolean aNoRadial, jdouble *aFuseWeight, jint aFuseSize) noexcept {
    if (aNoRadial) {
        calForce<JNI_TRUE, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, rFx, rFy, rFz, aForwardCache, rForwardForceCache, aFullCache, aTypeNum, aRCut, aNMax, aLMax, aFuseWeight, aFuseSize);
    } else {
        calForce<JNI_FALSE, L3MAX, L3CROSS, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, rFx, rFy, rFz, aForwardCache, rForwardForceCache, aFullCache, aTypeNum, aRCut, aNMax, aLMax, aFuseWeight, aFuseSize);
    }
}
template <jint WTYPE>
static inline void calForce(jdouble *aNlDx, jdouble *aNlDy, jdouble *aNlDz, jint *aNlType, jint aNN,
                            jdouble *aNNGrad, jdouble *rFx, jdouble *rFy, jdouble *rFz,
                            jdouble *aForwardCache, jdouble *rForwardForceCache, jboolean aFullCache,
                            jint aTypeNum, jdouble aRCut, jint aNMax, jint aLMax, jboolean aNoRadial,
                            jint aL3Max, jboolean aL3Cross, jdouble *aFuseWeight, jint aFuseSize) noexcept {
    if (aL3Cross) {
        switch (aL3Max) {
        case 0: case 1: {
            calForce<0, JNI_FALSE, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, rFx, rFy, rFz, aForwardCache, rForwardForceCache, aFullCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aFuseWeight, aFuseSize);
            return;
        }
        case 2: {
            calForce<2, JNI_TRUE, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, rFx, rFy, rFz, aForwardCache, rForwardForceCache, aFullCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aFuseWeight, aFuseSize);
            return;
        }
        case 3: {
            calForce<3, JNI_TRUE, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, rFx, rFy, rFz, aForwardCache, rForwardForceCache, aFullCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aFuseWeight, aFuseSize);
            return;
        }
        case 4: {
            calForce<4, JNI_TRUE, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, rFx, rFy, rFz, aForwardCache, rForwardForceCache, aFullCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aFuseWeight, aFuseSize);
            return;
        }
        default: {
            return;
        }}
    } else {
        switch (aL3Max) {
        case 0: case 1: {
            calForce<0, JNI_FALSE, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, rFx, rFy, rFz, aForwardCache, rForwardForceCache, aFullCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aFuseWeight, aFuseSize);
            return;
        }
        case 2: case 3: {
            calForce<2, JNI_FALSE, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, rFx, rFy, rFz, aForwardCache, rForwardForceCache, aFullCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aFuseWeight, aFuseSize);
            return;
        }
        case 4: {
            calForce<4, JNI_FALSE, WTYPE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, rFx, rFy, rFz, aForwardCache, rForwardForceCache, aFullCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aFuseWeight, aFuseSize);
            return;
        }
        default: {
            return;
        }}
    }
}
static inline void calForce(jdouble *aNlDx, jdouble *aNlDy, jdouble *aNlDz, jint *aNlType, jint aNN,
                            jdouble *aNNGrad, jdouble *rFx, jdouble *rFy, jdouble *rFz,
                            jdouble *aForwardCache, jdouble *rForwardForceCache, jboolean aFullCache,
                            jint aTypeNum, jdouble aRCut, jint aNMax, jint aLMax, jboolean aNoRadial,
                            jint aL3Max, jboolean aL3Cross, jint aWType, jdouble *aFuseWeight, jint aFuseSize) noexcept {
    switch(aWType) {
    case jsex_nnap_basis_SphericalChebyshev_WTYPE_EXFULL: {
        calForce<jsex_nnap_basis_SphericalChebyshev_WTYPE_EXFULL>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, rFx, rFy, rFz, aForwardCache, rForwardForceCache, aFullCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aL3Max, aL3Cross, aFuseWeight, aFuseSize);
        return;
    }
    case jsex_nnap_basis_SphericalChebyshev_WTYPE_FULL: {
        calForce<jsex_nnap_basis_SphericalChebyshev_WTYPE_FULL>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, rFx, rFy, rFz, aForwardCache, rForwardForceCache, aFullCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aL3Max, aL3Cross, aFuseWeight, aFuseSize);
        return;
    }
    case jsex_nnap_basis_SphericalChebyshev_WTYPE_NONE: {
        calForce<jsex_nnap_basis_SphericalChebyshev_WTYPE_NONE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, rFx, rFy, rFz, aForwardCache, rForwardForceCache, aFullCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aL3Max, aL3Cross, aFuseWeight, aFuseSize);
        return;
    }
    case jsex_nnap_basis_SphericalChebyshev_WTYPE_DEFAULT: {
        calForce<jsex_nnap_basis_SphericalChebyshev_WTYPE_DEFAULT>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, rFx, rFy, rFz, aForwardCache, rForwardForceCache, aFullCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aL3Max, aL3Cross, aFuseWeight, aFuseSize);
        return;
    }
    case jsex_nnap_basis_SphericalChebyshev_WTYPE_FUSE: {
        calForce<jsex_nnap_basis_SphericalChebyshev_WTYPE_FUSE>(aNlDx, aNlDy, aNlDz, aNlType, aNN, aNNGrad, rFx, rFy, rFz, aForwardCache, rForwardForceCache, aFullCache, aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aL3Max, aL3Cross, aFuseWeight, aFuseSize);
        return;
    }
    default: {
        return;
    }}
}


extern "C" {

JNIEXPORT void JNICALL Java_jsex_nnap_basis_SphericalChebyshev_forward1(JNIEnv *aEnv, jclass aClazz,
        jdoubleArray aNlDx, jdoubleArray aNlDy, jdoubleArray aNlDz, jintArray aNlType, jint aNN,
        jdoubleArray rFp, jint aShiftFp, jdoubleArray rForwardCache, jint aForwardCacheShift, jboolean aFullCache,
        jint aTypeNum, jdouble aRCut, jint aNMax, jint aLMax, jboolean aNoRadial, jint aL3Max, jboolean aL3Cross, jint aWType, jdoubleArray aFuseWeight, jint aFuseSize) {
    // java array init
    jdouble *tNlDx = (jdouble *)getJArrayBuf(aEnv, aNlDx);
    jdouble *tNlDy = (jdouble *)getJArrayBuf(aEnv, aNlDy);
    jdouble *tNlDz = (jdouble *)getJArrayBuf(aEnv, aNlDz);
    jint *tNlType = (jint *)getJArrayBuf(aEnv, aNlType);
    jdouble *tFp = (jdouble *)getJArrayBuf(aEnv, rFp);
    jdouble *tForwardCache = (jdouble *)getJArrayBuf(aEnv, rForwardCache);
    jdouble *tFuseWeight = aFuseWeight==NULL ? NULL : (jdouble *)getJArrayBuf(aEnv, aFuseWeight);
    
    calFp(tNlDx, tNlDy, tNlDz, tNlType, aNN, tFp+aShiftFp,
          tForwardCache+aForwardCacheShift, aFullCache,
          aTypeNum, aRCut, aNMax, aLMax, aNoRadial, aL3Max, aL3Cross, aWType, tFuseWeight, aFuseSize);
    
    // release java array
    releaseJArrayBuf(aEnv, aNlDx, tNlDx, JNI_ABORT);
    releaseJArrayBuf(aEnv, aNlDy, tNlDy, JNI_ABORT);
    releaseJArrayBuf(aEnv, aNlDz, tNlDz, JNI_ABORT);
    releaseJArrayBuf(aEnv, aNlType, tNlType, JNI_ABORT);
    releaseJArrayBuf(aEnv, rFp, tFp, 0);
    releaseJArrayBuf(aEnv, rForwardCache, tForwardCache, 0);
    if (aFuseWeight!=NULL) releaseJArrayBuf(aEnv, aFuseWeight, tFuseWeight, JNI_ABORT);
}

JNIEXPORT void JNICALL Java_jsex_nnap_basis_SphericalChebyshev_backward1(JNIEnv *aEnv, jclass aClazz,
        jdoubleArray aNlDx, jdoubleArray aNlDy, jdoubleArray aNlDz, jintArray aNlType, jint aNN,
        jdoubleArray aGradFp, jint aShiftGradFp, jdoubleArray rGradPara, jint aShiftGradPara,
        jdoubleArray aForwardCache, jint aForwardCacheShift, jdoubleArray rBackwardCache, jint aBackwardCacheShift,
        jint aTypeNum, jdouble aRCut, jint aNMax, jint aLMax, jboolean aNoRadial, jint aL3Max, jboolean aL3Cross, jint aWType, jint aFuseSize) {
    // java array init
    jdouble *tNlDx = (jdouble *)getJArrayBuf(aEnv, aNlDx);
    jdouble *tNlDy = (jdouble *)getJArrayBuf(aEnv, aNlDy);
    jdouble *tNlDz = (jdouble *)getJArrayBuf(aEnv, aNlDz);
    jint *tNlType = (jint *)getJArrayBuf(aEnv, aNlType);
    jdouble *tGradFp = (jdouble *)getJArrayBuf(aEnv, aGradFp);
    jdouble *tGradPara = (jdouble *)getJArrayBuf(aEnv, rGradPara);
    jdouble *tForwardCache = (jdouble *)getJArrayBuf(aEnv, aForwardCache);
    jdouble *tBackwardCache = (jdouble *)getJArrayBuf(aEnv, rBackwardCache);
    
    calBackward(tNlDx, tNlDy, tNlDz, tNlType, aNN,
                tGradFp+aShiftGradFp, tGradPara+aShiftGradPara,
                tForwardCache+aForwardCacheShift, tBackwardCache+aBackwardCacheShift,
                aTypeNum, aRCut, aNMax, aLMax, aNoRadial,
                aL3Max, aL3Cross, aWType, aFuseSize);
    
    // release java array
    releaseJArrayBuf(aEnv, aNlDx, tNlDx, JNI_ABORT);
    releaseJArrayBuf(aEnv, aNlDy, tNlDy, JNI_ABORT);
    releaseJArrayBuf(aEnv, aNlDz, tNlDz, JNI_ABORT);
    releaseJArrayBuf(aEnv, aNlType, tNlType, JNI_ABORT);
    releaseJArrayBuf(aEnv, aGradFp, tGradFp, JNI_ABORT);
    releaseJArrayBuf(aEnv, rGradPara, tGradPara, 0);
    releaseJArrayBuf(aEnv, aForwardCache, tForwardCache, JNI_ABORT);
    releaseJArrayBuf(aEnv, rBackwardCache, tBackwardCache, 0);
}

JNIEXPORT void JNICALL Java_jsex_nnap_basis_SphericalChebyshev_forwardForce1(JNIEnv *aEnv, jclass aClazz,
        jdoubleArray aNlDx, jdoubleArray aNlDy, jdoubleArray aNlDz, jintArray aNlType, jint aNN,
        jdoubleArray aNNGrad, jint aShiftFp, jdoubleArray rFx, jdoubleArray rFy, jdoubleArray rFz,
        jdoubleArray aForwardCache, jint aForwardCacheShift, jdoubleArray rForwardForceCache, jint aForwardForceCacheShift, jboolean aFullCache,
        jint aTypeNum, jdouble aRCut, jint aNMax, jint aLMax, jboolean aNoRadial, jint aL3Max, jboolean aL3Cross, jint aWType, jdoubleArray aFuseWeight, jint aFuseSize) {
    // java array init
    jdouble *tNlDx = (jdouble *)getJArrayBuf(aEnv, aNlDx);
    jdouble *tNlDy = (jdouble *)getJArrayBuf(aEnv, aNlDy);
    jdouble *tNlDz = (jdouble *)getJArrayBuf(aEnv, aNlDz);
    jint *tNlType = (jint *)getJArrayBuf(aEnv, aNlType);
    jdouble *tNNGrad = (jdouble *)getJArrayBuf(aEnv, aNNGrad);
    jdouble *tFx = (jdouble *)getJArrayBuf(aEnv, rFx);
    jdouble *tFy = (jdouble *)getJArrayBuf(aEnv, rFy);
    jdouble *tFz = (jdouble *)getJArrayBuf(aEnv, rFz);
    jdouble *tForwardCache = (jdouble *)getJArrayBuf(aEnv, aForwardCache);
    jdouble *tForwardForceCache = (jdouble *)getJArrayBuf(aEnv, rForwardForceCache);
    jdouble *tFuseWeight = aFuseWeight==NULL ? NULL : (jdouble *)getJArrayBuf(aEnv, aFuseWeight);
    
    calForce(tNlDx, tNlDy, tNlDz, tNlType, aNN,
             tNNGrad+aShiftFp, tFx, tFy, tFz,
             tForwardCache+aForwardCacheShift, tForwardForceCache+aForwardForceCacheShift, aFullCache,
             aTypeNum, aRCut, aNMax, aLMax, aNoRadial,
             aL3Max, aL3Cross, aWType, tFuseWeight, aFuseSize);
    
    // release java array
    releaseJArrayBuf(aEnv, aNlDx, tNlDx, JNI_ABORT);
    releaseJArrayBuf(aEnv, aNlDy, tNlDy, JNI_ABORT);
    releaseJArrayBuf(aEnv, aNlDz, tNlDz, JNI_ABORT);
    releaseJArrayBuf(aEnv, aNlType, tNlType, JNI_ABORT);
    releaseJArrayBuf(aEnv, aNNGrad, tNNGrad, JNI_ABORT);
    releaseJArrayBuf(aEnv, rFx, tFx, 0);
    releaseJArrayBuf(aEnv, rFy, tFy, 0);
    releaseJArrayBuf(aEnv, rFz, tFz, 0);
    releaseJArrayBuf(aEnv, aForwardCache, tForwardCache, JNI_ABORT);
    releaseJArrayBuf(aEnv, rForwardForceCache, tForwardForceCache, 0);
    if (aFuseWeight!=NULL) releaseJArrayBuf(aEnv, aFuseWeight, tFuseWeight, JNI_ABORT);
}

}
